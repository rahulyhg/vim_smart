<!DOCTYPE html>
<!-- 
Template Name: Metronic - Responsive Admin Dashboard Template build with Twitter Bootstrap 3.3.7
Version: 4.7.1
Author: KeenThemes
Website: http://www.keenthemes.com/
Contact: support@keenthemes.com
Follow: www.twitter.com/keenthemes
Dribbble: www.dribbble.com/keenthemes
Like: www.facebook.com/keenthemes
Purchase: http://themeforest.net/item/metronic-responsive-admin-dashboard-template/4021469?ref=keenthemes
Renew Support: http://themeforest.net/item/metronic-responsive-admin-dashboard-template/4021469?ref=keenthemes
License: You must have a valid license purchased only from themeforest(the above link) in order to legally use the theme for your project.
-->
<!--[if IE 8]> <html lang="en" class="ie8 no-js"> <![endif]-->
<!--[if IE 9]> <html lang="en" class="ie9 no-js"> <![endif]-->
<!--[if !IE]><!-->
<html lang="en">
    <!--<![endif]-->
    <!-- BEGIN HEAD -->

    <head>
        <meta charset="utf-8" />
        <title>车辆解绑</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes"> 
        <meta content="Preview page of Metronic Admin Theme #4 for bootstrap inputs, input groups, custom checkboxes and radio controls and more" name="description" />
        <meta content="" name="author" />
        <!-- BEGIN GLOBAL MANDATORY STYLES -->
        <link href="{$Think.config.STATICS_URL}plublic/css/googleapis.css" rel="stylesheet" type="text/css" />
        <link href="{$Think.config.STATICS_URL}plublic/css/font-awesome/font-awesome.min.css" rel="stylesheet" type="text/css" />
        <link href="{$Think.config.STATICS_URL}plublic/css/simple-line-icons/simple-line-icons.min.css" rel="stylesheet" type="text/css" />
        <link href="{$Think.config.STATICS_URL}plublic/css/bootstrap/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="{$Think.config.STATICS_URL}plublic/css/bootstrap/bootstrap-switch.min.css" rel="stylesheet" type="text/css" />
        <!-- END GLOBAL MANDATORY STYLES -->
		<link href="{$Think.config.STATICS_URL}plublic/css/sweetalert.css" rel="stylesheet" type="text/css" />
        <!-- BEGIN THEME GLOBAL STYLES -->
        <link href="{$Think.config.STATICS_URL}plublic/css/components.min.css" rel="stylesheet" id="style_components" type="text/css" />
        <link href="{$Think.config.STATICS_URL}plublic/css/plugins.min.css" rel="stylesheet" type="text/css" />
        <!-- END THEME GLOBAL STYLES -->
        <!-- BEGIN THEME LAYOUT STYLES -->
        <link href="{$Think.config.STATICS_URL}plublic/css/layout/layout.min.css" rel="stylesheet" type="text/css" />
        <link href="{$Think.config.STATICS_URL}plublic/css/layout/default.min.css" rel="stylesheet" type="text/css" id="style_color" />
        <link href="{$Think.config.STATICS_URL}plublic/css/layout/custom.min.css" rel="stylesheet" type="text/css" />
		<link href="{$Think.config.STATICS_URL}plublic/css/style.css" rel="stylesheet" type="text/css" />
        <link href="{$Think.config.STATICS_URL}plublic/css/weui.min.css" rel="stylesheet" type="text/css" />
        <!-- END THEME LAYOUT STYLES -->
        <style type="text/css">
<!--
.fez.active, .fez:active:focus, .fez:active:hover, .fez:focus, .fez:hover {border-color: #278ff0;
    color: #ffffff;
    background-color: #278ff0;}
.mt20 {margin-top:20px;}
.zi {width:48px; height:48px; border:1px #eaeaea solid; text-align:center; color:#848484; font-size:16px; line-height:48px; float:left; margin:5px; background-color:#FFFFFF;}
.zi:link {background-color:#389ffd; color:#FFFFFF; border:1px #389ffd solid; text-align:center;}
.zi:visited {background-color:#389ffd; color:#FFFFFF; border:1px #389ffd solid; text-align:center;}
.zi:hover {background-color:#389ffd; color:#FFFFFF; border:1px #389ffd solid; text-align:center;}
.zi:active  {background-color:#389ffd; color:#FFFFFF; border:1px #389ffd solid; text-align:center;}
.kid {padding: 14px 10px 5px!important;}
.col-md-6 {width:100%;}
.portlet {
    margin-top: 0;
    margin-bottom: 5px;
    padding: 0;
    border-radius: 4px;
}
@media (min-width:414px) and (max-width:500px) {
.dropdown-menu {
    min-width: 558%;
    padding: 5px 0 8px 8px;
}
}
@media (min-width:375px) and (max-width:411px) {
.dropdown-menu {
    min-width: 500%;
    padding: 5px 0 8px 16px;
}
}
@media (min-width:320px) and (max-width:359px) {
.dropdown-menu {
    min-width: 412%;
    padding: 5px 0 8px 13px;
}
}
@media (min-width:360px) and (max-width:374px) {
.dropdown-menu {
    min-width: 480%;
    padding: 5px 0 8px 10px;
}
}
@media (width:412px) {
.dropdown-menu {
    min-width: 580%;
    padding: 5px 0 8px 10px;
}
}
@media (width:768px) {
.dropdown-menu {
    min-width: 1110%;
    padding: 5px 0 8px 30px;
}
}
.input-group-addon, .input-group-btn {
    width: 1%;
    vertical-align: top;
}
.btn.btn-outline.blue {
    border-color: #ededed;
    color: #389ffe;
    background: 0 0;
    padding: 12px 0;
	background-color:#f6f6f6;
}
.btn-circle {
    border-radius: 4px!important;
    overflow: hidden;
}
.btn.btn-outline.blue.active, .btn.btn-outline.blue:active, .btn.btn-outline.blue:active:focus, .btn.btn-outline.blue:active:hover, .btn.btn-outline.blue:focus, .btn.btn-outline.blue:hover {
    border-color: #389ffe;
    color: #ffffff;
    background-color: #389ffe;
}
-->
</style></head>
<script>
  document.addEventListener('touchstart',function(){},false);
</script>
    <!-- END HEAD -->

    <body>
        <!-- BEGIN HEADER -->
        <!-- END HEADER -->
        <!-- BEGIN HEADER & CONTENT DIVIDER -->
        <div class="clearfix"> </div>
        <!-- END HEADER & CONTENT DIVIDER -->
        <!-- BEGIN CONTAINER -->
        <div class="page-container">
            <!-- BEGIN SIDEBAR -->
            <!-- END SIDEBAR -->
            <!-- BEGIN CONTENT -->
            <div class="page-content-wrapper">
                <!-- BEGIN CONTENT BODY -->
                <div style="padding: 20px 10px 10px!important;">
					<div style="margin:5px 20px 0px 15px; padding-left:30px; font-size:18px; color:#242424; background:url({$Think.config.STATICS_URL}car_bind/images/car.png) no-repeat left; background-size:24px;">车辆解绑</div>
                    <div class="kid"><div class="row">
                        <div class="col-md-6 ">
                            <!-- BEGIN SAMPLE FORM PORTLET-->
                            <div class="portlet light bordered">
							<div class="portlet-title" id="old_car">
								<div style="height:44px;background-color: #f6f6f6;border-radius:4px; text-align:center; line-height:44px; color:#389ffe; border: 1px #ededed solid; font-family:'微软雅黑'; font-weight:500; font-size:16px; margin-top:10px;">
                                                                    <notempty name="result_msg">
                                                                    {$result_msg}
                                                                    <else />
                                                                        欢迎使用本服务
                                                                    </notempty>
                                                                </div>
                                                                
                                                                <!--显示(模糊查询)(用户输入车牌号)的结果-->
                                                                <notempty name="result_datas">
                                                                        <div style="height:44px;background-color: #f6f6f6;border: 1px #ededed solid; border-radius:4px; text-align:center; line-height:44px; color:#389ffe; font-family:'微软雅黑'; font-size:16px; margin-top:10px;" onClick="get_this_val_new(this)">{$result_datas}</div>

                                                                </notempty>
                                                            
                                                                <!--旧用户显示已经绑定的车辆-->
                                                                <notempty name="car_infos">
                                                                    <foreach name="car_infos" item="v">
                                                                        <div class="binded_carno" style="margin-top:12px;"><button class="btn btn-circle blue btn-block btn-outline " onClick="get_this_val(this)">{$v.car_no}</button></div>
                                                                    </foreach>
                                                                </notempty>
							</div>
                        </div>
                    </div>
					<div class="ki"><span style="font-family:AriaL;">Power by:</span>汇得行控股（中国）有限公司</div>
                    <!-- END PAGE BASE CONTENT -->
              </div></div>
                <!-- END CONTENT BODY -->
            </div>
            <!-- END CONTENT -->
            <!-- BEGIN QUICK SIDEBAR -->
            <!-- END QUICK SIDEBAR -->
        </div>
		</div>
        <!--加载提示框开始-->
        <div id="loadingToast" style="display:none;">
            <div class="weui-mask_transparent"></div>
            <div class="weui-toast">
                <i class="weui-loading weui-icon_toast"></i>
                <p class="weui-toast__content">数据加载中</p>
            </div>
        </div>
        <script>
            var load = document.getElementById("loadingToast");
            load.style.display="block";
            window.onload=function(){

                load.style.display ="none";
            }
        </script>
        <!--加载提示框结束-->
        <!-- END QUICK NAV -->
        <!--[if lt IE 9]>
<script src="../assets/global/plugins/respond.min.js"></script>
<script src="../assets/global/plugins/excanvas.min.js"></script> 
<script src="../assets/global/plugins/ie8.fix.min.js"></script> 
<![endif]-->
        <!-- BEGIN CORE PLUGINS -->
        <script src="{$Think.config.STATICS_URL}plublic/js/jquery/jquery.min.js" type="text/javascript"></script>
        <script src="{$Think.config.STATICS_URL}plublic/js/bootstrap/bootstrap.min.js" type="text/javascript"></script>
		<script src="{$Think.config.STATICS_URL}plublic/js/sweetalert.min.js" type="text/javascript"></script>
		<script src="{$Think.config.STATICS_URL}plublic/js/ui-sweetalert.min.js" type="text/javascript"></script>
        <!--插入layer弹层js开始-->
        <script src="{$Think.config.HOME_JS_URL}layer.js" type="text/javascript"></script>
        <!--插入layer弹层js结束-->
        <script type="text/javascript">
            $(function(){
                $("#dropdown-menu2").children().click(function(){
                    $('#car_no_along').html($(this).html());
                    $('#car_A').css('display','block');
                });
                $('#car_A').children().click(function(){
                    $('#car_no_A').html($(this).html());
                    $('#car_A').css('display','none');
                    $("input[name='car_no_pre']").val($('#car_no_along').html()+"-"+$('#car_no_A').html());
                });
                var $loadingToast = $('#loadingToast');
                $('#showLoadingToast').on('click', function(){
                    if ($loadingToast.css('display') != 'none') return;

                    $loadingToast.fadeIn(100);
                    setTimeout(function () {
                        $loadingToast.fadeOut(100);
                    }, 2000);
                });



                
            });



            //当点击“新增”按钮时，将车牌前缀和输入的内容拼接起来
            $('form').submit(function(evt){
                var car_no_length=($("input[name='c_no']").val()).length;
                //当车牌输入不合法时，阻止提交
                if(car_no_length!=5){
                    swal({
                        title: "输入格式不合法",
                        text: "请输入5位英文或者数字",
                        type: "info",
                        showCancelButton: true,
                        closeOnConfirm: false,
                        confirmButtonText: "好的",
                        confirmButtonColor: "#ec6c62",
                        cancelButtonText:"取消"
                    }, function() {
                        //跳转到首页
                        //window.location.reload();
                    });
                    evt.preventDefault();
                }
            });
            
            function get_this_val(obj){
                var car_no=$(obj).html();
                //$("input[name='c_no']").val($(obj).html());
                //$('#car_no_pre_div').remove();
                var $loadingToast = $('#loadingToast');
                $("#old_car").on('click',obj,function(){
                    if ($loadingToast.css('display') != 'none') return;

                    $loadingToast.fadeIn(100);
                    setTimeout(function () {
                        $loadingToast.fadeOut(100);
                    }, 60000);
                });
                //判断是否能精确匹配，如果不能精确匹配
                $.ajax({
                    url:"{:U('ajax_is_go_order_detail')}",
                    data:{'car_no2':car_no},
                    dataType:'json',
                    type:'post',
                    success:function(msg){
                        if(msg!='2'){
                            //精确匹配，直接提交，跳转到详情页
                            //window.location.href("{:U('Payrecord/order_detail?')}"+"pay_id="+card);

                            //submit之前进行数据制作
                            //alert(car_no.substring(0,3));
                            //alert(car_no.substring(3));
                            $("input[name='car_no_pre']").val(car_no.substring(0,3));
                            $("input[name='c_no']").val(car_no.substring(3));

                            $('form').submit();
                        }else{
                            //车辆不在停车场内
                            //①：判断此车辆是否已经绑定，如果没有绑定先进行绑定操作
                            check_card_is_binding($(obj).html());
                        }
                    }
                });
            }

            //判断当前车牌是否已经被当前用户绑定过！
            function check_card_is_binding(car_no){
                var $loadingToast = $('#loadingToast');
                $.ajax({
                    url:"{:U('check_card_is_binding')}",
                    data:{'car_no4':car_no},
                    dataType:'json',
                    type:'post',
                    success:function(msg){
                        if(msg==2){
                            //未绑定
                            $loadingToast.fadeOut(100);
                            binding_car(car_no);
                        }else if(msg==1){
                            //已经绑定
                            $loadingToast.fadeOut(100);
                            swal({
                                title: "车辆"+car_no+"不在停车场内!",
                                text: "请确保该车辆已进入场内。",
                                type: "info",
                                showCancelButton: true,
                                closeOnConfirm: false,
                                confirmButtonText: "好的",
                                confirmButtonColor: "#ec6c62",
                                cancelButtonText:"取消"
                            }, function() {
                                //跳转到首页
                                window.location.reload();
                            });
                        }
                    }
                });
            }

            //ajax绑定车辆
            function binding_car(car_no){
                $.ajax({
                    url:"{:U('ajax_binding_car')}",
                    data:{'car_no3':car_no},
                    dataType:'json',
                    type:'post',
                    success:function(msg){
                        if(msg=='1'){
                            $('#loadingToast').fadeOut(100);
                            swal({
                                title: "恭喜您，车辆"+car_no+"绑定成功!",
                                text: "提示:请在车辆出场前提前进行缴费。",
                                type: "success",
                                showCancelButton: true,
                                closeOnConfirm: false,
                                confirmButtonText: "完成",
                                confirmButtonColor: "#ec6c62",
                                cancelButtonText:"取消"
                            }, function() {
                                //跳转到首页
                                window.location.reload();
                            });
                        }else if(msg=='2'){
                            //alert('车库无此车辆');

                            swal({
                                title: "很抱歉！："+car_no,
                                text: "车辆绑定失败！请点继续重试！",
                                type: "info",
                                showCancelButton: true,
                                closeOnConfirm: false,
                                confirmButtonText: "重试",
                                confirmButtonColor: "#ec6c62",
                                cancelButtonText:"取消"
                            }, function() {
                                //不作任何操作
                                window.location.reload();
                            });
                        }
                    }
                });
            }

            
            function submit_this_car(obj){
              
                    layer.msg('确定车牌：'+$(obj).html()+'？', {
                        time: 0 //不自动关闭
                        ,btn: ['确定', '取消']
                        ,yes: function(index){
                            layer.close(index);
                            $("input[name='c_no']").val($(obj).html());
                            //$('#car_no_pre_div').remove();
                            $('form').submit(function(){
                                $('#car_no_pre_div').remove();
                            });
                        }
                    });
            }


            function get_this_val_new(obj){

                //$("input[name='c_no']").val($(obj).html());
                var card=$(obj).html();
                //$('#car_no_pre_div').remove();
                swal({
                    title: "绑定车牌："+card,
                    text: "请确认车牌是否正确，确认请点击继续。",
                    type: "info",
                    showCancelButton: true,
                    closeOnConfirm: false,
                    confirmButtonText: "继续",
                    confirmButtonColor: "#ec6c62",
                    cancelButtonText:"取消"
                }, function() {
                    $('#loadingToast').fadeIn(100);
                    //$('form').prop('action',":U('user_affirm')");
                    //$('form').submit();
                    //通过ajax请求数据
                    get_this_val(obj);
                    /*
                    $.ajax({
                        url:"{:U('ajax_binding_car')}",
                        data:{'car_no3':card},
                        dataType:'json',
                        type:'post',
                        success:function(msg){
                            if(msg=='1'){
                                swal({
                                    title: "恭喜您啦！："+card,
                                    text: "绑定成功！",
                                    type: "info",
                                    showCancelButton: true,
                                    closeOnConfirm: false,
                                    confirmButtonText: "继续",
                                    confirmButtonColor: "#ec6c62",
                                    cancelButtonText:"取消"
                                }, function() {
                                    //跳转到首页
                                    window.location.reload();
                                });
                            }else if(msg=='2'){
                                //alert('车库无此车辆');
                                swal({
                                    title: "很抱歉！："+card,
                                    text: "车辆绑定失败！请点继续重试！",
                                    type: "info",
                                    showCancelButton: true,
                                    closeOnConfirm: false,
                                    confirmButtonText: "继续",
                                    confirmButtonColor: "#ec6c62",
                                    cancelButtonText:"取消"
                                }, function() {
                                    //不作任何操作
                                    window.location.reload();
                                });
                            }
                        }
                    });
                    */
                });

                //$('form').submit();
            }

            function is_in_garage(card){
                //通过ajax判断车辆是否在场内
                $.ajax({
                    url:"{:U('ajax_is_go_order_detail')}",
                    data:{'car_no2':card},
                    dataType:'json',
                    type:'post',
                    success:function(msg){
                        if(msg!='2'){
                            //window.location.href("{:U('Payrecord/order_detail?')}"+"pay_id="+card);
                            $("input[name='car_no_pre']").val(card.substring(0,3));
                            $("input[name='c_no']").val(card.substring(3));
                            $('form').submit();
                        }else{
                            swal({
                                title: "很抱歉！："+card,
                                text: "此车辆不在停车场内，请点击继续重新搜索！",
                                type: "info",
                                showCancelButton: true,
                                closeOnConfirm: false,
                                confirmButtonText: "继续",
                                confirmButtonColor: "#ec6c62",
                                cancelButtonText:"取消"
                            }, function() {
                                //不作任何操作
                                window.location.reload();
                            });
                        }
                    }
                });
            }

            /*
            //ajax判断当车牌输入到5位，且当前用户未绑定此车牌，并且该车辆在停车场内
            $(function(){
                $("input[name='c_no']").keyup(function(){
                    var c_no_val=$("input[name='c_no']").val();
                    //防止bug
                    var val_length=c_no_val.length;

                    //if(val_length==7){
                    //    $("input[name='c_no']").val(c_no_val.substring(3));
                    //}


                    if(val_length==5){

                        var car_no=$("input[name='car_no_pre']").val()+c_no_val;

                        //车牌前缀和车牌后5位进行拼接
                        //$("input[name='c_no']").val($("input[name='car_no_pre']").val()+c_no_val);

                        //将所有英文小写字符进行大写化
                        var car_strs=c_no_val;
                        $("input[name='c_no']").val(car_strs.toUpperCase());
                        car_no=car_no.toUpperCase();

                        //alert(car_no);
                        $.ajax({
                            url:"{:U('api_check_car_is_in')}",
                            data:{'car_no6':car_no},
                            dataType:'json',
                            type:'post',
                            success:function(msg){
                                if(msg=='1'){
                                    swal({
                                        title: "绑定车牌："+car_no,
                                        text: "请确认车牌是否正确，确认请点击继续。",
                                        type: "info",
                                        showCancelButton: true,
                                        closeOnConfirm: false,
                                        confirmButtonText: "继续",
                                        confirmButtonColor: "#ec6c62",
                                        cancelButtonText:"取消"
                                    }, function() {
                                        $('form').submit();
                                    });
                                }
                            }
                        });
                    }
                });
            });

            */

            //选中所有的已绑车牌的div
            //当用户向左滑动车牌时，显示解绑
            /*
            $(function(){
                $(".binded_carno").each(function(k,v){
                    $(v).on('swipeleft',function(){
                        alert('您进行了向左滑动');
                    });
                });
            });
            */



            //单独解决用户中文状态下输入英文字符无keyup状况处理
            $("input[name='c_no']").blur(function(){
                var c_no_val=$("input[name='c_no']").val();
                var car_strs=c_no_val;
                $("input[name='c_no']").val(car_strs.toUpperCase());
                car_no=car_no.toUpperCase();
            });

        </script>
    </body>

</html>