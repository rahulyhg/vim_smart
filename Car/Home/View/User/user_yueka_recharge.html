<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>智慧停车场系统</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <meta content="Preview page of Metronic Admin Theme #4 for bootstrap inputs, input groups, custom checkboxes and radio controls and more" name="description" />
    <meta content="" name="author" />
    <link href="{$Think.config.STATICS_URL}plublic/css/weui.css" rel="stylesheet" type="text/css" />
    <link href="{$Think.config.STATICS_URL}plublic/css/example.css" rel="stylesheet" type="text/css" />
    <link href="{$Think.config.STATICS_URL}plublic/css/font-awesome/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="{$Think.config.STATICS_URL}plublic/css/bootstrap/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="{$Think.config.STATICS_URL}plublic/css/components.min.css" rel="stylesheet" id="style_components" type="text/css" />
    <link href="{$Think.config.STATICS_URL}plublic/css/sweetalert.css" rel="stylesheet" type="text/css" />
    <!--jq验证框架开始-->
    <link rel="stylesheet" href="{$Think.config.STATICS_URL}plublic/css/JQueryEV/validationEngine.jquery.css">
    <script src="{$Think.config.STATICS_URL}plublic/js/jquery/jquery.js"></script>
    <script src="{$Think.config.STATICS_URL}plublic/js/JQueryEV/jquery.validationEngine-zh_CN.js"></script>
    <script src="{$Think.config.STATICS_URL}plublic/js/JQueryEV/jquery.validationEngine.js"></script>
    <script src="{$Think.config.STATICS_URL}plublic/js/JQueryEV/jquery.validationEngine.min.js"></script>
    <!-- jquery.validationEngine-zh_CN.js 为配置文件，可根据需求自行调整或增加，也可以更换为其他语言配置文件 -->
    <!--jq验证框架结束-->
    <script src="{$Think.config.STATICS_URL}plublic/js/zepto.min.js"></script>
    <script src="{$Think.config.STATICS_URL}plublic/js/router.min.js"></script>
    <script src="{$Think.config.STATICS_URL}plublic/js/example.js"></script>
    <style type="text/css">
        <!--
        .we {width:30%; border-radius:8px; border:1px #389ffe solid; float:left; margin-bottom:10px; color:#389ffe; text-align:center; padding-top:10px; padding-bottom:10px;}
        .we:hover {background-color:#389ffe; color:#FFFFFF;}

        .we2 {width:30%; border-radius:8px; border:1px #389ffe solid; float:left; margin-left:2%; margin-bottom:10px; color:#389ffe; text-align:center; padding-top:10px; padding-bottom:10px;}
        .we2:hover {background-color:#389ffe; color:#FFFFFF;}

        .weui_btn_primary {
            background-color: #389ffe;
        }
        .weui_btn_primary:not(.weui_btn_disabled):active {
            color: #ffffff;
            background-color: #2e8ce2;
        }
        -->
    </style></head>
<script>
    document.addEventListener('touchstart',function(){},false);
</script>
<body>
<form action="" method="post" id="my_form">
    <input name="user_id" type="hidden" value="{$uid}">
<div style="width:100%; height:50px; text-align:center; line-height:50px; background-color:#389ffe; color:#FFFFFF; font-size:18px;">月卡车辆延期</div>
<div class="bd">
    <div class="weui_cells_title" style="margin-top:20px;">开卡信息</div>
    <div class="weui_cells weui_cells_form">
        <div class="weui_cell weui_cell_select weui_select_after">
            <div class="weui_cell_hd">
                <label for="" class="weui_label">月卡车辆</label>
            </div>
            <div class="weui_cell_bd weui_cell_primary">
                <select class="weui_select" name="car_no" id="car_no">
                    <empty 	name="user_car_array">
                        <option value="0">您没有月卡车辆</option>
                    </empty>
                    <foreach name="user_car_array" item="v">
                        <option value="{$v.car_no}">{$v.car_no}</option>
                    </foreach>
                </select>
            </div>
        </div>
        <div class="weui_cell">
            <div class="weui_cell_hd"><label for="" class="weui_label">原到期时间</label></div>
            <div class="weui_cell_bd weui_cell_primary">
                <input class="weui_input" value="" id="start_time" name="start_time" readonly = "readonly"/>
               <!-- <span class="weui_input" id="start_time"/></span>-->
            </div>
        </div>
        <div class="weui_cell">
            <div class="weui_cell_hd"><label for="" class="weui_label">延长时间至</label></div>
            <div class="weui_cell_bd weui_cell_primary">
                <input class="weui_input validate[future[now]]" type="date" value="" id="end_time" name="end_time"/>
            </div>
        </div>
        <div class="weui_cell">
            <div class="weui_cell_hd"><label class="weui_label">手机号</label></div>
            <div class="weui_cell_bd weui_cell_primary">
                <input class="weui_input" type="tel" pattern="[0-9]*" placeholder="请输入手机号" id="user_phone" name="user_phone" value="{$user_car_array.user_phone}"/>
            </div>
        </div>
        <div class="weui_cell weui_cell_select weui_select_after">
            <div style="height:50px; text-align:right; line-height:50px; padding-right:15px; width:100%;"><span style="color:#9b9b9b;">支付金额：</span><span style="color:#fb4746; font-family:Arial; font-size:30px;" id="how_much_money">0</span><span style="color:#9b9b9b;">元</span></div>
        </div>
    </div>

    <div class="weui_btn_area">
        <div class="weui_btn weui_btn_primary" id="pay_now_money">支 付</div>
    </div>
    <div style="padding-left:15px; padding-right:15px; padding-top:5px; padding-bottom:20px; color:#7f7f7f; line-height:1.5; font-size:12px;">提交申请后，工作人员会在1-2个工作日内处理，处理成功后会电话或微信通知您</div>
</div>
</form>
<script src="{$Think.config.STATICS_URL}plublic/js/jquery/jquery-1.8.2.min.js" type="text/javascript"></script>
<script src="{$Think.config.STATICS_URL}plublic/js/sweetalert.min.js" type="text/javascript"></script>
<script src="{$Think.config.STATICS_URL}plublic/js/ui-sweetalert.min.js" type="text/javascript"></script>
<script>
    //JQev调用
    $(function(){
        //$('#my_form').validationEngine();
        var car_no = $('#car_no option:selected').val();
        //alert(car_no);
        $.ajax({
            url:"{:U('User/get_car_time')}",
            data:{'car_no':car_no},
            type:'post',
            success:function(res){
                $("#start_time").val(res);
            }
        });
    });
    $("#car_no").change(function(){
        var car_no = $('#car_no option:selected').val();
        //alert(car_no);
        $.ajax({
            url:"{:U('User/get_car_time')}",
            data:{'car_no':car_no},
            type:'post',
            success:function(res){
                $("#start_time").val(res);
            }
        });

    });
    var flag = false;
    var flag1 = false;
    $("#end_time").blur(function(){
        var start_time = $("#start_time").val();
        var end_time = $("#end_time").val();
        if(end_time == ''){
            swal({
                title: "截止时间不能为空！",
                text: "请选择您的截止时间",
                type: "warning",
                confirmButtonText: "确定",
                closeOnConfirm: false
            });
            $("#pay_now_money").attr("disabled",true);
        }else{
            $.ajax({
                url:"{:U('User/count_day')}",
                data:{'start_time':start_time,'end_time':end_time},
                dataType:'json',
                type:'post',
                success:function(res){
                    if(res>0){
                        $("#how_much_money").html(0.01);
                    }else{
                        $("#how_much_money").html(0);
                    }
                }
            });
            flag=true;
        }
    });

    $("#user_phone").blur(function(){
        var user_phone = $("#user_phone").val();
        var reg =/^(((13[0-9]{1})|(14[0-9]{1})|(17[0]{1})|(15[0-3]{1})|(15[5-9]{1})|(18[0-9]{1}))+\d{8})$/;
        if(user_phone == ''){
            swal({
                title: "电话号码不能为空",
                text: "请您填写真实有效的电话号码",
                type: "warning",
                confirmButtonText: "确定",
                closeOnConfirm: false
            });
            $("#button_pay_now").attr("disabled",true);

        }else if(user_phone.length !=11){
            swal({
                title: "电话号码格式错误！",
                text: "请您填写真实有效的电话号码",
                type: "warning",
                confirmButtonText: "确定",
                closeOnConfirm: false
            });
            $("#button_pay_now").attr("disabled",true);

        }else if(!reg.test(user_phone)) {
            swal({
                title: "电话号码格式错误！",
                text: "请您填写真实有效的电话号码",
                type: "warning",
                confirmButtonText: "确定",
                closeOnConfirm: false
            });
            $("#button_pay_now").attr("disabled",true);

        }else{
            flag1 = true;
        }
    });

    $("#pay_now_money").click(function(){
        if(flag && flag1){
            //支付订单
            //分装所有的支付所须信息
           var order_no = make_order_no();
            var car_no = $('#car_no option:selected').val();
            var total_fee = $("#how_much_money").text();
            var end_time = $("#end_time").val();
            var user_id = "{$uid}";
            $.ajax({
                url:"{:U('User/yueka_old_pay')}",
                data:{'order_no':order_no,'car_no':car_no,'total_fee':total_fee,'user_id':user_id,'end_time':end_time},
                dataType:'json',
                type:'post',
                success:function(msg){
                    if(msg.wx_pay=='1'){
                        //将json字串转为json对象
                        //alert(msg);
                        var msg_json=JSON.parse(msg.vals);
                        //alert(msg_json.appId);
                        //调用微信内部支付js

                        if (typeof WeixinJSBridge == "undefined"){
                            if( document.addEventListener ){
                                document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
                            }else if (document.attachEvent){
                                document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
                                document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
                            }
                        }else{
                            onBridgeReady(msg_json);
                        }
                    }else if(msg=='1'){
                        swal("支付失败，错误编码0008，请记住编码然后联系管理员！", "电话：027-87779655", "error");
                        //alert('支付失败，请联系管理员！');
                    }else if(msg=='2'){
                        swal("支付失败，错误编码0001，请记住编码然后联系管理员！", "电话：027-87779655", "error");
                    }
                }
            });

        }else{
            swal({
                title: "您的信息有误！",
                text: "请您检查您的信息再次支付",
                type: "warning",
                confirmButtonText: "确定",
                closeOnConfirm: false
            });
        }
    });

    /*
     * 创建JSAPI订单号
     * 月卡延期订单
     * */
    function make_order_no(){
        var timestamp=new Date().getTime();
        //JSAPI订单号生成规则 支付标识位8 当前精确到毫秒的时间戳13+用户uid 4 18位数
        var order_no ="8"+timestamp+"{$order_uid}";
        return order_no;
    }

    function onBridgeReady(msg_json){
        WeixinJSBridge.invoke(
                'getBrandWCPayRequest', {
                    "appId":msg_json.appId,     //公众号名称，由商户传入
                    "timeStamp":msg_json.timeStamp,         //时间戳，自1970年以来的秒数
                    "nonceStr":msg_json.nonceStr, //随机串
                    "package":msg_json.package,
                    "signType":msg_json.signType,         //微信签名方式：
                    "paySign":msg_json.paySign //微信签名
                },
                function(res){
                    // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。
                    if(res.err_msg == "get_brand_wcpay_request:ok" ) {
                        //检测微信支付状态
                        var my_data = $("#my_form").serialize();
                        when_pay_is_ok(my_data);
                    }else{

                    }
                }
        );
    }

    /*
     * 支付完毕，录入表单
     * */
    function when_pay_is_ok(data){
        $.ajax({
            url:"{:U('do_renew_car')}",
            data:data,
            type:'post',
            success:function(res){
                if(res == '1'){
                    //推送成功，展示给用户看成功页面，并跳回个人中心
                    swal({
                                title: "续费信息已提交！",
                                text: "请留意您微信上的流程通知！",
                                type: "success",
                                confirmButtonText: "确定",
                                closeOnConfirm: false
                            },
                            function(){
                                //window.location.reload();
                                window.location.href ='__APP__?m=Home&c=User&a=user_index';
                            }
                    );
                }else{
                    swal({
                                title: "抱歉！出了些小问题。错误编码："+res,
                                text: "请及时联系管理员：027-87779655",
                                type: "error",
                                confirmButtonText: "确定",
                                closeOnConfirm: false
                            },
                            function(){
                                window.location.href ='__APP__?m=Home&c=User&a=user_index';
                            }
                    );
                }
            }
        });
    }


</script>

</body>
</html>
