<?phpclass House_village_user_bindModel extends Model{	/*通过手机号自动绑定业主*/	public function bind($uid,$phone){		$this->data(array('uid'=>$uid))->where(array('phone'=>$phone))->save();	}		public function get_user_bind_list($uid,$village_id){		$bind_list = $this->field(true)->where(array('uid'=>$uid,'village_id'=>$village_id,'role'=>array('elt',1),'ac_status'=>array('in','2,4')))->order('`pigcms_id` DESC')->select();		return $bind_list;	}    public function get_user_bind_list_uptown($uid,$village_id){        $bind_list = $this->field(true)->where(array('uid'=>$uid,'village_id'=>$village_id,'ac_status'=>array('in','2,4')))->order('`pigcms_id` DESC')->select();        return $bind_list;    }	/*得到小区下所有的业主列表*/	public function get_limit_list_page($village_id,$pageSize=20){		if(!$village_id){			return null;		}			$return = array();		$condition_where['village_id'] = $village_id;		$count_user = D('House_village_user_bind')->where($condition_where)->count();				import('@.ORG.merchant_page');		$p = new Page($count_user,$pageSize,'page');		$user_list = D('House_village_user_bind')->field(true)->where($condition_where)->order('`pigcms_id` DESC')->limit($p->firstRow.','.$p->listRows)->select();				if($user_list){			$return['totalPage'] = ceil($count_user/$pageSize);			$return['user_count'] = count($user_list);			$return['pagebar'] = $p->show();			$return['user_list'] = $user_list;		}				return $return;	}    /**     * 获得业主列表2.0版本     * @param $village_id     * @param int $pageSize     * @return array|null     */    public function get_limit_list_page_2($village_id,$pageSize=20){        if(!$village_id){            return null;        }        $return = array();        //条件        $_map = array(            //'water_price'=>array('EXP','IS NOT NULL'),            'b.village_id'=>array('eq',$village_id),        );        //查询状态        if(isset($_GET['keyWord'])){            $_map['c.company_name|b.name|b.phone'] = array("like",'%' . $_GET['keyWord'] . '%');        }        $count_user = M('house_village_user_bind')            ->alias('b')            ->field(array('b.*','c.company_name'))            ->join('LEFT JOIN __COMPANY__ c on b.company_id=c.company_id')            ->where($_map)            ->count();        import('@.ORG.merchant_page');        $p = new Page($count_user,$pageSize,'page');        $user_list = M('house_village_user_bind')            ->alias('b')            ->field(array('b.*','c.company_name'))            ->join('LEFT JOIN __COMPANY__ c on b.company_id=c.company_id')            ->where($_map)            ->order('`pigcms_id` DESC')            ->limit($p->firstRow.','.$p->listRows)            ->select();        //处理当前的账单总和信息        foreach ($user_list as $key=>$value){            //寻找该业主本月的账单信息            $paylist_info = M('house_village_user_paylist')->where(array('phone'=>$value['phone'],'ydate'=>date('Y'),'mdate'=>date('m')))->find();            if($paylist_info){                //寻找到了账单信息那么待缴费用叠加                //水费                $user_list[$key]['total_waterPrice'] =round($paylist_info['water_price'],2)+round($value['water_price'],2);                $user_list[$key]['payWater_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_waterPrice']."&type=water&order_id=".$value['pigcms_id'];                //电费                $user_list[$key]['total_electricPrice'] =round($paylist_info['electric_price'],2)+round($value['electric_price'],2);                $user_list[$key]['payElectric_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_electricPrice']."&type=electric&order_id=".$value['pigcms_id'];                //燃气费                $user_list[$key]['total_gasPrice'] =round($paylist_info['gas_price'],2)+round($value['gas_price'],2);                $user_list[$key]['payGas_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_gasPrice']."&type=gas&order_id=".$value['pigcms_id'];                //物业费                $user_list[$key]['total_propertyPrice'] =round($paylist_info['property_price'],2)+round($value['property_price'],2);                $user_list[$key]['payProperty_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_propertyPrice']."&type=property&order_id=".$value['pigcms_id'];                //停车费                $user_list[$key]['total_parkPrice'] =round($paylist_info['park_price'],2)+round($value['park_price'],2);                $user_list[$key]['payPark_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_parkPrice']."&type=park&order_id=".$value['pigcms_id'];                //总计费用                $total_fee = $user_list[$key]['total_waterPrice']+$user_list[$key]['total_electricPrice']+$user_list[$key]['total_gasPrice']+$user_list[$key]['total_propertyPrice']+$user_list[$key]['total_parkPrice'];                $user_list[$key]['payTotal_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$total_fee."&type=all&order_id=".$value['pigcms_id'];            }else{                //水费                $user_list[$key]['payWater_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($value['water_price'],2)."&type=water&order_id=".$value['pigcms_id'];                //电费                $user_list[$key]['payElectric_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($value['electric_price'],2)."&type=electric&order_id=".$value['pigcms_id'];                //燃气费                $user_list[$key]['payGas_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($value['gas_price'],2)."&type=gas&order_id=".$value['pigcms_id'];                //物业费                $user_list[$key]['payProperty_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($value['property_price'],2)."&type=property&order_id=".$value['pigcms_id'];                //停车费                $user_list[$key]['payPark_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($value['park_price'],2)."&type=park&order_id=".$value['pigcms_id'];                //总计费用                $total_fee = round($value['water_price'],2)+round($value['electric_price'],2)+round($value['gas_price'],2)+round($value['property_price'],2)+round($value['park_price'],2);                $user_list[$key]['payTotal_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$total_fee."&type=all&order_id=".$value['pigcms_id'];            }        }        if($user_list){            $return['totalPage'] = ceil($count_user/$pageSize);            $return['user_count'] = count($user_list);            $return['pagebar'] = $p->show();            $return['user_list'] = $user_list;        }        return $return;    }    /**     * 获得业主列表2.0版本(超级管理员)     * @param $village_id     * @param int $pageSize     * @return array|null     */    public function get_limit_list_page_3($pageSize=20){        $return = array();        //条件        $_map = array(            'water_price'=>array('EXP','IS NOT NULL'),        );        //查询状态        if(isset($_GET['keyWord'])){            $_map['c.company_name|b.name|b.phone'] = array("like",'%' . $_GET['keyWord'] . '%');        }        $count_user = M('house_village_user_bind')            ->alias('b')            ->field(array('b.*','c.company_name'))            ->join('LEFT JOIN __COMPANY__ c on b.company_id=c.company_id')            ->where($_map)            ->count();        import('@.ORG.merchant_page');        $p = new Page($count_user,$pageSize,'page');        $user_list = M('house_village_user_bind')            ->alias('b')            ->field(array('b.*','c.company_name'))            ->join('LEFT JOIN __COMPANY__ c on b.company_id=c.company_id')            ->where($_map)            ->order('`pigcms_id` DESC')            ->limit($p->firstRow.','.$p->listRows)            ->select();        //处理当前的账单总和信息        foreach ($user_list as $key=>$value){            //寻找该业主本月的账单信息            $paylist_info = M('house_village_user_paylist')->where(array('phone'=>$value['phone'],'ydate'=>date('Y'),'mdate'=>date('m')))->find();            if($paylist_info){                //寻找到了账单信息那么待缴费用叠加                //水费                $user_list[$key]['total_waterPrice'] =round($paylist_info['water_price'],2)+round($value['water_price'],2);                $user_list[$key]['payWater_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_waterPrice']."&type=water&order_id=".$value['pigcms_id'];                //电费                $user_list[$key]['total_electricPrice'] =round($paylist_info['electric_price'],2)+round($value['electric_price'],2);                $user_list[$key]['payElectric_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_electricPrice']."&type=electric&order_id=".$value['pigcms_id'];                //燃气费                $user_list[$key]['total_gasPrice'] =round($paylist_info['gas_price'],2)+round($value['gas_price'],2);                $user_list[$key]['payGas_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_gasPrice']."&type=gas&order_id=".$value['pigcms_id'];                //物业费                $user_list[$key]['total_propertyPrice'] =round($paylist_info['property_price'],2)+round($value['property_price'],2);                $user_list[$key]['payProperty_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_propertyPrice']."&type=property&order_id=".$value['pigcms_id'];                //停车费                $user_list[$key]['total_parkPrice'] =round($paylist_info['park_price'],2)+round($value['park_price'],2);                $user_list[$key]['payPark_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_parkPrice']."&type=park&order_id=".$value['pigcms_id'];                //总计费用                $total_fee = $user_list[$key]['total_waterPrice']+$user_list[$key]['total_electricPrice']+$user_list[$key]['total_gasPrice']+$user_list[$key]['total_propertyPrice']+$user_list[$key]['total_parkPrice'];                $user_list[$key]['payTotal_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$total_fee."&type=all&order_id=".$value['pigcms_id'];            }else{                //水费                $user_list[$key]['payWater_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($value['water_price'],2)."&type=water&order_id=".$value['pigcms_id'];                //电费                $user_list[$key]['payElectric_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($value['electric_price'],2)."&type=electric&order_id=".$value['pigcms_id'];                //燃气费                $user_list[$key]['payGas_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($value['gas_price'],2)."&type=gas&order_id=".$value['pigcms_id'];                //物业费                $user_list[$key]['payProperty_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($value['property_price'],2)."&type=property&order_id=".$value['pigcms_id'];                //停车费                $user_list[$key]['payPark_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($value['park_price'],2)."&type=park&order_id=".$value['pigcms_id'];                //总计费用                $total_fee = round($value['water_price'],2)+round($value['electric_price'],2)+round($value['gas_price'],2)+round($value['property_price'],2)+round($value['park_price'],2);                $user_list[$key]['payTotal_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$total_fee."&type=all&order_id=".$value['pigcms_id'];            }        }        if($user_list){            $return['totalPage'] = ceil($count_user/$pageSize);            $return['user_count'] = count($user_list);            $return['pagebar'] = $p->show();            $return['user_list'] = $user_list;        }        return $return;    }    /**     * 获得业主列表2.0版本(普通管理员)     * @param $village_id     * @param int $pageSize     * @return array|null     */    public function get_limit_list_page_4($village_id,$company_id,$pageSize=20){        $return = array();        //条件        $_map = array(            'water_price'=>array('EXP','IS NOT NULL'),        );        if($village_id!=null&&$company_id!=null){            //公司管理员            $_map['b.company_id'] = array('eq',$company_id);        }else if($village_id!=null&&$company_id==null){            //社区管理员            $_map['b.village_id'] = array('eq',$village_id);        }        //查询状态        if(isset($_GET['keyWord'])){            $_map['c.company_name|b.name|b.phone'] = array("like",'%' . $_GET['keyWord'] . '%');        }        $count_user = M('house_village_user_bind')            ->alias('b')            ->field(array('b.*','c.company_name'))            ->join('LEFT JOIN __COMPANY__ c on b.company_id=c.company_id')            ->where($_map)            ->count();        import('@.ORG.merchant_page');        $p = new Page($count_user,$pageSize,'page');        $user_list = M('house_village_user_bind')            ->alias('b')            ->field(array('b.*','c.company_name'))            ->join('LEFT JOIN __COMPANY__ c on b.company_id=c.company_id')            ->where($_map)            ->order('`pigcms_id` DESC')            ->limit($p->firstRow.','.$p->listRows)            ->select();        //处理当前的账单总和信息        foreach ($user_list as $key=>$value){            //寻找该业主本月的账单信息            $paylist_info = M('house_village_user_paylist')->where(array('phone'=>$value['phone'],'ydate'=>date('Y'),'mdate'=>date('m')))->find();            if($paylist_info){                //寻找到了账单信息那么待缴费用叠加                //水费                $user_list[$key]['total_waterPrice'] =round($paylist_info['water_price'],2)+round($value['water_price'],2);                $user_list[$key]['payWater_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_waterPrice']."&type=water&order_id=".$value['pigcms_id'];                //电费                $user_list[$key]['total_electricPrice'] =round($paylist_info['electric_price'],2)+round($value['electric_price'],2);                $user_list[$key]['payElectric_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_electricPrice']."&type=electric&order_id=".$value['pigcms_id'];                //燃气费                $user_list[$key]['total_gasPrice'] =round($paylist_info['gas_price'],2)+round($value['gas_price'],2);                $user_list[$key]['payGas_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_gasPrice']."&type=gas&order_id=".$value['pigcms_id'];                //物业费                $user_list[$key]['total_propertyPrice'] =round($paylist_info['property_price'],2)+round($value['property_price'],2);                $user_list[$key]['payProperty_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_propertyPrice']."&type=property&order_id=".$value['pigcms_id'];                //停车费                $user_list[$key]['total_parkPrice'] =round($paylist_info['park_price'],2)+round($value['park_price'],2);                $user_list[$key]['payPark_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_parkPrice']."&type=park&order_id=".$value['pigcms_id'];                //总计费用                $total_fee = $user_list[$key]['total_waterPrice']+$user_list[$key]['total_electricPrice']+$user_list[$key]['total_gasPrice']+$user_list[$key]['total_propertyPrice']+$user_list[$key]['total_parkPrice'];                $user_list[$key]['payTotal_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$total_fee."&type=all&order_id=".$value['pigcms_id'];            }else{                //水费                $user_list[$key]['payWater_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($value['water_price'],2)."&type=water&order_id=".$value['pigcms_id'];                //电费                $user_list[$key]['payElectric_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($value['electric_price'],2)."&type=electric&order_id=".$value['pigcms_id'];                //燃气费                $user_list[$key]['payGas_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($value['gas_price'],2)."&type=gas&order_id=".$value['pigcms_id'];                //物业费                $user_list[$key]['payProperty_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($value['property_price'],2)."&type=property&order_id=".$value['pigcms_id'];                //停车费                $user_list[$key]['payPark_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($value['park_price'],2)."&type=park&order_id=".$value['pigcms_id'];                //总计费用                $total_fee = round($value['water_price'],2)+round($value['electric_price'],2)+round($value['gas_price'],2)+round($value['property_price'],2)+round($value['park_price'],2);                $user_list[$key]['payTotal_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$total_fee."&type=all&order_id=".$value['pigcms_id'];            }        }        if($user_list){            $return['totalPage'] = ceil($count_user/$pageSize);            $return['user_count'] = count($user_list);            $return['pagebar'] = $p->show();            $return['user_list'] = $user_list;        }        return $return;    }    /**     * 获取超级权限下的用户列表     * @author 祝君伟     * @time 2017年8月22日15:34:31     */    public function get_super_user_list(){        //区分高级权限        if(session('system.account') == SUPER_ADMIN){            $_map = array(                'is_pay_user'=>array('eq',1)            );        }else{            if(session('system.village_id')&&session('system.company_id')){                //公司管理员                $_map['b.company_id'] = array('eq',session('system.company_id'));            }else if (session('system.village_id')&&session('system.company_id')){                //社区管理员                $_map['b.village_id'] = array('eq',session('system.village_id'));            }        }        //查询状态        if(isset($_GET['keyWord'])){            $_map['c.company_name|b.name|b.phone'] = array("like",'%' . $_GET['keyWord'] . '%');        }        //字段        $field =array(            'b.name',            'b.phone',            'b.company_id',            'b.village_id',            'c.company_name',            'v.village_name',            't.*',            'group_concat(t.tdesc)'=>'st',            'group_concat(t.id)'=>'sid',            'group_concat(t.housesize)'=>'size',        );        //分页详情        $pageSize = 20;        $count_user = M('house_village_user_bind')            ->alias('b')            ->field($field)            ->join('LEFT JOIN __COMPANY__ c on b.company_id=c.company_id')            ->join('LEFT JOIN pigcms_house_village v on b.village_id=v.village_id')            ->join('LEFT JOIN pigcms_house_village_user_bind_tenement t on b.usernum=t.usernum')            ->where($_map)            ->count();        import('@.ORG.merchant_page');        $p = new Page($count_user,$pageSize,'page');        $user_list = M('house_village_user_bind')            ->alias('b')            ->field($field)            ->join('LEFT JOIN __COMPANY__ c on b.company_id=c.company_id')            ->join('LEFT JOIN pigcms_house_village v on b.village_id=v.village_id')            ->join('LEFT JOIN pigcms_house_village_user_bind_tenement t on b.usernum=t.usernum')            ->where($_map)            ->group('b.usernum')            ->order('`pigcms_id` DESC')            ->limit($p->firstRow.','.$p->listRows)            ->select();        //vd($user_list);exit();        //处理当前的账单总和信息        foreach ($user_list as $key=>$value){            //判断是否有多个层数的账单            if(strstr($value['sid'],",")===false){                //echo 1;exit;                //不包含                //寻找该业主本月的账单信息                $paylist_info = M('house_village_user_paylist')->where(array('tdesc'=>$value['tdesc'],'usernum'=>$value['usernum'],'ydate'=>date('Y'),'mdate'=>date('m')))->find();                if($paylist_info){                    //寻找到了账单信息那么待缴费用叠加                    //水费                    $user_list[$key]['total_waterPrice'] =round($paylist_info['water_price'],2)+round($value['water_price'],2);                    $user_list[$key]['payWater_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_waterPrice']."&type=water&order_id=".$value['pigcms_id'];                    //电费                    $user_list[$key]['total_electricPrice'] =round($paylist_info['electric_price'],2)+round($value['electric_price'],2);                    $user_list[$key]['payElectric_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_electricPrice']."&type=electric&order_id=".$value['pigcms_id'];                    //燃气费                    $user_list[$key]['total_gasPrice'] =round($paylist_info['gas_price'],2)+round($value['gas_price'],2);                    $user_list[$key]['payGas_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_gasPrice']."&type=gas&order_id=".$value['pigcms_id'];                    //物业费                    if($value['is_property'] == 1){                        $user_list[$key]['total_propertyPrice'] =round($paylist_info['property_price'],2)+round($value['property_unit']*$value['housesize'],2);                        $user_list[$key]['payProperty_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_propertyPrice']."&type=property&order_id=".$value['pigcms_id'];                    }else{                        $user_list[$key]['total_propertyPrice'] = 0;                    }                    //停车费                    $user_list[$key]['total_parkPrice'] =round($paylist_info['park_price'],2)+round($value['park_price'],2);                    $user_list[$key]['payPark_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_parkPrice']."&type=park&order_id=".$value['pigcms_id'];                    //总计费用                    $total_fee = $user_list[$key]['total_waterPrice']+$user_list[$key]['total_electricPrice']+$user_list[$key]['total_gasPrice']+$user_list[$key]['total_propertyPrice']+$user_list[$key]['total_parkPrice'];                    $user_list[$key]['payTotal_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$total_fee."&type=all&order_id=".$value['pigcms_id'];                }else{                    //水费                    $user_list[$key]['payWater_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($value['water_price'],2)."&type=water&order_id=".$value['pigcms_id'];                    //电费                    $user_list[$key]['payElectric_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($value['electric_price'],2)."&type=electric&order_id=".$value['pigcms_id'];                    //燃气费                    $user_list[$key]['payGas_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($value['gas_price'],2)."&type=gas&order_id=".$value['pigcms_id'];                    //物业费                    if($value['is_property'] == 1){                        $user_list[$key]['payProperty_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($value['property_unit']*$value['housesize'],2)."&type=property&order_id=".$value['pigcms_id'];                    }else{                        $user_list[$key]['payProperty_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=0&type=property&order_id=".$value['pigcms_id'];                    }                    //停车费                    $user_list[$key]['payPark_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($value['park_price'],2)."&type=park&order_id=".$value['pigcms_id'];                    //总计费用                    $total_fee = round($value['water_price'],2)+round($value['electric_price'],2)+round($value['gas_price'],2)+round($value['property_price'],2)+round($value['park_price'],2);                    $user_list[$key]['payTotal_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$total_fee."&type=all&order_id=".$value['pigcms_id'];                }            }else{                //包含                $transfer_sid = explode(',',$value['sid']);                foreach ($transfer_sid as $sv){                    //寻找该业主本月的账单信息                    $sid_info = M('house_village_user_bind_tenement')->find($sv);                    $paylist_info = M('house_village_user_paylist')->where(array('tdesc'=>$sid_info['tdesc'],'usernum'=>$sid_info['usernum'],'ydate'=>date('Y'),'mdate'=>date('m')))->find();                    if($paylist_info){                        //水费                        $this_water_price =round($paylist_info['water_price'],2)+round($sid_info['water_price'],2);                        //电费                        $this_electric_price =round($paylist_info['electric_price'],2)+round($sid_info['electric_price'],2);                        //燃气费                        $this_gas_price =round($paylist_info['gas_price'],2)+round($sid_info['gas_price'],2);                        if($sid_info['is_property'] == 1){                            //物业费                            $this_property_price =round($paylist_info['property_price'],2)+round($sid_info['property_unit']*$sid_info['housesize'],2);                        }else{                            $this_property_price = 0;                        }                        //停车费                        $this_park_price =round($paylist_info['park_price'],2)+round($sid_info['park_price'],2);                    }else{                        //水费                        $this_water_price =round($sid_info['water_price'],2);                        //电费                        $this_electric_price =round($sid_info['electric_price'],2);                        //燃气费                        $this_gas_price =round($sid_info['gas_price'],2);                        if($sid_info['is_property'] == 1){                            //物业费                            $this_property_price =round($sid_info['property_unit']*$sid_info['housesize'],2);                        }else{                            $this_property_price = 0;                        }                        //停车费                        $this_park_price =round($sid_info['park_price'],2);                    }                    //费用                    $user_list[$key]['total_waterPrice'] += $this_water_price;                    $user_list[$key]['total_electricPrice'] += $this_electric_price;                    $user_list[$key]['total_gasPrice'] += $this_gas_price;                    $user_list[$key]['total_propertyPrice'] += $this_property_price;                    $user_list[$key]['total_parkPrice'] += $this_park_price;                }                //支付url                $total_fee = $user_list[$key]['total_waterPrice']+$user_list[$key]['total_electricPrice']+$user_list[$key]['total_gasPrice']+$user_list[$key]['total_propertyPrice']+$user_list[$key]['total_parkPrice'];                $user_list[$key]['payWater_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_waterPrice']."&type=water&order_id=".$value['pigcms_id'];                $user_list[$key]['payElectric_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_electricPrice']."&type=electric&order_id=".$value['pigcms_id'];                $user_list[$key]['payGas_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_gasPrice']."&type=gas&order_id=".$value['pigcms_id'];                $user_list[$key]['payProperty_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_propertyPrice']."&type=property&order_id=".$value['pigcms_id'];                $user_list[$key]['payPark_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_parkPrice']."&type=park&order_id=".$value['pigcms_id'];                $user_list[$key]['payTotal_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$total_fee."&type=all&order_id=".$value['pigcms_id'];                $user_list[$key]['more'] = 1;            }        }        //vd($user_list);exit;        if($user_list){            $return['totalPage'] = ceil($count_user/$pageSize);            $return['user_count'] = count($user_list);            $return['pagebar'] = $p->show();            $return['user_list'] = $user_list;        }        return $return;    }    public function get_this_user_list($usernum){        //区分高级权限        if(session('system.account') == SUPER_ADMIN){            $_map = array(                'b.usernum'=>$usernum            );        }else{            if(session('system.village_id')&&session('system.company_id')){                //公司管理员                $_map['b.company_id'] = array('eq',session('system.company_id'));            }else if (session('system.village_id')&&session('system.company_id')){                //社区管理员                $_map['b.village_id'] = array('eq',session('system.village_id'));            }        }        //查询状态        if(isset($_GET['keyWord'])){            $_map['c.company_name|b.name|b.phone'] = array("like",'%' . $_GET['keyWord'] . '%');        }        //字段        $field =array(            'b.name',            'b.phone',            'b.company_id',            'b.village_id',            'c.company_name',            'v.village_name',            't.*',        );        //分页详情        $pageSize = 20;        $count_user = M('house_village_user_bind')            ->alias('b')            ->field($field)            ->join('LEFT JOIN __COMPANY__ c on b.company_id=c.company_id')            ->join('LEFT JOIN pigcms_house_village v on b.village_id=v.village_id')            ->join('LEFT JOIN pigcms_house_village_user_bind_tenement t on b.usernum=t.usernum')            ->where($_map)            ->count();        import('@.ORG.merchant_page');        $p = new Page($count_user,$pageSize,'page');        $user_list = M('house_village_user_bind')            ->alias('b')            ->field($field)            ->join('LEFT JOIN __COMPANY__ c on b.company_id=c.company_id')            ->join('LEFT JOIN pigcms_house_village v on b.village_id=v.village_id')            ->join('LEFT JOIN pigcms_house_village_user_bind_tenement t on b.usernum=t.usernum')            ->where($_map)            ->order('`pigcms_id` DESC')            ->limit($p->firstRow.','.$p->listRows)            ->select();        //vd($user_list);exit();        //处理当前的账单总和信息        foreach ($user_list as $key=>$value){            //判断是否有多个层数的账单                //echo 1;exit;                //不包含                //寻找该业主本月的账单信息                $sid_info = M('house_village_user_bind_tenement')->find($value['id']);                //vd($sid_info);exit;                $paylist_info = M('house_village_user_paylist')->where(array('tdesc'=>$value['tdesc'],'usernum'=>$value['usernum'],'ydate'=>date('Y'),'mdate'=>date('m')))->find();            if($paylist_info){                //寻找到了账单信息那么待缴费用叠加                //水费                $user_list[$key]['total_waterPrice'] =round($paylist_info['water_price'],2)+round($sid_info['water_price'],2);                $user_list[$key]['payWater_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_waterPrice']."&type=water&order_id=".$value['pigcms_id'];                //电费                $user_list[$key]['total_electricPrice'] =round($paylist_info['electric_price'],2)+round($sid_info['electric_price'],2);                $user_list[$key]['payElectric_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_electricPrice']."&type=electric&order_id=".$value['pigcms_id'];                //燃气费                $user_list[$key]['total_gasPrice'] =round($paylist_info['gas_price'],2)+round($sid_info['gas_price'],2);                $user_list[$key]['payGas_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_gasPrice']."&type=gas&order_id=".$value['pigcms_id'];                //物业费                if($sid_info['is_property'] == 1){                    $user_list[$key]['total_propertyPrice'] =round($paylist_info['property_price'],2)+round($sid_info['property_unit']*$value['housesize'],2);                    $user_list[$key]['payProperty_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_propertyPrice']."&type=property&order_id=".$value['pigcms_id'];                }else{                    $user_list[$key]['total_propertyPrice'] = 0;                }                //停车费                $user_list[$key]['total_parkPrice'] =round($paylist_info['park_price'],2)+round($sid_info['park_price'],2);                $user_list[$key]['payPark_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$user_list[$key]['total_parkPrice']."&type=park&order_id=".$value['pigcms_id'];                //总计费用                $total_fee = $user_list[$key]['total_waterPrice']+$user_list[$key]['total_electricPrice']+$user_list[$key]['total_gasPrice']+$user_list[$key]['total_propertyPrice']+$user_list[$key]['total_parkPrice'];                $user_list[$key]['payTotal_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$total_fee."&type=all&order_id=".$value['pigcms_id'];            }else{                //水费                $user_list[$key]['total_waterPrice'] =round($sid_info['water_price'],2);                $user_list[$key]['payWater_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($sid_info['water_price'],2)."&type=water&order_id=".$value['pigcms_id'];                //电费                $user_list[$key]['total_electricPrice'] =round($sid_info['electric_price'],2);                $user_list[$key]['payElectric_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($sid_info['electric_price'],2)."&type=electric&order_id=".$value['pigcms_id'];                //燃气费                $user_list[$key]['total_gasPrice'] =round($sid_info['gas_price'],2);                $user_list[$key]['payGas_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($sid_info['gas_price'],2)."&type=gas&order_id=".$value['pigcms_id'];                //物业费                if($sid_info['is_property'] == 1){                    $user_list[$key]['total_propertyPrice'] =round($sid_info['property_unit']*$value['housesize'],2);                    $user_list[$key]['payProperty_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($sid_info['property_unit']*$value['housesize'],2)."&type=property&order_id=".$value['pigcms_id'];                }else{                    $user_list[$key]['total_propertyPrice'] =0;                    $user_list[$key]['payProperty_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=0&type=property&order_id=".$value['pigcms_id'];                }                //停车费                $user_list[$key]['total_parkPrice'] =round($sid_info['park_price'],2);                $user_list[$key]['payPark_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".round($sid_info['park_price'],2)."&type=park&order_id=".$value['pigcms_id'];                //总计费用                $total_fee = round($sid_info['water_price'],2)+round($sid_info['electric_price'],2)+round($sid_info['gas_price'],2)+round($sid_info['property_price'],2)+round($sid_info['park_price'],2);                $user_list[$key]['payTotal_url'] = "http://".$_SERVER ['HTTP_HOST']."/admin.php?g=System&c=PropertyService&a=chinaPay&company_id=".$value['company_id']."&money=".$total_fee."&type=all&order_id=".$value['pigcms_id'];            }        }        //vd($user_list);exit;        if($user_list){            $return['totalPage'] = ceil($count_user/$pageSize);            $return['user_count'] = count($user_list);            $return['pagebar'] = $p->show();            $return['user_list'] = $user_list;        }        return $return;    }		/*得到单个业主信息*/	public function get_one($village_id,$value,$field='uid',$bind_uid=0){		$condition_user['village_id'] = $village_id;		$condition_user[$field] = $value;		$now_user = $this->field(true)->where($condition_user)->find();		// dump($this);		if(!empty($now_user)){			$now_user['water_price'] = floatval($now_user['water_price']);			$now_user['electric_price'] = floatval($now_user['electric_price']);			$now_user['gas_price'] = floatval($now_user['gas_price']);			$now_user['park_price'] = floatval($now_user['park_price']);			$now_user['property_price'] = floatval($now_user['property_price']);			if($bind_uid){				$this->where(array('pigcms_id'=>$now_user['pigcms_id']))->data(array('uid'=>$bind_uid))->save();			}		}		return $now_user;	}		/*得到单个业主信息*/	public function get_one_by_bindId($pigcms_id){		$condition_user['pigcms_id'] = $pigcms_id;		$now_user = $this->field(true)->where($condition_user)->find();		if(!empty($now_user)){			$now_user['water_price'] = floatval($now_user['water_price']);			$now_user['electric_price'] = floatval($now_user['electric_price']);			$now_user['gas_price'] = floatval($now_user['gas_price']);			$now_user['park_price'] = floatval($now_user['park_price']);			$now_user['property_price'] = floatval($now_user['property_price']);			if($bind_uid){				$this->where(array('pigcms_id'=>$now_user['pigcms_id']))->data(array('uid'=>$bind_uid))->save();			}		}		return $now_user;	}		/*得到小区下所有的业主列表(绑定微信的)*/	public function get_limit_list_open($village_id,$pageSize=5){		if(!$village_id){			return null;		}			$return = array();				$condition_table  = array(C('DB_PREFIX').'House_village_user_bind'=>'b',C('DB_PREFIX').'user'=>'u');		$condition_where = " b.uid = u.uid 	AND  u.openid !='' AND b.uid>0 AND b.village_id=".$village_id;		$condition_field = ' distinct(u.openid), b.uid,u.openid ';		// if($bigId !== 0){			// $condition_where .= " AND b.pigcms_id<=".$bigId." AND b.pigcms_id>=".$smallId;		// }		$count_user = D('')->table($condition_table)->where($condition_where)->count('distinct(u.openid)');		import('@.ORG.merchant_page');		$p = new Page($count_user,$pageSize,'page');		$user_list = D('')->table($condition_table)->field($condition_field)->where($condition_where)->order('`b`.`pigcms_id` DESC')->limit($p->firstRow.','.$p->listRows)->select();			if($user_list){			$return['totalPage'] = ceil($count_user/$pageSize);			$return['user_count'] = count($user_list);			$return['pagebar'] = $p->show();			$return['user_list'] = $user_list;		}		return $return;	}		/*得到小区下所有欠费业主列表(绑定微信的)*/	public function get_pay_list_open($village_id,$pageSize=20,$bigId=0,$smallId=0){		if(!$village_id){			return null;		}			$return = array();			$condition_table  = array(C('DB_PREFIX').'house_village_user_paylist'=>'b',C('DB_PREFIX').'user'=>'u');		$condition_where = " b.uid = u.uid 	AND  u.openid !='' AND b.uid>0 AND b.village_id=".$village_id;		$condition_field = ' distinct(u.openid), b.uid,u.openid,b.address ';		if($bigId !== 0){			$condition_where .= " AND b.pigcms_id<=".$bigId." AND b.pigcms_id>=".$smallId;		}		$count_user = D('')->table($condition_table)->where($condition_where)->count('distinct(u.openid)');		import('@.ORG.merchant_page');		$p = new Page($count_user,$pageSize,'page');		$user_list = D('')->table($condition_table)->field($condition_field)->where($condition_where)->order('`b`.`pigcms_id` DESC')->limit($p->firstRow.','.$p->listRows)->select();		if($user_list){			$return['totalPage'] = ceil($count_user/$pageSize);			$return['user_count'] = count($user_list);			$return['pagebar'] = $p->show();			$return['user_list'] = $user_list;		}		return $return;	}		public function getlist($village_id=''){		$condition_table = array(C('DB_PREFIX') . 'House_village_user_bind' => 'n',C('DB_PREFIX').'user'=>'u',C('DB_PREFIX').'house_village'=>'v',C('DB_PREFIX').'company'=>'c') ;		if(!empty($village_id)){			$condition_where="n.ac_status>=1 and u.uid=n.uid and n.village_id=v.village_id and c.company_id=n.company_id and n.village_id=".$village_id;			$condition_field = 'n.*,u.nickname,c.company_name';			import('@.ORG.merchant_page');		}else{			$condition_where="n.ac_status>=1 and u.uid=n.uid and n.village_id=v.village_id and c.company_id=n.company_id";			$condition_field = 'n.*,u.nickname,v.village_name,c.company_name';			import('@.ORG.system_page');		}		$order = ' n.add_time DESC ';		$count_userCheck = D('')->table($condition_table)->where($condition_where)->count();		$p = new Page($count_userCheck, 15, 'page');		$village_list = D('')->field($condition_field)->table($condition_table)->where($condition_where)->order($order)->limit($p->firstRow . ',' . $p->listRows)->select();		$return['pagebar'] = $p->show();		$return['userCheck_list'] = $village_list;		return $return;	}	public function getVisitor($village_id=''){		$condition_table = array(									C('DB_PREFIX') . 'House_village_user_bind' => 'n',									C('DB_PREFIX').'user'=>'u',									C('DB_PREFIX').'house_village'=>'v'								);		if(!empty($village_id)){			$condition_where="u.uid=n.uid and n.village_id=v.village_id and n.role=2 and n.village_id=".$village_id;			$condition_field = 'n.*,u.nickname';			import('@.ORG.merchant_page');		}else{			$condition_where="u.uid=n.uid and n.role=2 and n.village_id=v.village_id";			$condition_field = 'n.*,u.nickname,v.village_name';			import('@.ORG.system_page');		}		$order = ' n.add_time DESC ';		$count_visitor = D('')->table($condition_table)->where($condition_where)->count();		$p = new Page($count_visitor, 15, 'page');		$visitor_list = D('')->field($condition_field)->table($condition_table)->where($condition_where)->order($order)->limit($p->firstRow . ',' . $p->listRows)->select();		$return['pagebar'] = $p->show();		$return['visitor_list'] = $visitor_list;		return $return;	}	public function get_user_bind_search($name,$phone,$usernum,$village_id,$con='or'){	    $where=array();	    if(!empty($name)){	        $where['name']=array('like',$name);        }        if(!empty($phone)){            $where['phone']=array('like',$phone);        }        if(!empty($usernum)){            $where['usernum']=array('like',$usernum);        }        if(!empty($village_id)){            $where['village_id']=array('like',$village_id);        }        $where['_logic'] = $con;        $userlist=M('house_village_user_bind')->where($where)->select();        return $userlist;    }	}?>