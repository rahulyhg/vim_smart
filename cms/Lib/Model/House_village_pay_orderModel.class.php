<?phpclass House_village_pay_orderModel extends Model{	/*得到小区的新闻列表*/	public function get_limit_list_page($column,$pageSize=20,$isSystem=false){		if(!$column['village_id']){			return null;		}    	    	$condition_table  = array(C('DB_PREFIX').'House_village_pay_order'=>'o',C('DB_PREFIX').'house_village_user_bind'=>'b');    	$condition_where = " `o`.`village_id` = `b`.`village_id`  AND `o`.`bind_id` = `b`.`pigcms_id`";    	if($column['village_id']){            $condition_where .= "AND `o`.`village_id` = " . $column['village_id'];    	}    	if($column['paid']){    		$condition_where .= " AND `o`.`paid`= ".intval($column['paid']);    	}    	    	$condition_field = '`b`.`name` AS `username` ,o.*,b.*';    	    	$order = ' `o`.`order_id` DESC, `o`.`paid` ASC';    	if($isSystem){    		import('@.ORG.system_page');    	}else{    		import('@.ORG.merchant_page');    	}    	$count_order = D('')->table($condition_table)->where($condition_where)->count();    	$p = new Page($count_order,$pageSize,'page');    	$order_list = D('')->field($condition_field)->table($condition_table)->where($condition_where)->order($order)->limit($p->firstRow.','.$p->listRows)->select();    	    	$total = D('')->field(' SUM(`o`.`money` ) AS totalMoney ')->table($condition_table)->where($condition_where)->find();    	$already = D('')->field(' SUM(`o`.`money` ) AS readyMoney ')->table($condition_table)->where($condition_where." AND `o`.`is_pay_bill`=1 ")->find();    	    	$return['pagebar'] = $p->show();    	$return['order_list'] = $order_list;    	$return['totalMoney'] = $total;    	$return['readyMoney'] = $already;    	    	return $return;	}		/* 获取缴费订单ID	* @time 2016-04-18	* @author	小邓  <969101097@qq.com>*/	public function get_order_by_id($uid,$order_id){		$condition_user_recharge_order['uid'] = $uid;		$condition_user_recharge_order['order_id'] = $order_id;		return $this->field(true)->where($condition_user_recharge_order)->find();	}		/* 获取缴费订单信息	* @time 2016-04-18	* @author	小邓  <969101097@qq.com>*/	public function get_pay_order($uid,$order_id,$is_web=false){		$now_order = $this->get_order_by_id($uid,$order_id);		// dump($this);exit;		if(empty($now_order)){			return array('error'=>1,'msg'=>'当前订单不存在！');		}				if($is_web){			$order_info = array(				'order_id'			=>	$now_order['order_id'],				'order_type'		=>	'livepay',				'order_total_money'	=>	floatval($now_order['money']),				'order_content'    =>  array(						0=>array(								'name'  		=> '在线缴费',								'num'   		=> 1,								'price' 		=> floatval($now_order['money']),								'money' 	=> floatval($now_order['money']),						)				)			);		}else{			$order_info = array(					'order_id'			=>	$now_order['order_id'],					'order_type'		=>	'livepay',					'order_name'		=>	'在线缴费',					'order_num'			=>	1,					'order_price'		=>	floatval($now_order['money']),					'order_total_money'	=>	floatval($now_order['money']),					'live_type'		=>	$now_order['order_type'],	//缴费类型					'bind_id'		=>	$now_order['bind_id'],	//缴费类型					'village_id'	=>	$now_order['village_id'],	//所属社区			);		}		return array('error'=>0,'order_info'=>$order_info);	}    /* 获取缴费订单信息    * @time 2016-04-18    * @author	小邓  <969101097@qq.com>*/    public function get_pay_uptown_order($uid,$order_id,$is_web=false){        $now_order = $this->get_order_by_id($uid,$order_id);        // dump($this);exit;        if(empty($now_order)){            return array('error'=>1,'msg'=>'当前订单不存在！');        }        if($is_web){            $order_info = array(                'order_id'			=>	$now_order['order_id'],                'order_type'		=>	'livepay_uptown',                'order_total_money'	=>	floatval($now_order['money']),                'order_content'    =>  array(                    0=>array(                        'name'  		=> '在线缴费',                        'num'   		=> 1,                        'price' 		=> floatval($now_order['money']),                        'money' 	=> floatval($now_order['money']),                    )                )            );        }else{            $order_info = array(                'order_id'			=>	$now_order['order_id'],                'order_type'		=>	'livepay_uptown',                'order_name'		=>	'在线缴费',                'order_num'			=>	1,                'order_price'		=>	floatval($now_order['money']),                'order_total_money'	=>	floatval($now_order['money']),                'live_type'		=>	$now_order['order_type'],	//缴费类型                'bind_id'		=>	$now_order['bind_id'],	//缴费类型                'village_id'	=>	$now_order['village_id'],	//所属社区            );        }        return array('error'=>0,'order_info'=>$order_info);    }		/* 获取个人缴费订单信息	* @time 2016-04-19	* @author	小邓  <969101097@qq.com>*/	public function get_limit_list_my($column,$pageSize=20,$isSystem=false){		if(!$column['uid']){			return null;		}    	    	$condition_table  = array(C('DB_PREFIX').'House_village_pay_order'=>'o',C('DB_PREFIX').'house_village_user_bind'=>'b');    	$condition_where = " `o`.`uid` = `b`.`uid`  AND `o`.`bind_id` = `b`.`pigcms_id`  AND `o`.`uid` =".$column['uid'];    	    	if($column['paid']){    		$condition_where .= " AND `o`.`paid`= ".intval($column['paid']);    	}    	    	$condition_field = '`b`.`name` AS `username` ,o.*,b.*';    	    	$order = ' `o`.`order_id` DESC, `o`.`paid` ASC';    	if($isSystem){    		import('@.ORG.system_page');    	}else{    		import('@.ORG.merchant_page');    	}    	$count_order = D('')->table($condition_table)->where($condition_where)->count();    	$p = new Page($count_order,$pageSize,'page');    	$order_list = D('')->field($condition_field)->table($condition_table)->where($condition_where)->order($order)->limit($p->firstRow.','.$p->listRows)->select();    	    	$total = D('')->field(' SUM(`o`.`money` ) AS totalMoney ')->table($condition_table)->where($condition_where)->find();    	$already = D('')->field(' SUM(`o`.`money` ) AS readyMoney ')->table($condition_table)->where($condition_where." AND `o`.`is_pay_bill`=1 ")->find();    	if($order_list){			$return['pagebar'] = $p->show();			$return['order_list'] = $order_list;			$return['totalMoney'] = $total;			$return['readyMoney'] = $already;			return $return;		}else{			return false;		}    		}		/* 手机端支付前订单处理	* @time 2016-04-19	* @author	小邓  <969101097@qq.com>*/	public function wap_befor_pay($order_info,$now_user){				if(!empty($now_user['now_money'])){	//判断帐户余额			if($now_user['now_money'] >=$order_info['order_total_money']){	//如果账户余额够付				D('House_village_pay_order')->where(array('uid'=>$now_user['uid'],'order_id'=>$order_info['order_id']))->save(array('paid'=>1));	//改变支付状态				$now_money=$now_user['now_money']-$order_info['order_total_money'];				$user_alter=D('User')->save_user($now_user['uid'],'now_money',$now_money);				if($user_alter){					$type_price=$order_info['live_type'].'_price';	//缴费类型					D('House_village_user_bind')->where(array('uid'=>$now_user['uid'],'pigcms_id'=>$order_info['bind_id']))->data(array("$type_price"=>0))->save();					$use_type='use_'.$order_info['live_type'];		//将对应的缴费类型清零									D('House_village_user_paylist')->where(array('uid'=>$now_user['uid'],'bind_id'=>$order_info['bind_id']))->data(array("$use_type"=>0,"$type_price"=>0))->save();					//return array('error'=>0,'msg'=>'缴费成功！','url'=>U('My/index'));					return array('error'=>0,'msg'=>'缴费成功！','url'=>U('House/village_my',array('village_id'=>$order_info['village_id'])));				}else{					//$this->error_tips('缴费失败！');					return array('error'=>1,'msg'=>'缴费失败！');				}			}else{							$pay_money=$order_info['order_total_money']-$now_user['now_money'];	//须在线支付的金额				return array('error_code'=>false,'pay_money'=>$pay_money);			}		}else{			return array('error_code'=>false,'pay_money'=>$order_info['order_total_money']);		}	}	}