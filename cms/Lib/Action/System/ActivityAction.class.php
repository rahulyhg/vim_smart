<?php/* * 推广营销 - 活动列表 * * @  Writers    Jaty * @  BuildTime  2015/06/15 14:25 *  */class ActivityAction extends BaseAction{	public function index(){		$database_extension_activity = D('Extension_activity');		$activity_list = $database_extension_activity->field(true)->order('`activity_id` DESC')->select();		$this->assign('activity_list',$activity_list);		$this->display();	}	public function index_news(){		$database_extension_activity = D('Extension_activity');		$activity_list = $database_extension_activity->field(true)->order('`activity_id` DESC')->select();		$this->assign('activity_list',$activity_list);		$this->display();	}	public function add(){		//找到活动的下一个时间段		$database_extension_activity = D('Extension_activity');		$max_end_time = $database_extension_activity->max('end_time');		$this->assign('next_time',($max_end_time ? $max_end_time : 0));				$this->assign('bg_color','#F3F3F3');		$this->display();	}	public function modify(){		if(IS_POST){			//上传图片						$image = D('Image')->handle($this->system_session['id'], 'extension', 0, array('size' => 10));			if (!$image['error']) {				$_POST = array_merge($_POST, str_replace('/upload/extension/', '', $image['url']));			} else {				$this->frame_submit_tips(0, $image['msg']);			}// 			$rand_num = date('Y/m',$_SERVER['REQUEST_TIME']);// 			$upload_dir = './upload/extension/'.$rand_num.'/'; // 			if(!is_dir($upload_dir)){// 				mkdir($upload_dir,0777,true);// 			}// 			import('ORG.Net.Upload File');// 			$upload = new Upload File();// 			$upload->maxSize = 10*1024*1024;// 			$upload->allowExts = array('jpg','jpeg','png','gif');// 			$upload->allowTypes = array('image/png','image/jpg','image/jpeg','image/gif');// 			$upload->savePath = $upload_dir; // 			$upload->saveRule = 'uniqid';// 			if($upload->upload()){// 				$uploadList = $upload->getUpload FileInfo();// 				$_POST['bg_pic'] = $rand_num.'/'.$uploadList[0]['savename'];// 			}else{// 				$this->frame_submit_tips(0,$upload->getErrorMsg());// 			}			$_POST['begin_time'] = strtotime($_POST['begin_time']);			$_POST['end_time'] = strtotime($_POST['end_time']);			$database_extension_activity = D('Extension_activity');			if($activity_id = $database_extension_activity->data($_POST)->add()){				D('Image')->update_table_id('/upload/extension/' . $_POST['bg_pic'], $activity_id, 'extension_activity');				$this->frame_submit_tips(1,'添加成功！');			}else{				$this->frame_submit_tips(0,'添加失败！请重试~');			}		}else{			$this->frame_submit_tips(0,'非法提交,请重新提交~');		}	}	public function edit(){		$this->assign('bg_color','#F3F3F3');		$database_extension_activity = D('Extension_activity');		$condition_extension_activity['activity_id'] = intval($_GET['id']);		$now_activity = $database_extension_activity->where($condition_extension_activity)->find();		if(empty($now_activity)){			$this->frame_error_tips('该活动不存在！');		}		$this->assign('now_activity',$now_activity);		$this->display();	}	public function amend(){		if(IS_POST){			$activityOb = M('Extension_activity');			$activity_id = $_POST['activity_id'];			$_POST['begin_time'] = strtotime($_POST['begin_time']);			$_POST['end_time'] = strtotime($_POST['end_time']);			$gift =$_POST['gift'];			$probability = $_POST['probability'];			$gifttype = $_POST['gifttype'];			$activityOb->data($_POST)->save();			$sql = "UPDATE pigcms_extension_activity SET gift='$gift',probability='$probability',gifttype='$gifttype'  WHERE activity_id = 5";			$res = $activityOb->query($sql);			if($_FILES['bg_pic']['error'] != 4){				$image = D('Image')->handle($this->system_session['id'], 'extension', 0, array('size' => 10));				if (!$image['error']) {					$_POST = array_merge($_POST, str_replace('/upload/extension/', '', $image['url']));				} else {					$this->frame_submit_tips(0, $image['msg']);				}				//上传图片// 				$rand_num = date('Y/m',$_SERVER['REQUEST_TIME']);// 				$upload_dir = './upload/extension/'.$rand_num.'/';// 				if(!is_dir($upload_dir)){// 					mkdir($upload_dir,0777,true);// 				}// 				import('ORG.Net.Uplo adFile');// 				$upload = new Upload File();// 				$upload->maxSize = 10*1024*1024;// 				$upload->allowExts = array('jpg','jpeg','png','gif');// 				$upload->allowTypes = array('image/png','image/jpg','image/jpeg','image/gif');// 				$upload->savePath = $upload_dir;// 				$upload->saveRule = 'uniqid';// 				if($upload->upload()){// 					$uploadList = $upload->getUploadFi leInfo();// 					$_POST['bg_pic'] = $rand_num.'/'.$uploadList[0]['savename'];// 				}else{// 					$this->frame_submit_tips(0,$upload->getErrorMsg());// 				}			}			if(!$res){				D('Image')->update_table_id('/upload/extension/' . $_POST['bg_pic'], $activity_id, 'extension_activity');				$this->frame_submit_tips(1,'修改成功！');			}else{				$this->frame_submit_tips(0,'修改失败！请重试~');			}		}else{			$this->frame_submit_tips(0,'非法提交,请重新提交~');		}	}	public function del(){		// if(IS_POST){			// $database_search_hot = D('Search_hot');			// $condition_search_hot['id'] = intval($_POST['id']);			// if($database_search_hot->where($condition_search_hot)->delete()){				// S('search_hot_list',NULL);				// $this->success('删除成功！');			// }else{				// $this->error('删除失败！请重试~');			// }		// }else{			// $this->error('非法提交,请重新提交~');		// }		$this->error('活动暂时不能删除~');	}		public function activity_list(){		$database_extension_activity = D('Extension_activity');		$condition_extension_activity['activity_id'] = intval($_GET['id']);		$now_activity = $database_extension_activity->field(true)->where($condition_extension_activity)->find();		if(empty($now_activity)){			$this->error_tips('该活动不存在');		}		$this->assign('now_activity',$now_activity);				$database_extension_activity_list = D('Extension_activity_list');		$condition_extension_activity_list['activity_term'] = $_GET['id'];		$activity_list = $database_extension_activity_list->field(true)->where($condition_extension_activity_list)->order('`pigcms_id` DESC')->select();		if(empty($activity_list)){			$this->error_tips('该活动暂时没有商家参与');		}		foreach($activity_list as &$value){			$value['type_txt'] = $this->type_txt($value['type']);		}		$this->assign('activity_list',$activity_list);		$this->display();	}	public function activity_list_news(){		$database_extension_activity = D('Extension_activity');		$condition_extension_activity['activity_id'] = intval($_GET['id']);		$now_activity = $database_extension_activity->field(true)->where($condition_extension_activity)->find();		if(empty($now_activity)){			$this->error('该活动不存在');		}		$this->assign('now_activity',$now_activity);		$database_extension_activity_list = D('Extension_activity_list');		$condition_extension_activity_list['activity_term'] = $_GET['id'];		$activity_list = $database_extension_activity_list->field(true)->where($condition_extension_activity_list)->order('`pigcms_id` DESC')->select();		if(empty($activity_list)){			$this->error('该活动暂时没有商家参与');		}		foreach($activity_list as &$value){			$value['type_txt'] = $this->type_txt($value['type']);		}		$this->assign('activity_list',$activity_list);		$this->display();	}	protected function type_txt($type){		switch($type){			case '1':				return '一元夺宝';			case '2':				return '优惠券';			case '3':				return '秒杀';			case '4':				return '红包';			case '5':				return '卡券';		}	}	/*活动参与人数列表	 * @author 祝君伟	 * @time 2016.11.18	 */	public function hotactivity(){		//获取所有活动的名称		$id = $_GET['activity_id'];		$database_extension_activity = D('Extension_activity');		$activity_list = $database_extension_activity->field("activity_id,name")->order("activity_id DESC")->select();		$this->assign('activity_list',$activity_list);		if(!empty($id)){			//获取活动的开始时间和结束时间			$database_extension_activity = D('Extension_activity');			$activity_list = $database_extension_activity->field("begin_time,name")->where(array('activity_id'=>$id))->find();			$begin_time=$activity_list['begin_time'];			$name = $activity_list['name'];			/*$begin_time = 1478707200;*///$activity_list['begin_time'];			//$activity_list['end_time'];			/*var_dump($activity_list);exit;*/			if($name == '双十一活动'){				//根据活动的执行的时间到user表里面查取活动人数等数据				$database_user = M('user');				//参与活动的人				/*$sql_preson = "select nickname,phone,sex,order_time from pigcms_user WHERE order_time>$begin_time and order_time<$end_time order BY order_time DESC limit 0,15"*/				import('@.ORG.system_page');	//引入分页				$time=array('gt',$begin_time);				$count_access = D('')->table(array('pigcms_user'=>'user'))->where(array("user.order_time"=>$time))->count();				$p=new Page($count_access,10,'page');				$activity_preson_list = $database_user->where(array("order_time"=>$time))->order("order_time desc")->limit($p->firstRow .','.$p->listRows)->select();				$get_log_list=$p->show();				$this->assign('count_access',$count_access);				$this->assign('get_log_list',$get_log_list);				$this->assign('activity_preson_list',$activity_preson_list);			}else{				//圣诞节开门抽奖活动的统计				$condition_table=array(					'pigcms_extension_activity_record'=>'record',					'pigcms_extension_coupon_record'=>'coupon',					'pigcms_user'=>'user'				);				$condition_where = "record.pigcms_id=coupon.record_id and record.uid=user.uid and record.activity_id=$id";				import('@.ORG.system_page');				$condition_field = "record.pigcms_id,record.activity_id,record.time,record.giftname,record.uid,coupon.record_id,coupon.number,coupon.plate,user.uid,user.nickname,user.sex,user.phone";				$count_access = D('')->table($condition_table)->where($condition_where)->count();				$p=new Page($count_access,15,'page');				$order='record.time desc ';				$get_log_list=$p->show();				$activity_preson_list = D('')->table($condition_table)->where($condition_where)->field($condition_field)->order($order)->limit($p->firstRow .','.$p->listRows)->select();				//对参与人数的获得礼品类型进行统计				//礼物为现金红包的'_string'				/*$condition_where_cash['number'] = array('neq','');				$condition_where_cash['giftname'] = '现金红包';*/				$condition_where_cash ="record.pigcms_id=coupon.record_id and record.giftname='现金红包'";				$condition_table_cash = array(					'pigcms_extension_activity_record'=>'record',					'pigcms_extension_coupon_record'=>'coupon'				);				$count_person_cash = D('')->table($condition_table_cash)->where($condition_where_cash)->count();				$condition_field_cash = "sum(coupon.number) as money";				$condition_where_money = "giftname='现金红包' and record.pigcms_id=coupon.record_id";				//现金红包总的发出金额				$sum_money = D('')->table($condition_table_cash)->field($condition_field_cash)->where($condition_where_money)->find();				//礼物为现金优惠券（大头仔优惠券）				$condition_where_coupon = "record.pigcms_id=coupon.record_id and record.giftname='大头仔现金券'";				$count_person_coupon = D('')->table($condition_table_cash)->where($condition_where_coupon)->count();				//礼物为停车优惠券的				$condition_where_coupon_car = "record.pigcms_id=coupon.record_id and record.giftname='停车优惠券'";				$count_person_coupon_car = D('')->table($condition_table_cash)->where($condition_where_coupon_car)->count();				$gift_count =array(					'count_person_cash'=>$count_person_cash,					'sum_money'=>$sum_money,					'count_person_coupon'=>$count_person_coupon,					'count_person_coupon_car'=>$count_person_coupon_car				);				$this->assign('gift_count',$gift_count);				$this->assign('count_access',$count_access);				$this->assign('get_log_list',$get_log_list);				$this->assign('activity_preson_list_open',$activity_preson_list);			}		}		$this->display();	}	public function hotactivity_news(){		//获取所有活动的名称		$id = $_GET['activity_id'];		$database_extension_activity = D('Extension_activity');		$activity_list = $database_extension_activity->field("activity_id,name")->order("activity_id DESC")->select();		$this->assign('activity_list',$activity_list);		if(!empty($id)){			//获取活动的开始时间和结束时间			$database_extension_activity = D('Extension_activity');			$activity_list = $database_extension_activity->field("begin_time,name")->where(array('activity_id'=>$id))->find();			$begin_time=$activity_list['begin_time'];			$name = $activity_list['name'];			/*$begin_time = 1478707200;*///$activity_list['begin_time'];			//$activity_list['end_time'];			/*var_dump($activity_list);exit;*/			if($name == '双十一活动'){				//根据活动的执行的时间到user表里面查取活动人数等数据				$database_user = M('user');				//参与活动的人				/*$sql_preson = "select nickname,phone,sex,order_time from pigcms_user WHERE order_time>$begin_time and order_time<$end_time order BY order_time DESC limit 0,15"*/				import('@.ORG.system_page');	//引入分页				$time=array('gt',$begin_time);				$count_access = D('')->table(array('pigcms_user'=>'user'))->where(array("user.order_time"=>$time))->count();				$p=new Page($count_access,10,'page');				$activity_preson_list = $database_user->where(array("order_time"=>$time))->order("order_time desc")->limit($p->firstRow .','.$p->listRows)->select();				$get_log_list=$p->show();				$this->assign('count_access',$count_access);				$this->assign('get_log_list',$get_log_list);				$this->assign('activity_preson_list',$activity_preson_list);			}else{				//圣诞节开门抽奖活动的统计				$condition_table=array(					'pigcms_extension_activity_record'=>'record',					'pigcms_extension_coupon_record'=>'coupon',					'pigcms_user'=>'user'				);				$condition_where = "record.pigcms_id=coupon.record_id and record.uid=user.uid and record.activity_id=$id";				import('@.ORG.system_page');				$condition_field = "record.pigcms_id,record.activity_id,record.time,record.giftname,record.uid,coupon.record_id,coupon.number,coupon.plate,user.uid,user.nickname,user.sex,user.phone";				$count_access = D('')->table($condition_table)->where($condition_where)->count();				$p=new Page($count_access,15,'page');				$order='record.time desc ';				$get_log_list=$p->show();				$activity_preson_list = D('')->table($condition_table)->where($condition_where)->field($condition_field)->order($order)->limit($p->firstRow .','.$p->listRows)->select();				//对参与人数的获得礼品类型进行统计				//礼物为现金红包的'_string'				/*$condition_where_cash['number'] = array('neq','');				$condition_where_cash['giftname'] = '现金红包';*/				$condition_where_cash ="record.pigcms_id=coupon.record_id and record.giftname='现金红包'";				$condition_table_cash = array(					'pigcms_extension_activity_record'=>'record',					'pigcms_extension_coupon_record'=>'coupon'				);				$count_person_cash = D('')->table($condition_table_cash)->where($condition_where_cash)->count();				$condition_field_cash = "sum(coupon.number) as money";				$condition_where_money = "giftname='现金红包' and record.pigcms_id=coupon.record_id";				//现金红包总的发出金额				$sum_money = D('')->table($condition_table_cash)->field($condition_field_cash)->where($condition_where_money)->find();				//礼物为现金优惠券（大头仔优惠券）				$condition_where_coupon = "record.pigcms_id=coupon.record_id and record.giftname='大头仔现金券'";				$count_person_coupon = D('')->table($condition_table_cash)->where($condition_where_coupon)->count();				//礼物为停车优惠券的				$condition_where_coupon_car = "record.pigcms_id=coupon.record_id and record.giftname='停车优惠券'";				$count_person_coupon_car = D('')->table($condition_table_cash)->where($condition_where_coupon_car)->count();				$gift_count =array(					'count_person_cash'=>$count_person_cash,					'sum_money'=>$sum_money,					'count_person_coupon'=>$count_person_coupon,					'count_person_coupon_car'=>$count_person_coupon_car				);				$this->assign('gift_count',$gift_count);				$this->assign('count_access',$count_access);				$this->assign('get_log_list',$get_log_list);				$this->assign('activity_preson_list_open',$activity_preson_list);			}		}		$this->display();	}}