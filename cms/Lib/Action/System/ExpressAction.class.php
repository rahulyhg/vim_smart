<?php/* * 快递公司 * * @  Writers    Jaty * @  BuildTime  2014/12/21 16:50 *  */class ExpressAction extends BaseAction{    public function __construct()    {        parent::__construct();        $this->village_id = $_SESSION['system']['village_id'];    }	public function index(){		$database_express = D('Express');		$express_list = $database_express->field(true)->order('`sort` DESC,`id` ASC')->select();		$this->assign('express_list',$express_list);				$this->display();	}	public function index_news(){		$database_express = D('Express');		$express_list = $database_express->field(true)->order('`sort` DESC,`id` ASC')->select();		$this->assign('express_list',$express_list);		$this->display();	}	public function add(){		$this->assign('bg_color','#F3F3F3');		$this->display();	}	public function modify(){		if(IS_POST){			$_POST['add_time'] = $_SERVER['REQUEST_TIME'];			$database_express = D('Express');			if($database_express->data($_POST)->add()){				S('express_list',NULL);				$this->success('添加成功！');			}else{				$this->error('添加失败！请重试~');			}		}else{			$this->error('非法提交,请重新提交~');		}	}	public function edit(){		$this->assign('bg_color','#F3F3F3');		$database_express = D('Express');		$condition_express['id'] = intval($_GET['id']);		$express = $database_express->field(true)->where($condition_express)->find();        $staffArr = explode(',',$express['staff']);        $admin_str = '';        foreach ($staffArr as $v) {            $realname = D('admin')->where(array('id'=>$v))->find()['realname'];            if ($admin_str) {                $admin_str .= ','.$realname;            } else {                $admin_str .= $realname;            }        }        $this->assign('admin_str',$admin_str);		$this->assign('express',$express);		$this->display();	}    public function add_admin(){        $this->assign('bg_color','#F3F3F3');        if (IS_POST) {            $express_id = I('post.express_id');            $staffStr = '';            $arr = $_POST;            foreach ($arr as $k => $v) {                if ($k != 'express_id') {                    if ($staffStr) {                        $staffStr .= ','.$v;                    } else {                        $staffStr .= $v;                    }                }            }            $re = D('Express')->where(array('id'=>$express_id))->save(array('staff'=>$staffStr));            if ($re) {                $this->success('修改成功！');            } else {                $this->error('修改失败！请检查是否有过修改后重试~');            }        } else {            //求出该快递公司绑定的工作人员            $condition_express['id'] = intval($_GET['id']);            $express = D('Express')->field(true)->where($condition_express)->find();            $staffArr = explode(',',$express['staff']);            $bigArr = D('house_village')->field(array('village_id','village_name'))->select();            $map['_string']="FIND_IN_SET(76,role_id)";//tid为表字段            foreach ($bigArr as $k=>&$v) {                $village_id = $v['village_id'];                $adminArr = D('admin')->field(array('id','village_id','realname','phone'))->where($map)->where(array('village_id'=>$village_id))->select();                foreach ($adminArr as $sv) {                    $v['son'][] = $sv;                }                if (!$v['son']) {                    unset($bigArr[$k]);                }            }            unset($v);//        dump($bigArr);exit;            $this->assign('bigArr',$bigArr);            $this->assign('staffArr',$staffArr);            $this->assign('express_id',$condition_express['id']);            $this->display();        }    }	public function amend(){		if(IS_POST){			$_POST['add_time'] = $_SERVER['REQUEST_TIME'];			$database_express = D('Express');			if($database_express->data($_POST)->save()){				S('express_list',NULL);				$this->success('修改成功！');			}else{				$this->error('修改失败！请检查是否有过修改后重试~');			}		}else{			$this->error('非法提交,请重新提交~');		}	}	public function del(){		if(IS_POST){			$database_express = D('Express');			$condition_express['id'] = intval($_POST['id']);			if($database_express->where($condition_express)->delete()){				S('express_list',NULL);				$this->success('删除成功！');			}else{				$this->error('删除失败！请重试~');			}		}else{			$this->error('非法提交,请重新提交~');		}	}    /**     * 某一快递公司在各建筑的柜子相关信息展示     * @author zhukeqin     * @time 2018年3月15日     */    public function expressage_locker_info()    {        $company_id=I('get.id');        $field = array(            'p.*',            'c.name',            'v.village_name'        );        $info = M('expressage_company_village')            ->alias('p')            ->field($field)            ->join('LEFT JOIN __EXPRESS__ c on c.id=p.company_id')            ->join('LEFT JOIN __HOUSE_VILLAGE__ v on v.village_id=p.village_id')            ->where(array('p.company_id'=>$company_id))            ->select();        $express=M('express')->where(array('id'=>$company_id))->find();        $this->assign('company_id',$company_id);        $this->assign('express',$express);        $this->assign('info',$info);        $this->display();	}    /**     * 修改快递柜相关信息     * @author zhukeqin     * @time 2018年3月20日     */    public function expressage_locker_edit()    {        if(IS_POST){            $id=I('post.id');            $data=array(                'village_id'=>I('post.village_id'),                'expressage_locker_id'=>I('post.expressage_locker_id'),                'expressage_locker_count'=>I('post.expressage_locker_count'),                'status'=>I('post.status')            );            //判断是否是新增快递柜            if(empty($id)){                $data['company_id']=I('post.company_id');               M('expressage_company_village')->data($data)->add();                $this->success('新增成功！');            }else{                M('expressage_company_village')->data($data)->where(array('id'=>$id))->save();                $this->success('修改成功！');            }            die;        }else{            //获取get参数 用来读取对应的快递柜信息            $id=I('get.id');            $company_id=I('get.company_id');            $field = array(                'p.*',                'c.name',                'v.village_name'            );            $info = M('expressage_company_village')                ->alias('p')                ->field($field)                ->join('LEFT JOIN __EXPRESS__ c on c.id=p.company_id')                ->join('LEFT JOIN __HOUSE_VILLAGE__ v on v.village_id=p.village_id')                ->where(array('p.id'=>$id))                ->find();            $village_info=M('house_village')->select();            if(empty($id)){                $id=0;            }            if(empty($company_id)){                $company_id=0;            }            $this->assign('id',$id);            $this->assign('company_id',$company_id);            $this->assign('village_info',$village_info);            $this->assign('info',$info);        }        $this->display();	}	/*******************************************************包裹管理Basic*******************************************/    /**     * 公司选择     * @author 祝君伟     * @time 2018年1月12日 17:21:28     */	public function choose_express_company_news()    {        $model = new PackageModel();        $list = $model->getCompany_list();        //vd($list);        $this->assign('list',$list);        $this->display();    }    /**     * 包裹入库     * @author 祝君伟     * @time 2018年1月12日 17:21:28     */	public function package_in_database()    {        if(IS_POST){            $phone = I('post.phone');            $name = I('post.name');            $waybill_number = I('post.waybill_number');            $model = new PackageModel();            $cid = I('post.cid');            if(!$waybill_number) $this->error('运单号不能为空',U('package_in_database',array('cid'=>$cid)));            if(!$phone) $this->error('手机不能为空',U('package_in_database',array('cid'=>$cid)));            $check_status = $model->waybillNumber_check($waybill_number,$cid);            if($check_status == 2)            {                $this->error('运单号必须为数字，请对准条形码扫描',U('package_in_database',array('cid'=>$cid,'type'=>0)));            }            elseif ($check_status == 3)            {                $this->error('运单号有误，请对准条形码扫描',U('package_in_database',array('cid'=>$cid,'type'=>0)));            }            else            {                /**                 * 拼接取货码                 * 第一位 ： 快递公司编号                 *         -                 * 第二位 ： 暂时固定值  =  1                 *         -                 * 后四位 ： 订单编号后四位                 *                 * exp ：  5-1-6359                 */                $receipt_code = $cid.'-1-'.substr($waybill_number,-4);                $is_in_data = M('package')->getByWaybill_number($waybill_number);                //vd($is_in_data);exit;                if($is_in_data['status'] === '0')                {                    $this->error('该货物已经入库',U('package_in_database',array('cid'=>$cid)));                }                else if($is_in_data['status'] == 1)                {                    $this->error('该货物已经出库',U('package_in_database',array('cid'=>$cid)));                }                else if($is_in_data['status'] == 2)                {                    $this->error('该货物顾客拒收',U('package_in_database',array('cid'=>$cid)));                }                else if($is_in_data['status'] == 3)                {                    $this->error('该货物站点拒签',U('package_in_database',array('cid'=>$cid)));                }                else if($is_in_data['status'] == 4)                {                    $this->error('该货物已退件',U('package_in_database',array('cid'=>$cid)));                }                else if($is_in_data === null)                {                    $is_user_in_data = M('expressage_user')->getByPhone($phone);                    if(!$is_user_in_data)                    {                        $userDate = array(                            'name'     =>  $name?:'匿名人员',                            'phone'    =>  $phone                        );                        $userRes = M('expressage_user')->data($userDate)->add();                    }                    else                    {                        $userRes = $is_user_in_data['pigcms_id'];                        M('expressage_user')->where(array('pigcms_id'=>$userRes))->setInc('active_value',1);                    }                    if($userRes)                    {                        $packageDate = array(                            'waybill_number'   =>  $waybill_number,                            'cid'              =>  $cid,                            'aid'              =>  $userRes,                            'in_package_time'  =>  time(),                            'receipt_code'     =>  $receipt_code,                            'admin_id'         =>  session('system.id')                        );                        $packageRes =  M('package')->data($packageDate)->add();                        if($packageRes)                        {                            //发送短信                            //关闭短信通知                            //$smsRes = $this->SmsCodeverify($phone,$receipt_code);                            $smsRes=1;                            if($smsRes==1)                            {                                $res = M('package')->where(array('waybill_number'=>$waybill_number))->data(array('status_sms'=>1))->save();                                $this->redirect(U('package_control_news',array('cid'=>$cid,'type'=>0)));                            }else{                                $this->error('短信发送失败，请稍后核对信息之后手动发送',U('package_control_news',array('cid'=>$cid,'type'=>0)));                            }                        }                    }else{                        $this->error('入库出错，请联系系统管理员',U('package_in_database',array('cid'=>$cid)));                    }                }            }        }else{            $cid = I('get.cid');            $company_name = M('expressage_company')->find($cid)['company_name'];            $this->assign('company_name',$company_name);            $this->display();        }    }    public function data_bank_news()    {        $model = new PackageModel();        $list = $model->get_package_list();        $this->assign('list',$list);        $this->display();    }    /**     * 改变快递发送的状态     */    public function change_status()    {        $id = I('post.id');        $status = I('post.status');        if($id&&$status)        {            $res = M('package')->where(array('id'=>$id))->data(array('status'=>$status,'out_package_time'=>time()))->save();            if($res)            {                echo 1;            }            else            {                echo 2;            }        }    }    /**     * ajax用户的信息，传到前台     */    public function ajax_user_info()    {	    $phone = I('post.phone');	    $userInfo = M('expressage_user')->where(array('phone'=>$phone))->find();	    if($userInfo)        {            echo $userInfo['name'];        }        else        {            $userBindInfo = M('house_village_user_bind')->where(array('phone'=>$phone))->find();            if($userBindInfo)            {                echo $userBindInfo['name'];            }        }    }    /* 发送手机验证码    * @time 2018-01-12    * @author	曾梦飞    */    protected function SmsCodeverify($phone,$vcode){        $company_id = substr($vcode,0,1);        $packagemodel=new PackageModel();        $company_name=$packagemodel->getCompany_info($company_id)['company_name'];        //$company_name = M('expressage_company')->find($company_id)['company_name'];        //require(LIB_PATH.'ORG/sms/sms_aliyun/vendor/autoload.php');        $model=new Sms_aliyunModel();        $request=$model->sendSms_expressage($phone,$vcode,$company_name,'广发银行大厦立体车库1F');        /*$content='货号'. $vcode . '您好，您的'.$company_name.'已经到达广发银行大厦立体车库1F快递收发室，请凭取货码取件。（取件时间：工作日上午8:30-11:30 下午2:00-17:30）请熟知，谢谢！';        //$content='您的取件码是：'. $vcode . '。请凭该取件码到广发大厦立体车库一楼快递收发室取件，请您尽快取件,谢谢。';        $post_data=array(			//短信发送所须参数            'userid'=>'13296',            'account'=>C('config.sms_uid'),            'password'=>C('config.sms_pwd'),            'content'=>$content,            'mobile'=>$phone,            'sendtime'=>date('Y-m-d H:i:s'), //此处不可以写成时间戳形式            'action'=>'send'        );        $url='http://www.duanxin10086.com/sms.aspx';        $o='';        foreach ($post_data as $k=>$vs){            $o.="$k=".$vs.'&';        }        $post_data=substr($o,0,-1);        $ch = curl_init();        curl_setopt($ch, CURLOPT_POST, 1);        curl_setopt($ch, CURLOPT_HEADER, 0);        curl_setopt($ch, CURLOPT_URL,$url);        curl_setopt($ch, CURLOPT_POSTFIELDS, $post_data);        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); //如果需要将结果直接返回到变量里，那加上这句。        $str = curl_exec($ch);        $xml=simplexml_load_string($str);*/        $packagemodel=new PackageModel();        $package_info=$packagemodel->getPackage_list_search(array('receipt_code'=>$vcode))['0'];        $data=array(            'mer_id'=>$package_info['id'],            'store_id'=>'66',            'uid'=>'0',            'phone'=>$phone,            'text'=>$vcode.','.$company_name.',广发银行大厦立体车库1F',            'time'=>time(),            'sendto'=>'SmsCodeverify',            'type'=>'expressage',            'bizid'=>$request->BizId);        if($request->Code=='OK'){            $data['status']='0';            $res = M('sms_record')->add($data);            return 1;        }else{            $data['status']='1';            $data['remark']=$request->Code;            $res = M('sms_record')->add($data);            return 2;        }    }    /*  包裹出库     * @time 2018-01-12     * @author	曾梦飞     */    public function delivery_news() {        $this->display();    }    /*  包裹出库验证并更新数据库     * @time 2018-01-12     * @author	曾梦飞     */    public function delivery_sub() {        $code = I('post.code');        $packageArr = D('package')->where(array('waybill_number'=>$code))->find();        if (!empty($packageArr)) {            $status = $packageArr['status'];            if ($status == 0) {                $out_package_time = time();                $re = D('package')->where(array('waybill_number'=>$code))->save(array('status'=>1,'out_package_time'=>$out_package_time,'status_sms'=>1));                if ($re) {                    $this->redirect(U('delivery_news'));                } else {                    $this->error('更新数据库失败',U('delivery_news'),1);                }            } elseif ($status == 1) {                $this->error('该货物已经出库了',U('delivery_news'),1);            } elseif ($status == 2) {                $this->error('该顾客拒收',U('delivery_news'),1);            } elseif ($status == 3) {                $this->error('该站点拒签',U('delivery_news'),1);            } elseif ($status == 4) {                $this->error('该货物已退件',U('delivery_news'),1);            } else {                $this->error('其他原因',U('delivery_news'),1);            }        } else {            $this->error('没有找到取货号',U('delivery_news'),1);        }    }    /**********************************************包裹管理1.0********************************************/    /**     * 快件管理页面old     */    public function package_control_news_bck()    {        $model = new PackageModel();        $cid = I('get.cid')?I('get.cid'):1;        $d_cid = I('get.d_cid')?I('get.d_cid'):0;        $status = I('get.status');        $status = isset($status)?$status:false;        $keyword = I('get.keyword');        //vd($status);exit;        $company_name = M('expressage_company')->find($cid)['company_name'];        $company_list = $model->getAllCompany_list();        $list = $model->getPackage_list(0,$d_cid,$keyword,$status);        //vd(M()->_sql());exit;        $this->assign('list',$list);        $this->assign('cid',$cid);        $this->assign('company_list',$company_list);        $this->assign('company_name',$company_name);        $this->display();    }    /**     * 无刷新版本快件管理主页     */    public function package_control_news()    {        $time_now=time();        $time_begin=$beginToday=mktime(0,0,0,date('m'),date('d'),date('Y'));        $model = new PackageModel();        $cid = I('get.cid')?I('get.cid'):1;        $company_name = M('expressage_company')->find($cid)['company_name'];        $company_list = $model->getAllCompany_list();        foreach ($company_list as $value){            $company_list_count[$value['company_name']]['in']=$model->getPackage_list_search_count(array('in_package_time_max'=>$time_now,'in_package_time_mix'=>$time_begin,'cid'=>$value['company_id']));            $company_list_count[$value['company_name']]['out']=$model->getPackage_list_search_count(array('in_package_time_max'=>$time_now,'in_package_time_mix'=>$time_begin,'status'=>array('neq','0'),'cid'=>$value['company_id']));        }        $list = '';        $outList = '';        $userList = $model->getUser_list();        $count_in=$model->getPackage_list_search_count(array('in_package_time_max'=>$time_now,'in_package_time_mix'=>$time_begin));        $count_out=$model->getPackage_list_search_count(array('out_package_time_max'=>$time_now,'out_package_time_mix'=>$time_begin));        //读取对应大厦的滞留件配置，如没有则默认3天        $village_config=$model->get_village_config($this->village_id);        if(empty($village_config['retention_days'])){            $village_config['retention_days']=3;        }        $retention_time=$time_begin-$village_config['retention_days']*60*60*24;        $count_retention=$model->getPackage_list_search_count(array('in_package_time_max'=>$retention_time,'in_package_time_mix'=>100,'status'=>0));        $count_list=array(            'count_in'=>array('name'=>'今日已入库','num'=>$count_in,'color'=>'green'),            'count_out'=>array('name'=>'今日已出库','num'=>$count_out,'color'=>'blue'),            'count_retention'=>array('name'=>'滞留件','num'=>$count_retention,'color'=>'red')        );        //获取近段时间发送失败次数以及处理失败次数        $search['time']=array(array('egt',$retention_time),array('elt',time()));        $search['status']='1';        $sms_failed['num']=M('sms_record')->where($search)->distinct('pigcms_id')->count();        $sms_failed['now']=$model->getPackage_list_search_count(array('in_package_time_max'=>time(),'in_package_time_mix'=>$retention_time,'status_sms'=>0,'status'=>0));        $sms_failed['last']=$sms_failed['num']-$sms_failed['now'];        $this->assign('list',$list);        $this->assign('out_list',$outList);        $this->assign('userList',$userList);        $this->assign('company_list',$company_list);        $this->assign('company_name',$company_name);        $this->assign('count_list',$count_list);        $this->assign('company_list_count',$company_list_count);        $this->assign('sms_failed',$sms_failed);        $this->display();    }    /**     * 包裹入库     */    public function  express_in_database()    {        $phone = I('post.phone');        $name = I('post.name');        $waybill_number = I('post.waybill_number');        $model = new PackageModel();        //var_dump($_POST);exit;        $cid = I('post.cid');        if($cid==0||empty($cid)) $this->error('快递公司不能为空',U('package_control_news',array('cid'=>$cid,'type'=>0)));        if(!$waybill_number) $this->error('运单号不能为空',U('package_control_news',array('cid'=>$cid,'type'=>0)));        if(!$phone) $this->error('手机不能为空',U('package_control_news',array('cid'=>$cid,'type'=>0)));        $check_status = $model->waybillNumber_check($waybill_number,$cid);        if($check_status == 2)        {            $this->error('运单号必须为数字，请对准条形码扫描',U('package_control_news',array('cid'=>$cid,'type'=>0)));        }        elseif ($check_status == 3)        {            $this->error('运单号有误，请对准条形码扫描',U('package_control_news',array('cid'=>$cid,'type'=>0)));        }        else        {            /**             * 拼接取货码             * 第一位 ： 快递公司编号             *         -             * 第二位 ： 暂时固定值  =  1             *         -             * 后四位 ： 订单编号后四位             *             * exp ：  5-1-6359             */            $receipt_code = $cid.'-1-'.substr($waybill_number,-4);            $is_in_data = M('package')->getByWaybill_number($waybill_number);            //vd($is_in_data);exit;            if($is_in_data['status'] === '0')            {                $this->error('该货物已经入库',U('package_control_news',array('cid'=>$cid,'type'=>0)));            }            else if($is_in_data['status'] == 1)            {                $this->error('该货物已经出库',U('package_control_news',array('cid'=>$cid,'type'=>0)));            }            else if($is_in_data['status'] == 2)            {                $this->error('该货物顾客拒收',U('package_control_news',array('cid'=>$cid,'type'=>0)));            }            else if($is_in_data['status'] == 3)            {                $this->error('该货物站点拒签',U('package_control_news',array('cid'=>$cid,'type'=>0)));            }            else if($is_in_data['status'] == 4)            {                $this->error('该货物已退件',U('package_control_news',array('cid'=>$cid,'type'=>0)));            }            else if($is_in_data === null)            {                $is_user_in_data = M('expressage_user')->getByPhone($phone);                if(!$is_user_in_data)                {                    $userDate = array(                        'name'     =>  $name?:'匿名人员',                        'phone'    =>  $phone                    );                    $userRes = M('expressage_user')->data($userDate)->add();                }                else                {                    $userRes = $is_user_in_data['pigcms_id'];                }                if($userRes)                {                    $packageDate = array(                        'waybill_number'   =>  $waybill_number,                        'cid'              =>  $cid,                        'aid'              =>  $userRes,                        'in_package_time'  =>  time(),                        'receipt_code'     =>  $receipt_code,                        'admin_id'         =>  session('system.id')                    );                    $packageRes =  M('package')->data($packageDate)->add();                    if($packageRes)                    {                        //发送短信                        //暂时关闭短信通知                        //$smsRes = $this->SmsCodeverify($phone,$receipt_code);                        $smsRes=1;                        if($smsRes==1)                        {                            $res = M('package')->where(array('waybill_number'=>$waybill_number))->data(array('status_sms'=>1))->save();                            $this->redirect(U('package_control_news',array('cid'=>$cid,'type'=>0)));                        }else{                            $this->error('短信发送失败，请稍后核对信息之后手动发送',U('package_control_news',array('cid'=>$cid,'type'=>0)));                        }                    }                }else{                    $this->error('入库出错，请联系系统管理员',U('package_control_news',array('cid'=>$cid,'type'=>0)));                }            }        }    }        /**     * ajax 的包裹入库     */    public function ajax_in_database()    {        $phone = I('post.phone');        $name = I('post.name');        $waybill_number = I('post.waybill_number');        $model = new PackageModel();        //var_dump($_POST);exit;        $cid = I('post.cid');        if($cid==0||empty($cid)) $this->err('快递公司不能为空');        if(!$waybill_number) $this->err('运单号不能为空');        if(!$phone) $this->err('手机不能为空');        if(strlen($phone)!=11) $this->err('手机号必须为11位');        if(!is_numeric($phone)) $this->err('手机号必须为纯数字');        $check_status = $model->waybillNumber_check($waybill_number,$cid);        //适配京东快递  去除必须为数字的限制        /*if($check_status == 2)        {            $this->err('运单号必须为数字，请对准条形码扫描');        }        else*/if ($check_status == 3)        {            $this->err('运单号有误，请对准条形码扫描');        }        else        {            /**             * 拼接取货码             * 第一位 ： 快递公司编号             *         -             * 第二位 ： 暂时固定值  =  1             *         -             * 后四位 ： 订单编号后四位             *             * exp ：  5-1-6359             */            $express_info=$model->getCompany_info($cid);            $check_waybill_number=strpos($waybill_number,'-');            if($express_info['company_name']!='京东快递') {//京东快递单添加额外的取件码设置策略 by zhukeqin                $receipt_code = $cid . '-1-' . substr($waybill_number, -4);            }else{                $receipt_code_start=$check_waybill_number-4;                $receipt_code = $cid . '-1-' . substr($waybill_number,$receipt_code_start,4);            }            $is_in_data = M('package')->getByWaybill_number($waybill_number);            //vd($is_in_data);exit;            if($is_in_data['status'] === '0')            {                $this->err('该货物已经入库');            }            else if($is_in_data['status'] == 1)            {                $this->err('该货物已经出库');            }            else if($is_in_data['status'] == 2)            {                $this->err('该货物顾客拒收');            }            else if($is_in_data['status'] == 3)            {                $this->err('该货物站点拒签');            }            else if($is_in_data['status'] == 4)            {                $this->err('该货物已退件');            }            else if($is_in_data === null)            {                $is_user_in_data = M('expressage_user')->getByPhone($phone);                if(!$is_user_in_data)                {                    $userDate = array(                        'name'     =>  $name?:'匿名人员',                        'phone'    =>  $phone                    );                    $userRes = M('expressage_user')->data($userDate)->add();                }                else                {                    if($is_user_in_data['status'] == 1)                    {                        $this->err('该人员是黑名单人员，不收取其快件');                    }                    else                    {                        $userRes = $is_user_in_data['pigcms_id'];                        M('expressage_user')->where(array('pigcms_id'=>$userRes))->setInc('active_value',1);                    }                }                if($userRes)                {                    $packageDate = array(                        'waybill_number'   =>  $waybill_number,                        'cid'              =>  $cid,                        'aid'              =>  $userRes,                        'in_package_time'  =>  time(),                        'receipt_code'     =>  $receipt_code,                        'admin_id'         =>  session('system.id')                    );                    $packageRes =  M('package')->data($packageDate)->add();                    if($packageRes)                    {                        //发送短信                        $smsRes = $this->intelligence_choose_send_type($packageRes);                        $packageInfo = $model->getPackageInfo($packageRes);                        $data = '<tr class="even" role="row"><td>'.$packageInfo['waybill_number'].'</td><td>'.$packageInfo['company_name'].'</td><td>'.$packageInfo['phone'].'</td><td>'.$packageInfo['name'].'</td><td style="color: orange">'.$packageInfo['receipt_code'].'</td><td><span style="color: blue">已到站</span><br/>'.date('Y-m-d H:i:s',$packageInfo['in_package_time']).'</td><td><button class="btn btn-xs btn-primary" onclick="changePackageStatus('.$packageRes.',1)">提货</button><button class="btn green btn-xs" type="button" onclick="sendSms('.$phone.',\''.$receipt_code.'\','.$packageRes.')">短信提醒</button><div class="btn-group"><button type="button" class="btn btn-xs btn-primary">更多</button><button type="button" class="btn btn-xs btn-primary dropdown-toggle " data-toggle="dropdown"><i class="fa fa-angle-down"></i></button><ul class="dropdown-menu" role="menu"><li><a href="javascript:;" onclick="changePackageStatus('.$packageRes.',2)"> 顾客拒收 </a></li><li><a href="javascript:;" onclick="changePackageStatus('.$packageRes.',3)"> 站点拒签 </a></li><li><a href="javascript:;" onclick="changePackageStatus('.$packageRes.',4)"> 退件 </a></li></ul></div></td></tr>';                        if($smsRes==1)                        {                            $res = M('package')->where(array('waybill_number'=>$waybill_number))->data(array('status_sms'=>1))->save();                            $this->suc('成功',$data);                        }else{                            $this->err('短信发送失败，请稍后核对信息之后手动发送');                        }                    }                }else{                    $this->err('入库出错，请联系系统管理员');                }            }        }    }    /**     * ajax 包裹出库     */    public function ajax_out_database()    {        $code = I('post.code');        $model = new PackageModel();        $packageArr = D('package')->where(array('waybill_number'=>$code))->find();        if (!empty($packageArr)) {            $status = $packageArr['status'];            $packageInfo = $model->getPackageInfo($packageArr['id']);            if ($status == 0) {                $out_package_time = time();                $re = D('package')->where(array('waybill_number'=>$code))->save(array('status'=>1,'out_package_time'=>$out_package_time,'status_sms'=>1));                if ($re) {                    $data = '<tr><td> '.$packageInfo['waybill_number'].' </td><td> '.$packageInfo['company_name'].' </td><td> '.$packageInfo['name'].' </td><td style="color: orange"> '.$packageInfo['receipt_code'].' </td><td>'.date('Y-m-d H:i:s',$out_package_time).'</td><td> '.$packageInfo['realname'].' </td><td><a class="btn dark btn-xs" data-toggle="modal" data-target="#common_modal" href="'.U('express_detail',array('id'=>$packageArr['id'])).'">详细</a></td><div class="btn-group"><button type="button" class="btn btn-xs btn-primary">更多</button><button type="button" class="btn btn-xs btn-primary dropdown-toggle " data-toggle="dropdown"><i class="fa fa-angle-down"></i></button><ul class="dropdown-menu" role="menu"><li><a href="javascript:;" onclick="changePackageStatus('.$packageArr['id'].',4)"> 顾客拒收 </a></li><li><a href="javascript:;" onclick="changePackageStatus('.$packageArr['id'].',4)"> 站点拒签 </a></li><li><a href="javascript:;" onclick="changePackageStatus('.$packageArr['id'].',4)"> 退件 </a></li></ul></div>';                    $this->suc('成功更新',$data);                } else {                    $this->err('更新数据库失败');                }            } elseif ($status == 1) {                $this->err('该货物已经出库了');            } elseif ($status == 2) {                $this->err('该顾客拒收');            } elseif ($status == 3) {                $this->err('该站点拒签');            } elseif ($status == 4) {                $this->err('该货物已退件');            } else {                $this->err('其他原因');            }        } else {            $this->err('没有找到取货号');        }    }    /**     * 包裹详细信息     * @param $id   包裹的id     */    public function express_detail($id)    {        $model = new PackageModel();        $info = $model->getPackageInfo($id);        $this->assign('info',$info);        $this->display();    }    /**     * 数据中心     */    public function package_info_list()    {        $model = new PackageModel();        $list = $model->getPackage_list_search('','0',10);        $company_list = $model->getAllCompany_list();        $company_count = $model->count_express_company();        $this->assign('list',$list);        $this->assign('company_list',$company_list);        $this->assign('company_count',$company_count);        $this->display();        /*$model = new PackageModel();        $list = $model->get_package_list();        $company_list = $model->getAllCompany_list();        $company_count = $model->count_express_company();        $this->assign('list',$list);        $this->assign('company_list',$company_list);        $this->assign('company_count',$company_count);        $this->display();*/    }    /**     * 滞留件列表     */    public function package_info_list_retention()    {        $model = new PackageModel();        //读取对应大厦的滞留件配置，如没有则默认3天        $village_config=$model->get_village_config($this->village_id);        if(empty($village_config['retention_days'])){            $village_config['retention_days']=3;        }        $time_begin=mktime(0,0,0,date('m'),date('d'),date('Y'));        $retention_time=$time_begin-$village_config['retention_days']*60*60*24;        $count_retention=$model->getPackage_list_search(array('in_package_time_max'=>$retention_time,'in_package_time_mix'=>100,'status'=>0));        $company_list = $model->getAllCompany_list();        foreach ($company_list as $value){            $company_list_count[$value['company_name']]=$model->getPackage_list_search_count(array('in_package_time_max'=>$retention_time,'in_package_time_mix'=>100,'cid'=>$value['company_id'],'status'=>0));        }        $this->assign('company_list_count',$company_list_count);        $this->assign('list',$count_retention);        $this->display();    }    public function change_date() {        $month = I('post.ym');        $status = I('post.status');        $start_time = strtotime($month);//指定月份月初时间戳        $end_time = mktime(23, 59, 59, date('m', strtotime($month))+1, 00);//指定月份月末时间戳        $map['in_package_time']  = array('between',array($start_time,$end_time));        if ($status == '已到站') {            $map['status'] = array('eq',0);        } elseif ($status == '已提货') {            $map['status'] = array('eq',1);        }        $returnArray = array();        $companyArray = M('expressage_company')->where(array('status'=>0))->select();        if(is_array($companyArray))        {            foreach ($companyArray as $value)            {//                $thisNumber = M('package')->where(array('cid'=>$value['company_id']))->count();                $thisNumber = M('package')->where(array('cid'=>$value['company_id']))->where($map)->count();                $returnArray[$value['company_name']] = $thisNumber;            }        }        else        {            return false;        }        echo json_encode($returnArray);    }    /**     * 智能选择发送类型     * @param $packageId     * @return bool|int     */    protected function intelligence_choose_send_type($packageId)    {        $model = new PackageModel();                $is_auto = $model->get_config()['express_is_intelligence_choose'];        $packageInfo = $model->getPackageInfo($packageId);        $package_send_sms=M('config')->where(array('name'=>'package_send_sms'))->find();        if($is_auto == 1)        {            if($packageInfo['openid']=='')            {                //$res = $this->SmsCodeverify($packageInfo['phone'],$packageInfo['receipt_code']);            }            else if(preg_match("/^ohg/",$packageInfo['openid']))            {                $res = $this->send_template($packageId);                if ($package_send_sms['value']==1) {                    //$res = $this->SmsCodeverify($packageInfo['phone'], $packageInfo['receipt_code']);                }            }            else            {                //$res = $this->SmsCodeverify($packageInfo['phone'],$packageInfo['receipt_code']);            }        }        else        {            //$res = $this->SmsCodeverify($packageInfo['phone'],$packageInfo['receipt_code']);        }        return $res;    }    /**     * 包裹出库     */    public function express_out_database() {        $code = I('post.code');        $packageArr = D('package')->where(array('waybill_number'=>$code))->find();        if (!empty($packageArr)) {            $status = $packageArr['status'];            if ($status == 0) {                $out_package_time = time();                $re = D('package')->where(array('waybill_number'=>$code))->save(array('status'=>1,'out_package_time'=>$out_package_time,'status_sms'=>1));                if ($re) {                    $this->redirect(U('package_control_news',array('type'=>1)));                } else {                    $this->error('更新数据库失败',U('package_control_news',array('type'=>1)),1);                }            } elseif ($status == 1) {                $this->error('该货物已经出库了',U('package_control_news',array('type'=>1)),1);            } elseif ($status == 2) {                $this->error('该顾客拒收',U('package_control_news',array('type'=>1)),1);            } elseif ($status == 3) {                $this->error('该站点拒签',U('package_control_news',array('type'=>1)),1);            } elseif ($status == 4) {                $this->error('该货物已退件',U('package_control_news',array('type'=>1)),1);            } else {                $this->error('其他原因',U('package_control_news',array('type'=>1)),1);            }        } else {            $this->error('没有找到取货号',U('package_control_news',array('type'=>1)),1);        }    }    /**     * 微信自动绑定     */    public function ajax_bind_weChat()    {        $model = new PackageModel();        $userArray = M('expressage_user')->select();        $res = $model->auto_bind_nickname($userArray);        if($res!== false)        {            echo $res;        }        else        {            echo '999';        }    }    /**     * ajax 发送短信     */    public function ajax_send_sms(){        $phone = I('post.phone');        $vcode = I('post.receipt_code');        $id = I('post.id');        $info = M('package')->find($id);        //去除只能发送一次的限制 BY zhukeqin        /*if($info['is_send_sms']==1)        {            echo 3;        }else        {*/        //关闭短信通知        //$request=$this->SmsCodeverify($phone,$vcode);        $request=1;        if($request==1){            M('package')->where(array('id'=>$id))->data(array('status_sms'=>1))->save();            echo '1';        }else{            echo '2';        }        /*}*/    }    /**     * 未成功发送短信的通过电话联系后手动完成     * @author zhukeqin     * @return int     */    public function ajax_send_phone()    {        $model=new PackageModel();        $id=I('post.id');        if(!empty($id)){            $package_info=$model->getPackage_list_search(array('id'))['0'];            if($package_info['status_sms']==0){                M('package')->where(array('id'=>$id))->data(array('status_sms'=>1))->save();                echo '1';            }else{                echo '2';            }        }else{            echo '3';        }    }    /*  * 微信昵称自动完成提供数据方法  * */    public function ajax_to_autocomplete(){        $keyword = I('get.query');        //制作查询语句        $map['nickname']=array('like','%'.$keyword.'%');        $keyword_array = M('user')->where($map)->limit(5)->order('uid desc')->select();        foreach ($keyword_array as $value){            $result_array[] =array(                'label'=>$value['nickname'],            );        }        echo json_encode($result_array);    }    /**     * 拉黑     */    public function see_you_in_blacklist()    {        $id = I('post.id');        if(!$id) exit(2);        $res = M('expressage_user')->where(array('pigcms_id'=>$id))->data(array('status'=>1))->save();        if($res){            echo 1;        }else{            echo 2;        }    }    public function bind_weChat()    {        if(IS_POST)        {            $id = I('post.id');            $nickname = I('post.nickname');            $uid = M('user')->where(array('nickname'=>$nickname))->find()['uid'];            if($uid)            {                $res = M('expressage_user')->where(array('pigcms_id'=>$id))->save(array('uid'=>$uid));                if($res)                {                    echo 1;                }                else                {                    echo 2;                }            }            else            {                echo 3;            }        }        else        {            $id = I('get.id');            $userInfo = M('expressage_user')->find($id);            $this->assign('userInfo',$userInfo);            $this->display();        }    }    /**     * 发送快递模版消息     * @param $packageId     * @return bool     */    public function send_template($packageId)    {        $wechat = new WechatModel();        $model = new PackageModel();        $packageInfo = $model->getPackageInfo($packageId);        $url=C('WEB_DOMAIN').'/wap.php?&g=Wap&c=Express&a=express_detail&id='.$packageId;        //流程审批提醒模板ID        $tpl_id = "CoBIh-8pk7EZx0IJ7MHY69-G9_725Iq_w28Ai5ZZ3Ks";        $data = array(            'first'=>array(                'value'=>"您的快件已经到达广发银行大厦立体车库1F快递收发室，请凭取件码取件。（取件时间：工作日上午8:30-11:30 下午2:00-17:30）请熟知，谢谢！",                'color'=>"#029700",            ),            'keyword1'=>array(                'value'=>$packageInfo['receipt_code'],                'color'=>"#000000",            ),            'keyword2'=>array(                'value'=>$packageInfo['waybill_number'],//人                'color'=>"#000000",            ),            'keyword3'=>array(                'value'=>$packageInfo['company_name'],                'color'=>"#000000",            ),            'keyword4'=>array(                'value'=>'18056092778',                'color'=>"#000000",            ),            /*'remark'=>array(                'value'=>'请凭取件码到广发银行大厦立体车库1F快递收发室取件',                'color'=>"#000000",            )*/        );        if($packageInfo['openid']){            $res = $wechat->send_tpl_message($packageInfo['openid'], $tpl_id, $url, $data,'','3');            if($res['errcode']!==0){                //TODO::与用户方逻辑无关，暂不提醒，应记录在日志系统当中                // $this->error("推送消息失败");                return 2;            }else{                return 1;            }        }else{            return 2;        }    }    /*ajax分页获取包裹信息    @author zhukeqin    @return json*/    public function ajax_package_list(){        $model = new PackageModel();        $start=I('post.start');        $length=I('post.length');        //datatable适配  -1则代表显示全部信息        if($length==-1){            unset($length);        }        $search_value=I('post.search');        //匹配字符串  查看搜索条件是否是格式化日期        preg_match('/\d{4}(\-|\/|.)\d{1,2}\1\d{1,2}/',$search_value['value'],$search_time);        if(empty($search_time)) {            if(!empty($search_value['value'])&&$search_value['value']!=' ') {                switch ($search_value['value']) {                    case '已到站':                        $search['status'] = 0;                        $search['in_package_time_mix']=1;                        break;                    case '已提货':                        $search['status'] = 1;                        $search['in_package_time_out']=1;                        break;                    default:                        $search['search_dim'] = $search_value['value'];                };            }            $list = $model->getPackage_list_search($search, $start, $length);            $list_dimcount = $model->getPackage_list_search_count($search);        }else{            $search_time=strtotime($search_time['0']);            $search_time_end=$search_time+24*3600;            $search=array('in_package_time_mix'=>$search_time,'in_package_time_max'=>$search_time_end);            $list = $model->getPackage_list_search($search, $start, $length);            $list_dimcount = $model->getPackage_list_search_count($search);        }        $list_count= $model->getPackage_list_search_count();        //遍历数组 拼接HTML元素        foreach ($list as $k=>$v) {            $array=array(                'waybill_number'=>$v['waybill_number'],                'company_name'=>$v['company_name'],                'receipt_code'=>$v['receipt_code'],                'name'=>$v['name'],                'phone'=>$v['phone'],                'nickname'=>$v['nickname'],                'active_value'=>$v['active_value']                );            $time_char=date("Y-m-d H:i:s",$v['in_package_time']);            $time_char_out=date("Y-m-d H:i:s",$v['out_package_time']);            $char1='<button type="button" class="btn btn-xs btn-primary dropdown-toggle " data-toggle="dropdown"><i class="fa fa-angle-down"></i></button><ul class="dropdown-menu" role="menu">';            $char2=<<<BEGIN                                <li>                                    <a href="javascript:;" onclick="changePackageStatus('{$v['id']}',2)"> 顾客拒收 </a>                                </li>                                <li>                                    <a href="javascript:;" onclick="changePackageStatus('{$v['id']}',3)"> 站点拒签 </a>                                </li>                                <li>                                    <a href="javascript:;" onclick="changePackageStatus('{$v['id']}',4)"> 退件 </a>                                </li>BEGIN;            $char3=<<<BEGIN            <li><a href="javascript:;" onclick="check_send('{$v['phone']}','{$v['receipt_code']}','{$v['id']}','{$v['status']}')">                                            发送短信                                        </a></li>BEGIN;            $char4=<<<BEGIN            <li><a href="javascript:;" class="been_send" onclick="check('{$v['phone']}','{$v['receipt_code']}','{$v['id']}');">                                            重新发送                                        </a></li>BEGIN;            if($v['status_sms']==1){                $char5=<<<BEGIN            <span style="color: green">短信提醒已送达</span>BEGIN;            }elseif($v['status_sms']==2){                $char5=<<<BEGIN            <span style="color: green">短信发送中</span>BEGIN;            }else{                $sms_record=M('sms_record')->where('mer_id='.$v['id'])->order('pigcms_id desc')->find()['errcode'];                $char5=<<<BEGIN            <a href="https://help.aliyun.com/document_detail/55323.html" target="_blank"><span style="color: red">短信发送失败<br/>错误代码:{$sms_record}</span></a>BEGIN;            }            switch($v['status']){                case 0;$array['in_package_time']='<span style="color: blue">已到站</span><br/>'.$char5.'<br/>'.$time_char;                        $array['changePackageStatus']="<div class='btn-group'><a href='javascript:;' class='btn btn-xs btn-primary' onclick='changePackageStatus({$v['id']},1)'>提货</a>".$char1.$char2;                        break;                case 1;$array['in_package_time']='<div title="提货时间&#10;'.$time_char_out.'"><span style="color: green">已提货</span><br/>'.$char5.'<br>'.$time_char.'</div>';                    $array['changePackageStatus']="<div class=\"btn-group\"><button type=\"button\" class=\"btn btn-xs btn-primary\" data-toggle=\"dropdown\">操作</button>".$char1;                    break;                case 2;$array['in_package_time']='<div title="顾客拒收时间&#10;'.$time_char_out.'"><span style="color: green">顾客拒收</span><br/>'.$char5.'<br>'.$time_char.'</div>';                    $array['changePackageStatus']="<div class=\"btn-group\"><button type=\"button\" class=\"btn btn-xs btn-primary\" data-toggle=\"dropdown\">操作</button>".$char1;                    break;                case 3;$array['in_package_time']='<div title="站点拒签时间&#10;'.$time_char_out.'"><span style="color: green">站点拒签</span><br/>'.$char5.'<br>'.$time_char.'</div>';                    $array['changePackageStatus']="<div class=\"btn-group\"><button type=\"button\" class=\"btn btn-xs btn-primary\" data-toggle=\"dropdown\">操作</button>".$char1;                    break;                case 4;$array['in_package_time']='<div title="退件时间&#10;'.$time_char_out.'"><span style="color: green">已退件</span><br/>'.$char5.'<br>'.$time_char.'</div>';                    $array['changePackageStatus']="<div class=\"btn-group\"><button type=\"button\" class=\"btn btn-xs btn-primary\" data-toggle=\"dropdown\">操作</button>".$char1;                    break;            };            switch ($v['is_send_sms']){                case 0:$array['changePackageStatus'] .=$char3;break;                case 1:$array['changePackageStatus'] .=$char4;break;            };            $list_reload[]=$array;        }        if(empty($list_reload)){            $list_reload=array();        }        $result_array=array(            'draw'=>intval(I('post.draw')),            'recordsTotal'=>$list_count,            'recordsFiltered'=>$list_dimcount,            'data'=>$list_reload            );        echo json_encode($result_array);    }    /*ajax分页获取包裹信息--数据中心页面需求版本    @author zhukeqin    @return json*/    public function ajax_package_list_all(){        $model = new PackageModel();        $start=I('post.start');        $length=I('post.length');        //datatable适配  -1则代表显示全部信息        if($length==-1){            unset($length);        }        $search_value=I('post.search');        //匹配字符串  查看搜索条件是否是格式化日期        preg_match('/\d{4}(\-|\/|.)\d{1,2}\1\d{1,2}/',$search_value['value'],$search_time);        if(empty($search_time)) {            if(!empty($search_value['value'])&&$search_value['value']!=' ') {                switch ($search_value['value']) {                    case '已到站':                        $search['status'] = 0;                        $search['in_package_time_mix']=1;                        break;                    case '已提货':                        $search['status'] = 1;                        $search['out_package_time_mix']=1;                        break;                    case '未送达':                        $search['status'] = 0;                        $search['status_sms'] = 0;                        $search['in_package_time_mix']=1;                        break;                    default:                        $search['search_dim'] = $search_value['value'];                };            }            $list = $model->getPackage_list_search($search, $start, $length);            $list_dimcount = $model->getPackage_list_search_count($search);        }else{            $search_time=strtotime($search_time['0']);            $search_time_end=$search_time+24*3600;            $search=array('in_package_time_mix'=>$search_time,'in_package_time_max'=>$search_time_end);            $list = $model->getPackage_list_search($search, $start, $length);            $list_dimcount = $model->getPackage_list_search_count($search);        }        $list_count= $model->getPackage_list_search_count();        //遍历数组 拼接HTML元素        foreach ($list as $k=>$v) {            $array=array(                'waybill_number'=>$v['waybill_number'],                'company_name'=>$v['company_name'],                'receipt_code'=>$v['receipt_code'],                'name'=>$v['name'],                'phone'=>$v['phone'],                'nickname'=>$v['nickname'],                'active_value'=>$v['active_value']            );            $time_char=date("Y-m-d H:i:s",$v['in_package_time']);            $time_char_out=date("Y-m-d H:i:s",$v['out_package_time']);            $char1='<button type="button" class="btn btn-xs btn-primary dropdown-toggle " data-toggle="dropdown"><i class="fa fa-angle-down"></i></button><ul class="dropdown-menu" role="menu">';            $char2=<<<BEGIN                                <li>                                    <a href="javascript:;" onclick="changePackageStatus('{$v['id']}',2)"> 顾客拒收 </a>                                </li>                                <li>                                    <a href="javascript:;" onclick="changePackageStatus('{$v['id']}',3)"> 站点拒签 </a>                                </li>                                <li>                                    <a href="javascript:;" onclick="changePackageStatus('{$v['id']}',4)"> 退件 </a>                                </li>BEGIN;            $char3=<<<BEGIN            <li><a href="javascript:;" onclick="check_send('{$v['phone']}','{$v['receipt_code']}','{$v['id']}','{$v['status']}')">                                            发送短信                                        </a></li>BEGIN;            $char4=<<<BEGIN            <li><a href="javascript:;" class="been_send" onclick="check('{$v['phone']}','{$v['receipt_code']}','{$v['id']}');">                                            重新发送                                        </a></li>BEGIN;            $char5_url=U('express_detail',array('id'=>$v['id']));            $char5=<<<BEGIN<a class="btn dark btn-xs" data-toggle="modal" data-target="#common_modal" href="{$char5_url}">                                                            详细                                                        </a>BEGIN;            if($v['status_sms']==1){                $char6=<<<BEGIN            <span style="color: green">短信提醒已送达</span>BEGIN;                $char7=<<<BEGIN<button class="btn green btn-xs" type="button" onclick="check_send('{$v['phone']}','{$v['receipt_code']}','{$v['id']}','{$v['status']}'),'{$v['is_send_sms']}'"> 短信提醒                                                        </button>BEGIN;            }elseif($v['status_sms']==2){                $char6=<<<BEGIN            <span style="color: blue">短信提醒发送中</span>BEGIN;                $char7=<<<BEGIN<button class="btn green btn-xs" type="button" onclick="check_send('{$v['phone']}','{$v['receipt_code']}','{$v['id']}','{$v['status']}'),'{$v['is_send_sms']}'"> 短信提醒                                                        </button>BEGIN;            }else{                $sms_record=M('sms_record')->where('mer_id='.$v['id'])->order('pigcms_id desc')->find()['errcode'];                if($sms_record=='overtime'){                    $sms_record='超时';                }                $char6=<<<BEGIN            <a href="https://help.aliyun.com/document_detail/55323.html" target="_blank"><span style="color: red">短信发送失败<br/>错误代码:{$sms_record}</span></a>BEGIN;                $char7=<<<BEGIN<button class="btn green btn-xs" type="button" onclick="check_send_phone('{$v['id']}')"> 点击处理                                                        </button>BEGIN;            }            switch($v['status']){                case 0;$array['in_package_time']='<span style="color: blue">已到站</span><br/>'.$char6.'<br/>'.$time_char;                    $array['changePackageStatus']="<button class=\"btn btn-xs btn-primary\" onclick=\"changePackageStatus('{$v['id']}',1)\">提货</button>".$char7."<div class='btn-group'><button type=\"button\" class=\"btn btn-xs btn-primary\" data-toggle=\"dropdown\">更多</button>".$char1.$char2;                    break;                case 1;$array['in_package_time']='<div title="提货时间&#10;'.$time_char_out.'"><span style="color: green">已提货</span><br/>'.$char6.'<br>'.$time_char.'</div>';                    $array['changePackageStatus']=$char5."<div class=\"btn-group\"><button type=\"button\" class=\"btn btn-xs btn-primary\" data-toggle=\"dropdown\">更多</button>".$char1;                    break;                case 2;$array['in_package_time']='<div title="顾客拒收时间&#10;'.$time_char_out.'"><span style="color: green">顾客拒收</span><br/>'.$char6.'<br>'.$time_char.'</div>';                    $array['changePackageStatus']=$char5."<div class=\"btn-group\"><button type=\"button\" class=\"btn btn-xs btn-primary\" data-toggle=\"dropdown\">更多</button>".$char1;                    break;                case 3;$array['in_package_time']='<div title="站点拒签时间&#10;'.$time_char_out.'"><span style="color: green">站点拒签</span><br/>'.$char6.'<br>'.$time_char.'</div>';                    $array['changePackageStatus']=$char5."<div class=\"btn-group\"><button type=\"button\" class=\"btn btn-xs btn-primary\" data-toggle=\"dropdown\">更多</button>".$char1;                    break;                case 4;$array['in_package_time']='<div title="退件时间&#10;'.$time_char_out.'"><span style="color: green">已退件</span><br/>'.$char6.'<br>'.$time_char.'</div>';                    $array['changePackageStatus']=$char5."<div class=\"btn-group\"><button type=\"button\" class=\"btn btn-xs btn-primary\" data-toggle=\"dropdown\">更多</button>".$char1;                    break;            };            switch ($v['is_send_sms']){                case 0:$array['changePackageStatus'] .=$char3;break;                case 1:$array['changePackageStatus'] .=$char4;break;            };            $list_reload[]=$array;        }        if(empty($list_reload)){            $list_reload=array();        }        $result_array=array(            'draw'=>intval(I('post.draw')),            'recordsTotal'=>$list_count,            'recordsFiltered'=>$list_dimcount,            'data'=>$list_reload        );        echo json_encode($result_array);    }    /*ajax获取指定时间内包裹数量信息---数据中心版本    @author zhukeqin    @return json*/    public function ajax_get_package_list()    {        $begin_time=I('post.begin_time');        $end_time=I('post.end_time');        $search_dim=I('post.search_dim');        $type=I('post.type');        $count_in_search=array('in_package_time_max'=>$end_time,'in_package_time_mix'=>$begin_time);        $count_out_search=array('out_package_time_max'=>$end_time,'out_package_time_mix'=>$begin_time);        if (!empty($search_dim)){            $count_in_search['search_dim']=$search_dim;            $count_out_search['search_dim']=$search_dim;        }        $model = new PackageModel();        //滞留件时间获取与设置        $village_config=$model->get_village_config($this->village_id);        if(empty($village_config['retention_days'])){            $village_config['retention_days']=3;        }        $time_begin=mktime(0,0,0,date('m'),date('d'),date('Y'));        $retention_time=$time_begin-$village_config['retention_days']*60*60*24;        if($type=='count') {            $count_in = $model->getPackage_list_search_count($count_in_search);            $count_out = $model->getPackage_list_search_count($count_out_search);            $count_retention=$model->getPackage_list_search_count(array('in_package_time_max'=>$retention_time,'in_package_time_mix'=>100,'status'=>0));        }else{            $count_in = $model->getPackage_list_search($count_in_search);            $count_out = $model->getPackage_list_search($count_out_search);            $count_retention=$model->getPackage_list_search(array('in_package_time_max'=>$retention_time,'in_package_time_mix'=>100,'status'=>0));        }        $company_list = $model->getAllCompany_list();        //获取每个公司的入库量        foreach ($company_list as $value){            $company_list_count[$value['company_name']]['in']=$model->getPackage_list_search_count(array('in_package_time_max'=>$end_time,'in_package_time_mix'=>$begin_time,'cid'=>$value['company_id']));            $company_list_count[$value['company_name']]['out']=$model->getPackage_list_search_count(array('in_package_time_max'=>$end_time,'in_package_time_mix'=>$begin_time,'status'=>array('neq','0'),'cid'=>$value['company_id']));        }        $result_array=array(            'count_in'=>$count_in,            'count_out'=>$count_out,            'count_retention'=>$count_retention,            'company_list_count'=>$company_list_count        );        echo json_encode($result_array);    }    /**     * 短信发送查询     * @auther zhukeqin     *     */    public function sms_record()    {        $start=I('post.start');        $length=I('post.length');        $search_value=I('post.search');        preg_match('/\d{4}(\-|\/|.)\d{1,2}\1\d{1,2}/',$search_value['value'],$search_time);        if(mb_strpos($search_value['value'],'状态')!==false){            switch ($search_value['value']){                case '状态0':$maps['s.status']=0;break;                case '状态1';$maps['s.status']=1;break;                case '状态2';$maps['s.status']=2;break;            }        }elseif(empty($search_time)) {            $maps['s.phone|s.text|u.name'] = array("like", "%{$search_value['value']}%");//模糊查询        }else{            $search_time=strtotime($search_time['0']);            $search_time_end=$search_time+24*3600;            $maps['_string']="s.time>={$search_time} AND s.time<={$search_time_end}";        }        $maps['type']='expressage';        //检测是否是ajax请求，如果是则返回短信信息        if(!empty($length)){            if($length==-1){                $length=100;            }            $field=array('s.*','u.name');            $sms_list=M('sms_record')                ->alias('s')                ->field($field)                ->join('LEFT JOIN (select name,phone,max(pigcms_id) from __EXPRESSAGE_USER__ group by phone ) u on u.phone=s.phone')                ->where($maps)                ->order('s.pigcms_id desc')                ->limit($start,$length)                ->select();            $sms_count=M('sms_record')->count();            $sms_dimcount=M('sms_record')                ->alias('s')                ->field($field)                ->join('LEFT JOIN (select name,phone,max(pigcms_id) from __EXPRESSAGE_USER__ group by phone ) u on u.phone=s.phone')                ->where($maps)                ->order('s.pigcms_id desc')                ->count();            //echo M()->_sql();            foreach ($sms_list as &$value){                $value['time']=date('Y-m-d H:i:s',$value['time']);                $value['time_receive']=date('Y-m-d H:i:s',$value['time_receive']);                switch ($value['status']){                    case 0:$value['status']='<span style="color: green">发送成功</span>';break;                    case 1:$value['status']='<span style="color: red">发送失败</span>';break;                    case 2:$value['status']='<span style="color: blue">发送中</span>';break;                }            }            if(empty($sms_list)){                $sms_list=array();            }            $result_array=array(                'draw'=>intval(I('post.draw')),                'recordsTotal'=>$sms_count,                'recordsFiltered'=>$sms_dimcount,                'data'=>$sms_list            );            echo json_encode($result_array);            die;        }        $this->display();    }    /**     * @return mixed     */    public function demo()    {        /*$model=new FoodModel();        $model->send_food_tpl('2018041209314000004193');*/        //$map['status']=1;        /*$map['pigcms_id']='6463';        $sms_list=M('sms_record')->where($map)->limit(10)->select();        $model=new Sms_aliyunModel();        foreach ($sms_list as $v) {            //获取短信发送状态详情            $sms_info = $model->sendSms_query($v['phone'], $v['time'], '1', '1', $v['bizid']);            $sms_return = $sms_info->SmsSendDetailDTOs->SmsSendDetailDTO['0'];            dump($sms_return);        }        dump(get_defined_constants());*/        /*$room_list=M('house_village_room')->where('village_id=2')->select();        foreach ($room_list as $value){            if(!empty($value['oid'])){                $owner_id=explode(',',$value['oid'])['0'];                M('house_village_room')->where('id='.$value['id'])->data(array('owner_id'=>$owner_id))->save();            }        }*/        $merchant_info=M('merchant')->where(array('village_id'=>'2','name'=>array('like','%物业%')))->field('mer_id')->find();//对应收银台商户信息 小区        $merchant_info=M('cashier_merchants')->where(array('thirduserid'=>$merchant_info['mer_id']))->field('mid')->find();//对应收银台商户信息        $mid=$merchant_info['mid'];        //$mid=28;        $payConfig = M('cashier_payconfig')->where(array('mid'=>$mid))->find();//对应商户的配置参数        $payConfig['configData'] = unserialize(htmlspecialchars_decode($payConfig['configData'],ENT_QUOTES));        $wx_user =$payConfig['configData']['weixin'];//子商户号来源        $pay_method['weixin']['config']['sub_mch_id']=$wx_user['mchid'];        dump($pay_method);    }/*******************************************************************通用方法*****************************************/    protected function err($message='',$data,$code=1)    {        $this->ajaxReturn(array('err'=>$code,'msg'=>$message,'data'=>$data));    }    protected function suc($message='',$data)    {        $this->ajaxReturn(array('err'=>0,'msg'=>$message,'data'=>$data));    }}