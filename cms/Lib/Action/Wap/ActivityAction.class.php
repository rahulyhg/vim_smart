<?phpclass ActivityAction extends BaseAction{	public function index(){		$action = '';				$now_time = time();				import('@.ORG.wap_group_page');		$count = D('Lettory')->where("`statdate`<'{$now_time}' AND `enddate`>'{$now_time}'")->count();		$p = new Page($count, C('config.group_page_row'),C('config.group_page_val'));						$lotterys = D('')->field('`m`.`name`,`l`.*')->table(array(C('DB_PREFIX').'lottery'=>'l',C('DB_PREFIX').'merchant'=>'m'))->where("`l`.`mer_id`=`m`.`mer_id` AND `l`.`statdate`<'{$now_time}' AND `l`.`enddate`>'{$now_time}'")->order('l.id DESC')->limit($p->firstRow.','.$p->listRows)->select();		foreach ($lotterys as &$lottery) {			switch ($lottery['type']) {				case 1:					$action = 'Lottery';					break;				case 2:					$action = 'Guajiang';					break;				case 3:					$action = 'Coupon';					break;				case 4:					$action = 'LuckyFruit';					break;				case 5:					$action = 'GoldenEgg';					break;			}			$lottery['url'] = U($action . '/index', array('token' => $lottery['token'], 'id' => $lottery['id']));		}		$this->assign('pagebar', $p->show());		$this->assign('lottery_list', $lotterys);		$this->assign('title', '热门活动');		$this->display();	}	public function ajax_img(){        if($_GET['ajax']){            $ImageModel=new ImageModel();            $src='http://www.hdhsmart.com/tpl/Wap/default/static//images/winter/hongbao3.jpg';            $fontsize=90;            $x=760;            $y=2425;            $text_info=M('winter_text')->where(array('winter_id'=>$_GET['id']))->find();            $text=$text_info['text']?:"在圣诞和新年来临之际\n祝你生活充满爱和平安";            $num=M('wechat_cash')->count();            $num=$num*2+1000;            $ImageModel->add_text($src,$fontsize,$x,$y,array(255,255,255,1),$num,$text);        }else{            $openid=$_SESSION['openid'];            if(empty($openid)) {                $this->error_tips('请在微信端中打开');                die;            }            $wechatModel=new WechatModel();            $user_info=M('user')->where(array('openid'=>$openid))->find();            $signPackage=$wechatModel->getJsSign();            $this->assign('signPackage',$signPackage);            $this->assign('user_info',$user_info);            $this->display('winter_img');        }    }	public function winter_cash(){        /*echo $this->error_tips('当前参与抢红包人数过多，服务器繁忙，请稍后再试！');        die;*/	    $openid=$_SESSION['openid'];	    if(empty($openid)) {	        $this->error_tips('请在微信端中打开');	        die;        }        $now_time=time();	    $start_time=1545609600;        if($now_time<$start_time){	        $this->error_tips('抢红包活动还未开始，请大家关注“汇得行”微信公众号，24号早上会有活动开始提示哦！');	        die;        }        if($now_time<1545696000){            $this->error_tips('感谢您的参与，今日红包已被抢完！明日（25号）早上8点，抢红包还会继续，请继续关注哦！');            die;        }	    $wechatModel=new WechatModel();        $signPackage=$wechatModel->getJsSign();        $user_info=M('user')->where(array('openid'=>$openid))->find();        $this->assign('signPackage',$signPackage);        $this->assign('user_info',$user_info);        /*$text_list=M('winter_text')->order('winter_id desc')->limit('0,20')->select();        foreach ($text_list as &$value){            $value['nickname']=M('user')->where(array('openid'=>$value['openid']))->find()['nickname'];        }*/        $this->assign('text_list',$text_list);	    $this->display();    }    public function winter_hongbao(){	    $this->display();    }    public function ajax_winter_text(){	    if(IS_POST){	        if(empty($_POST['text'])){                echo json_encode(array('err'=>1,'data'=>'请填写祝福语'));                die;            }else{	            $text=$_POST['text'];            }            if(mb_strlen($text)>20){                echo json_encode(array('err'=>1,'data'=>'祝福语请小于20字！'));                die;            }            if(mb_strlen($text)<5){                echo json_encode(array('err'=>1,'data'=>'祝福语请大于5字！'));                die;            }            $day_start=strtotime(date('Y-m-d'));            $now=time();            if($now<($day_start+8*3600)){                echo json_encode(array('err'=>1,'data'=>'因微信官方政策，00:00—08:00期间无法发红包，请于08:00后再来抢红包。'));                die;            }            $start_time=1545451719;            if($now<$start_time){                echo json_encode(array('err'=>1,'data'=>'抢红包活动还未开始，请大家关注“汇得行”微信公众号，24号早上会有活动开始提示哦！'));                die;            }            $end=1545753600;            if($now>$end){                echo json_encode(array('err'=>1,'data'=>'圣诞红包已经抢完啦，本次活动已结束，感谢您的参与！'));                die;            }            $data=array(                'text'=>$text,                'openid'=>$_SESSION['openid'],                'updatetime'=>time(),            );	        $re=M('winter_text')->data($data)->add();	        if($re){                echo json_encode(array('err'=>0,'data'=>$re));                die;            }else{                echo json_encode(array('err'=>1,'data'=>'提交失败，请重试'));                die;            }        }else{	        echo json_encode(array('err'=>1,'data'=>'错误'));        }    }	public function winter_cash_send_ceshi(){        echo json_encode(array('err'=>1,'data'=>'感谢您的参与，今日红包已被抢完！明日（25号）早上8点，抢红包还会继续，请继续关注哦！'));        //$this->error_tips('感谢您的参与，今日红包已被抢完！明日（25号）早上8点，抢红包还会继续，请继续关注哦！');        die;        $openid=$_SESSION['openid'];        $day_start=strtotime(date('Y-m-d'));	    $now=time();        //$now=1545667201;	    if($now<($day_start+8*3600)){	        echo json_encode(array('err'=>1,'data'=>'因微信官方政策，00:00—08:00期间无法发红包，请于08:00后再来抢红包。'));	        die;        }        $start_time=1545451719;        if($now<$start_time){            echo json_encode(array('err'=>1,'data'=>'抢红包活动还未开始，请大家关注“汇得行”微信公众号，24号早上会有活动开始提示哦！'));            die;        }        $end=1545753600;	    if($now>$end){            echo json_encode(array('err'=>1,'data'=>'圣诞红包已经抢完啦，本次活动已结束，感谢您的参与！'));            die;        }        //检查今天是否提交过祝福语        $where=array(            'updatetime'=>array('between',array($day_start,($day_start+24*3600))),            'openid'=>$openid,        );        $winter_text=M('winter_text')->where($where)->find();        if(empty($winter_text)){            echo json_encode(array('err'=>1,'data'=>'您今天还没有参加过活动，请先参加活动再抽红包'));            die;        }        //查找今天是否参加过活动        $where=array(            'updatetime'=>array('between',array($day_start,($day_start+24*3600))),            'openid'=>$openid,            'remark'=>'winter',        );        $winter_info=M('wechat_cash')->where($where)->find();        if(!empty($winter_info)){            echo json_encode(array('err'=>1,'data'=>'您今天已经参加过活动喽,请明天再来'));            die;        }        $data_get=array(            array('name'=>'do','weights'=>2),            array('name'=>'undo','weights'=>8),        );        $get=$this->getConsultant($data_get);        if($get=='undo'){            $data=array(                'result_msg'=>'',                'money'=>'0',                'openid'=>$openid,                'updatetime'=>time(),                'status'=>1,                'remark'=>'winter',            );            $res=M('wechat_cash')->data($data)->add();            echo json_encode(array('err'=>1,'data'=>'很遗憾，您没有抽中红包'));            die;        }        $wechantModel=new WechatModel();        $money=rand(30,41);        //暂时阻断        /*echo json_encode(array('err'=>0,'data'=>($money/100)));        die;*/        $return=$wechantModel->wechatCash('',$openid,$money);        //是否成功发放        if($return['result_code']=='SUCCESS'){            $data=array(                'result_msg'=>serialize($return),                'money'=>$money,                'openid'=>$openid,                'updatetime'=>time(),                'status'=>1,                'remark'=>'winter',            );            $res=M('wechat_cash')->data($data)->add();            echo json_encode(array('err'=>0,'data'=>($money/100)));            die;        }else{            if($return['err_code']=='NOTENOUGH'){                echo json_encode(array('err'=>1,'data'=>'本次活动的奖金已经被瓜分完啦，请继续注意后续活动哦'));                die;            }else{                echo json_encode(array('err'=>1,'data'=>'网络繁忙，请稍后再试'.$return['err_code_des']));                die;            }        }    }    /**     * @author zhukeqin     * 微信红包分发     */    public function winter_cash_send(){        $openid=$_SESSION['openid'];        $now=time();        $day_start=strtotime(date('Y-m-d',$now));        if($now<($day_start+8*3600)){            echo json_encode(array('err'=>1,'data'=>'因微信官方政策，00:00—08:00期间无法发红包，请于08:00后再来抢红包。'));            die;        }        $start_time=1545451719;        if($now<$start_time){            echo json_encode(array('err'=>1,'data'=>'抢红包活动还未开始，请大家关注“汇得行”微信公众号，24号早上会有活动开始提示哦！'));            die;        }        $end=1545753600;        if($now>$end){            echo json_encode(array('err'=>1,'data'=>'圣诞红包已经抢完啦，本次活动已结束，感谢您的参与！'));            die;        }        //检查今天是否提交过祝福语        $where=array(            'updatetime'=>array('between',array($day_start,($day_start+24*3600))),            'openid'=>$openid,        );        $winter_text=M('winter_text')->where($where)->find();        if(empty($winter_text)){            echo json_encode(array('err'=>1,'data'=>'您今天还没有参加过活动，请先参加活动再抽红包'));            die;        }        //查找今天是否参加过活动        $where=array(            'updatetime'=>array('between',array($day_start,($day_start+24*3600))),            'openid'=>$openid,            'remark'=>'winter',        );        $winter_info=M('wechat_cash')->where($where)->find();        if(!empty($winter_info)){            echo json_encode(array('err'=>1,'data'=>'您今天已经参加过活动了哦'));            die;        }        $time_list=array(            array('time'=>1545696000,'max_money'=>10000),            array('time'=>1545703200,'max_money'=>10000),            array('time'=>1545710400,'max_money'=>10000),            array('time'=>1545717600,'max_money'=>10000),            array('time'=>1545724800,'max_money'=>14900),        );        $data=array();        foreach ($time_list as $value){            if($value['time']<=$now){                $data=$value;            }else{                break;            }        }        if(empty($data)){            echo json_encode(array('err'=>1,'data'=>'感谢您的参与，今日红包已被抢完！明日（25号）早上8点，抢红包还会继续，请继续关注哦！'));            die;        }        //事务处理        M()->startTrans();        $money_sum=M('wechat_cash')->lock(true)->where(array('updatetime'=>array('egt',$data['time'])))->sum('money');//事务锁        //$money_sum=10100;        if($money_sum>=$data['max_money']){            M()->rollback();            if($data['time']=='1545724800'){                echo json_encode(array('err'=>1,'data'=>'圣诞红包已经抢完啦，本次活动已结束，感谢您的参与！'));                die;            }else{                echo json_encode(array('err'=>1,'data'=>'当前参与抢红包人数过多，服务器繁忙，请稍后再试！'));                die;            }        }        unset($data);        unset($time_list);        //是否抽中红包        /*$data_get=array(            array('name'=>'do','weights'=>2),            array('name'=>'undo','weights'=>8),        );        $get=$this->getConsultant($data_get);        if($get=='undo'){            $data=array(                'result_msg'=>'',                'money'=>'0',                'openid'=>$openid,                'updatetime'=>time(),                'status'=>1,                'remark'=>'winter',            );            $res=M('wechat_cash')->data($data)->add();            M()->commit();            echo json_encode(array('err'=>1,'data'=>'很遗憾，您没有抽中红包'));            die;        }*/        $wechantModel=new WechatModel();        $money=rand(30,40);        $return=$wechantModel->wechatCash('',$openid,$money);        //模拟发放        //$return['result_code']='SUCCESS';        //是否成功发放        if($return['result_code']=='SUCCESS'){            $data=array(                'result_msg'=>serialize($return),                'money'=>$money,                'openid'=>$openid,                'updatetime'=>time(),                'status'=>1,                'remark'=>'winter',            );            $res=M('wechat_cash')->data($data)->add();            M()->commit();            echo json_encode(array('err'=>0,'data'=>($money/100)));            die;        }else{            if($return['err_code']=='NOTENOUGH'){                M()->rollback();                echo json_encode(array('err'=>1,'data'=>'圣诞红包已经抢完啦，本次活动已结束，感谢您的参与！'));                die;            }else{                M()->rollback();                echo json_encode(array('err'=>1,'data'=>'网络繁忙，请稍后再试'));//$return['err_code_des']                die;            }        }    }    /**     * @author zhukeqin     * @param $now     * @return array     * 检查时间以及红包余额     */    public function check_time($now){	    $time=$now?:time();	    $time_list=array(	      array('time'=>1545696000,'max_money'=>10000),	      array('time'=>1545703200,'max_money'=>10000),	      array('time'=>1545710400,'max_money'=>10000),	      array('time'=>1545717600,'max_money'=>10000),	      array('time'=>1545724800,'max_money'=>10000),        );	    $data=array();	    foreach ($time_list as $value){	        if($value['time']<$time){	            $data=$value;            }else{	            break;            }        }        if(empty($data)){            return array('err'=>1,'data'=>'感谢您的参与，今日红包已被抢完！明日（25号）早上8点，抢红包还会继续，请继续关注哦！');        }        $money_sum=M('wechat_cash')->where(array('updatetime'=>array('egt',$data['time'])))->sum('money');        if($money_sum>$data['max_money']){            if($data['time']=='1545724800'){                return array('err'=>1,'data'=>'本次活动的奖金已经被瓜分完啦，请继续注意后续活动哦');            }else{                return array('err'=>1,'data'=>'感谢您的参与，当前时段红包已被抢完!下一个红包时间段开始时间为'.(date('H',$time)+2).'点，请继续关注哦！');            }        }else{            return array('err'=>0,'data'=>$money_sum);        }    }    public function demo(){        $now=time();        $time_list=array(            array('time'=>1545696000,'max_money'=>10000),            array('time'=>1545703200,'max_money'=>10000),            array('time'=>1545710400,'max_money'=>10000),            array('time'=>1545717600,'max_money'=>10000),            array('time'=>1545724800,'max_money'=>10000),        );        $data=array();        foreach ($time_list as $value){            if($value['time']<=$now){                $data=$value;            }else{                break;            }        }        dump(M('wechat_cash')->where(array('updatetime'=>array('egt',$data['time'])))->sum('money'));    }    /**     * @author zhukeqin     * @param $data     * @return mixed     * 权重随机     */    public function getConsultant($data)    {        $weight = 0;        $users = array();        foreach ($data as $one) {            $oneWeight = (int)$one['weights'] ? $one['weights'] : 1;            $weight += $oneWeight;            for ($i = 0; $i < $oneWeight; $i ++) {                $users[] = $one;            }        }        return $users[rand(0, $weight-1)]['name'];    }}?>