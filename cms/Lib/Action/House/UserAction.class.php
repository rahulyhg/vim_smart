<?php/* * 小区业主 * */class UserAction extends BaseAction{	protected $village_id;	protected $village;		public function _initialize(){		parent::_initialize();				$this->village_id = $this->house_session['village_id'];		$this->village = D('House_village')->where(array('village_id'=>$this->village_id))->find();		if(empty($this->village)){			$this->error('该小区不存在！');		}		if($this->village['status'] == 0){			$this->assign('jumpUrl',U('Index/index'));			$this->error('您需要先完善信息才能继续操作');		}	}	//打印信息	function show($msg){		echo "<pre style='color: blue;'>";		var_dump($msg);		echo "</pre>";	}	// 所有业主列表    public function index_bck(){		$village_id = $this->village_id;		$user_list = D('House_village_user_bind')->get_limit_list_page($village_id);				$this->assign('user_list',$user_list);		$this->display();    }    /**     *业主列表     */    public function index(){        $village_id = $this->village_id;                $user_list = D('House_village_user_bind')->get_limit_list_page_2($village_id);        //vd($user_list);exit;        $this->assign('user_list',$user_list);        $this->display();    }        public function edit(){    	if(IS_POST){    		$condition['usernum'] = $_POST['usernum'];    		$condition['pigcms_id'] = $_POST['pigcms_id'];    		$condition['village_id'] = $this->village_id;    		    		$_POST['add_time'] = $_SERVER['REQUEST_TIME'];    		if(D('House_village_user_bind')->where($condition)->data($_POST)->save()){    			$this->success('保存成功',U('User/index'));    			exit;    		}    		$this->error('保存失败');    		exit;    	}else{    		$pigcms_id = $_GET['pigcms_id'];    		$usernum = $_GET['usernum'];    		if($pigcms_id && $usernum){    			$condition['pigcms_id'] = $pigcms_id;    			$condition['usernum'] = $usernum;    			$info = D('House_village_user_bind')->where($condition)->find();    			$this->assign('info',$info);    		}    		$this->display();    	}    }    /**     * 用户批量导入旧版     *     */    public function user_import_bck(){    	if(IS_POST){			if ($_FILES['file']['error'] != 4) {				set_time_limit(0);				$upload_dir = './upload/excel/villageuser/'.date('Ymd').'/';				if (!is_dir($upload_dir)) {					mkdir($upload_dir, 0777, true);				}				import('ORG.Net.UploadFile');				$upload = new UploadFile();				$upload->maxSize = 10 * 1024 * 1024;				$upload->allowExts = array('xls','xlsx');				$upload->allowTypes = array(); // 允许上传的文件类型 留空不做检查				$upload->savePath = $upload_dir;				$upload->thumb = false;				$upload->thumbType = 0;				$upload->imageClassPath = '';				$upload->thumbPrefix = '';				$upload->saveRule = 'uniqid';				if ($upload->upload()) {					$uploadList = $upload->getUploadFileInfo();					require_once APP_PATH . 'Lib/ORG/phpexcel/PHPExcel/IOFactory.php';					$path = $uploadList['0']['savepath'] . $uploadList['0']['savename'];					$fileType = PHPExcel_IOFactory::identify($path); //文件名自动判断文件类型					$objReader = PHPExcel_IOFactory::createReader($fileType);					$excelObj = $objReader->load($path);					$result = $excelObj->getActiveSheet()->toArray(null, true, true, true);										$database_user = D('User');					if (!empty($result) && is_array($result)) {						unset($result[1]);						$last_user_id = 0;						foreach ($result as $kk => $vv) {							$vv['K'] = intval($vv['K']);							if(empty($vv['A']) || empty($vv['B']) || empty($vv['C']) || !isset($vv['D']) || !isset($vv['E']) || !isset($vv['F']) || !isset($vv['G'])|| !isset($vv['H'])|| !isset($vv['I']) || empty($vv['J']) || empty($vv['K'])) continue;														$tmpdata = array();							//$tmpdata['usernum'] = htmlspecialchars(trim($vv['A']), ENT_QUOTES);							$tmpdata['phone'] = htmlspecialchars(trim($vv['C']), ENT_QUOTES);							//检测用户是否已存在							//if(D('House_village_user_bind')->field('`usernum`')->where(array('usernum'=>$tmpdata['usernum']))->find()) continue;							if(D('House_village_user_bind')->field('`phone`')->where(array('phone'=>$tmpdata['phone']))->find()) continue;							$tmpdata['name'] = htmlspecialchars(trim($vv['B']), ENT_QUOTES);							$tmpdata['phone'] = htmlspecialchars(trim($vv['C']), ENT_QUOTES);							$tmpdata['water_price'] = htmlspecialchars(trim($vv['D']), ENT_QUOTES);							$tmpdata['electric_price'] = htmlspecialchars(trim($vv['E']), ENT_QUOTES);							$tmpdata['gas_price'] = htmlspecialchars(trim($vv['F']), ENT_QUOTES);							$tmpdata['property_price'] = htmlspecialchars(trim($vv['G']), ENT_QUOTES);							$tmpdata['park_flag'] = htmlspecialchars(trim($vv['H']), ENT_QUOTES);							$tmpdata['park_price'] = htmlspecialchars(trim($vv['I']), ENT_QUOTES);							$tmpdata['address'] = htmlspecialchars(trim($vv['J']), ENT_QUOTES);							$tmpdata['housesize'] = $vv['K'];							$tmpdata['village_id'] = $this->village_id;														$user = $database_user->get_user($tmpdata['phone'],'phone');							if($user){								$tmpdata['uid'] = $user['uid'];							}														$last_user_id = D('House_village_user_bind')->data($tmpdata)->add();													}						if(!empty($last_user_id)){							$this->success('导入成功');exit;						}else{							$this->error('导入失败');exit;						}					}				} else {					$this->error($upload->getErrorMsg());exit;				}			}			$this->error('文件上传失败');exit;		}else{			$this->display();		}	}    /**     * 用户批量导入新版2.0     * @author 祝君伟     * @time 2017年8月8日11:13:18     */    public function user_import(){        if(IS_POST){            if ($_FILES['file']['error'] != 4) {                set_time_limit(0);                $upload_dir = './upload/excel/villageuser/'.date('Ymd').'/';                if (!is_dir($upload_dir)) {                    mkdir($upload_dir, 0777, true);                }                import('ORG.Net.UploadFile');                $upload = new UploadFile();                $upload->maxSize = 10 * 1024 * 1024;                $upload->allowExts = array('xls','xlsx');                $upload->allowTypes = array(); // 允许上传的文件类型 留空不做检查                $upload->savePath = $upload_dir;                $upload->thumb = false;                $upload->thumbType = 0;                $upload->imageClassPath = '';                $upload->thumbPrefix = '';                $upload->saveRule = 'uniqid';                if ($upload->upload()) {                    $uploadList = $upload->getUploadFileInfo();                    require_once APP_PATH . 'Lib/ORG/phpexcel/PHPExcel/IOFactory.php';                    $path = $uploadList['0']['savepath'] . $uploadList['0']['savename'];                    $fileType = PHPExcel_IOFactory::identify($path); //文件名自动判断文件类型                    $objReader = PHPExcel_IOFactory::createReader($fileType);                    $excelObj = $objReader->load($path);                    $result = $excelObj->getActiveSheet()->toArray(null, true, true, true);                    $database_user = D('User');                    if (!empty($result) && is_array($result)) {                        unset($result[1]);                        //vd($result);exit;                        //定义错误储存数组                        $err_array = array();                        foreach ($result as $kk => $vv) {                            $vv['K'] = intval($vv['K']);                            if(empty($vv['A']) || empty($vv['B']) || empty($vv['C']) || !isset($vv['D']) || !isset($vv['E']) || !isset($vv['F']) || !isset($vv['G'])|| !isset($vv['H'])|| !isset($vv['I']) || empty($vv['J']) || empty($vv['K'])){                                $err_array[]=array('err'=>1,'msg'=>'导入信息失败，具体原因为：信息不全。','name'=>htmlspecialchars(trim($vv['B']), ENT_QUOTES));                                continue;                            }                            $tmpdata = array();                            //$tmpdata['usernum'] = htmlspecialchars(trim($vv['A']), ENT_QUOTES);                            $tmpdata['phone'] = htmlspecialchars(trim($vv['C']), ENT_QUOTES);                            //检测用户是否已存在，存在该用户则直接更新信息                            if(empty($tmpdatap['phone'])&&!isset($tmpdata['phone'])) exit('致命错误');                            $old_info = D('House_village_user_bind')->where(array('phone'=>$tmpdata['phone']))->find();                            if($old_info != null){                                //存在该用户需要更新                                $tmpdata['name'] = htmlspecialchars(trim($vv['B']), ENT_QUOTES);                                //中转水费组成                                $transfer_array = explode("-",htmlspecialchars(trim($vv['D']), ENT_QUOTES));                                $tmpdata['water_type'] = $transfer_array[1];                                $tmpdata['water_price'] = $transfer_array[0];                                //中转电费组成                                $transfer_array = explode("-",htmlspecialchars(trim($vv['E']), ENT_QUOTES));                                $tmpdata['electric_type'] = $transfer_array[1];                                $tmpdata['electric_price'] = $transfer_array[0];                                //中转燃气费组成                                $transfer_array = explode("-",htmlspecialchars(trim($vv['F']), ENT_QUOTES));                                $tmpdata['gas_type'] = $transfer_array[1];                                $tmpdata['gas_price'] = $transfer_array[0];                                $tmpdata['property_price'] = htmlspecialchars(trim($vv['G']), ENT_QUOTES);                                $tmpdata['park_flag'] = htmlspecialchars(trim($vv['H']), ENT_QUOTES);                                $tmpdata['park_price'] = htmlspecialchars(trim($vv['I']), ENT_QUOTES);                                $tmpdata['address'] = htmlspecialchars(trim($vv['J']), ENT_QUOTES);                                $tmpdata['housesize'] = $vv['K'];                                $tmpdata['contract_start'] = strtotime(htmlspecialchars(trim($vv['L']), ENT_QUOTES));                                $tmpdata['contract_end'] = strtotime(htmlspecialchars(trim($vv['M']), ENT_QUOTES));                                $tmpdata['village_id'] = $this->village_id;                                $company_id = $this->select_this_company(htmlspecialchars(trim($vv['A']), ENT_QUOTES));                                if($company_id === false){                                    $tmpdata['company'] = htmlspecialchars(trim($vv['A']), ENT_QUOTES);                                }else{                                    $tmpdata['company_id'] = $company_id;                                }                                $user = $database_user->get_user($tmpdata['phone'],'phone');                                if($user){                                    $tmpdata['uid'] = $user['uid'];                                }                                if(!empty($old_info['pigcms_id'])&&isset($old_info['pigcms_id'])){                                    $update_res = M('House_village_user_bind')->where(array('pigcms_id'=>$old_info['pigcms_id']))->data($tmpdata)->save();                                    if(!$update_res){                                        $err_array[]=array('err'=>1,'msg'=>'更新信息失败，具体原因为：无法更新。','name'=>$tmpdata['name']);                                        //$this->error('导入失败');exit;                                    }else{                                        $err_array[]=array('err'=>0,'name'=>$tmpdata['name']);                                    }                                }                            }else{                                $tmpdata['name'] = htmlspecialchars(trim($vv['B']), ENT_QUOTES);                                $tmpdata['phone'] = htmlspecialchars(trim($vv['C']), ENT_QUOTES);                                //中转水费组成                                $transfer_array = explode("-",htmlspecialchars(trim($vv['D']), ENT_QUOTES));                                $tmpdata['water_type'] = $transfer_array[1];                                $tmpdata['water_price'] = $transfer_array[0];                                //中转电费组成                                $transfer_array = explode("-",htmlspecialchars(trim($vv['E']), ENT_QUOTES));                                $tmpdata['electric_type'] = $transfer_array[1];                                $tmpdata['electric_price'] = $transfer_array[0];                                //中转燃气费组成                                $transfer_array = explode("-",htmlspecialchars(trim($vv['F']), ENT_QUOTES));                                $tmpdata['gas_type'] = $transfer_array[1];                                $tmpdata['gas_price'] = $transfer_array[0];                                $tmpdata['property_price'] = htmlspecialchars(trim($vv['G']), ENT_QUOTES);                                $tmpdata['park_flag'] = htmlspecialchars(trim($vv['H']), ENT_QUOTES);                                $tmpdata['park_price'] = htmlspecialchars(trim($vv['I']), ENT_QUOTES);                                $tmpdata['address'] = htmlspecialchars(trim($vv['J']), ENT_QUOTES);                                $tmpdata['housesize'] = $vv['K'];                                $tmpdata['contract_start'] = strtotime(htmlspecialchars(trim($vv['L']), ENT_QUOTES));                                $tmpdata['contract_end'] = strtotime(htmlspecialchars(trim($vv['M']), ENT_QUOTES));                                $tmpdata['village_id'] = $this->village_id;                                $tmpdata['usernum'] = $this->make_number_no($this->village_id);                                $company_id = $this->select_this_company(htmlspecialchars(trim($vv['A']), ENT_QUOTES));                                if($company_id === false){                                    $tmpdata['company'] = htmlspecialchars(trim($vv['A']), ENT_QUOTES);                                }else{                                    $tmpdata['company_id'] = $company_id;                                }                                $user = $database_user->get_user($tmpdata['phone'],'phone');                                if($user){                                    $tmpdata['uid'] = $user['uid'];                                }                                $last_user_id = D('House_village_user_bind')->data($tmpdata)->add();                                if(empty($last_user_id)) {                                    $err_array[]=array('msg'=>'名字为：'.$tmpdata['name'].'录入信息失败，具体原因为：非空字段为空。');                                    continue;                                }else{                                    $err_array[]=array('err'=>0,'name'=>$tmpdata['name']);                                    continue;                                }                            }                        }                        //$this->success('导入成功');exit();                       foreach ($err_array as $key => $value){                            if($value['name']==''){                                unset($err_array[$key]);                            }                       }                        $this->assign('err_array',$err_array);                        $this->display('upload_state');                    }                } else {                    $this->error($upload->getErrorMsg());exit;                }            }else{                $this->error('文件上传失败');exit;            }        }else{            $this->display();        }    }    /**     * 制作物业编号     * 编号规则：项目名称大写+时间+四位随机     * @param $village_id     * @return string     */    protected function make_number_no($village_id){        //获取当前社区的信息        $village_info = M('house_village')->find($village_id);        //项目名称大写        $top_str = strtoupper($village_info['account']);        //标准时间        $date = date('YmdHis');        //编号        $number_no = $top_str.$date.rand(1000,9999);        return $number_no;    }    /**     * 查询当前公司的id     * @param $company_name     * @return bool     */    protected function select_this_company($company_name){        //获取当前公司的名称和id        $company_info = M('company')->where(array('company_name'=>$company_name))->find();        if($company_info == null){            //未找到当前的公司            return false;        }else{            return $company_info['company_id'];        }    }    /**     * 增加单个业主     * @author 祝君伟     * @time 2017年8月8日16:57:00     */    public function add_bindUser(){        if(IS_POST){            //执行添加            $data = $_POST;            if($data['company_id']==''){                //表示没有匹配到当前的公司，先行添加公司                //获取当前公司的首字母大写                import('@.ORG.Pinyin');                $pinyin = new CUtf8_PY();                $first_word =substr(strtoupper($pinyin->encode($data['company_name'])),0,1);                //制作公司添加数组                $company_array = array(                    'company_name'=>$data['company_name'],                    'village_id'=>$this->village_id,                    'company_phone'=>$data['phone'],                    'add_time'=>time(),                    'company_first'=>$first_word,                    'is_admin'=>1,                    'floor'=>$data['floor']                );                $company_id = M('company')->data($company_array)->add();                if($company_id){                    //插入成功                    $bind_array = array(                        'village_id'=>$this->village_id,                        'usernum'=>$this->make_number_no($this->village_id),                        'name'=>$data['name'],                        'phone'=>$data['phone'],                        'housesize'=>$data['housesize'],                        'water_price'=>$data['water_price'],                        'electric_price'=>$data['electric_price'],                        'gas_price'=>$data['gas_price'],                        'park_price'=>$data['park_price'],                        'property_price'=>$data['property_price'],                        'add_time'=>time(),                        'company_id'=>$company_id,                    );                    //添加到业主表中                    $res = M('house_village_user_bind')->data($bind_array)->add();                    if($res){                        $this->success('添加成功');                    }else{                        $this->error('添加失败');                    }                }else{                    $this->error('公司添加失败');                }            }else{                //制作业主添加数组                $bind_array = array(                    'village_id'=>$this->village_id,                    'usernum'=>$this->make_number_no($this->village_id),                    'name'=>$data['name'],                    'phone'=>$data['phone'],                    'housesize'=>$data['housesize'],                    'water_price'=>$data['water_price'],                    'electric_price'=>$data['electric_price'],                    'gas_price'=>$data['gas_price'],                    'park_price'=>$data['park_price'],                    'property_price'=>$data['property_price'],                    'add_time'=>time(),                    'company_id'=>$data['company_id'],                );                //添加到业主表中                $res = M('house_village_user_bind')->data($bind_array)->add();                if($res){                    $this->success('添加成功');                }else{                    $this->error('添加失败');                }            }        }else{            //执行显示            $this->display();        }    }    /**     * 自动完成公司     *     */    public function autocomplete_company(){        $keyword = I('get.query');        //制作查询语句        $map['company_name']=array('like','%'.$keyword.'%');        $keyword_array = M('company')->where($map)->limit(5)->order('company_id desc')->select();        foreach ($keyword_array as $value){            $result_array[] =array(                'label'=>$value['company_name'],            );        }        echo json_encode($result_array);    }    /**     * 获取当前的公司信息     */    public function check_this_company(){        $company_name = I('post.company_name');        $company_info = M('company')->where(array('village_id'=>$this->village_id,'company_name'=>$company_name))->find();        if($company_info == null){            echo json_encode(array('error'=>1));        }else{            $res_array = array(                'error'=>0,                'floor'=>$company_info['floor'],                'company_id'=>$company_info['company_id']            );            echo json_encode($res_array);        }    }    /**     * 缴费历史详细信息     */    public function order_history(){        $bind_id = I('get.bind_id');        $order_count = M('house_village_pay_order')->where(array('bind_id'=>$bind_id,'paid'=>1))->count();        import('@.ORG.merchant_page');        $p = new Page($order_count,15,'page');        $order_array = M('house_village_pay_order')            ->where(array('bind_id'=>$bind_id,'paid'=>1))            ->order('`order_id` DESC')            ->limit($p->firstRow.','.$p->listRows)            ->select();        if($order_array){            $return['totalPage'] = ceil($order_count/15);            $return['user_count'] = count($order_array);            $return['pagebar'] = $p->show();            $return['user_list'] = $order_array;        }        $this->assign('user_list',$return);        $this->display();    }    /**     * 每月账单预览     * @author 祝君伟     * @time  2017年8月14日15:59:57     */    public function exit_xls(){        $village_id = $this->village_id;        $village_info = M('house_village')->find($village_id);        if($village_info['bill_begin_time'] != date('d')){            $this->assign('is_create',0);        }else{            $this->assign('is_create',1);        }        //当前管理员的身份默认为社区管理员        //查询该社区下的所有信息        $pageSize = 15;        $count_user = M('house_village_user_bind')            ->alias('b')            ->field(array('b.*','c.company_name'))            ->join('LEFT JOIN __COMPANY__ c on b.company_id=c.company_id')            ->where('water_price is not null and b.village_id='.$village_id)            ->count();        import('@.ORG.merchant_page');        $p = new Page($count_user,$pageSize,'page');        $user_list = M('house_village_user_bind')            ->alias('b')            ->field(array('b.*','c.company_name'))            ->join('LEFT JOIN __COMPANY__ c on b.company_id=c.company_id')            ->where('water_price is not null and b.village_id='.$village_id)            ->order('`pigcms_id` DESC')            ->limit($p->firstRow.','.$p->listRows)            ->select();        //当前应查表的月份        $now_month = strtotime(date('Y-m'));        $end_month = strtotime(date('Y-m-t'));        //查询如果已经有当月的账单就不能保存账单,查询当前月份的读表信息        foreach ($user_list as $key=>$value){            //查询是否已经有当前账单了            $user_now_order = M('house_village_user_paylist')->where(array('usernum'=>$value['usernum'],'ydate'=>date('Y'),'mdate'=>date('m')))->find();            if($user_now_order){                $user_list[$key]['has_save'] = 1;            }else{                //没有当前账单的时候直接查询是否有当月的查表信息                //组织查表条件                $map = array(                    'usernum'=>$value['usernum'],                    'create_time'=>array('between',array($now_month,$end_month)),                );                $water_meter_data = M('re_setmeter')->where($map)->where(array('device_name'=>M('re_setmeter_config')->getFieldById($value['water_type'],'sign')))->order('create_time desc')->find();                //vd(M()->_sql());exit;                $gas_meter_data = M('re_setmeter')->where($map)->where(array('device_name'=>M('re_setmeter_config')->getFieldById($value['gas_type'],'sign')))->order('create_time desc')->find();                $electricity_meter_data = M('re_setmeter')->where($map)->where(array('device_name'=>M('re_setmeter_config')->getFieldById($value['electric_type'],'sign')))->order('create_time desc')->find();                //水费单价                $waterUnitPrice = _filterPriceType($water_meter_data['device_name'],$value['village_id']);                //电费单价                $electUnitPrice = _filterPriceType($electricity_meter_data['device_name'],$value['village_id']);                //燃气费单价                $gasUnitPrice = _filterPriceType($gas_meter_data['device_name'],$value['village_id']);                //vd($waterUnitPrice);                $water_mater_price = !empty($water_meter_data)?$water_meter_data['consume']*$waterUnitPrice:0;                $gas_mater_price = !empty($gas_meter_data)?$gas_meter_data['consume']*$gasUnitPrice:0;                $electricity_mater_price = !empty($electricity_meter_data)?$electricity_meter_data['consume']*$electUnitPrice:0;                $user_list[$key]['now_water_price'] = $water_mater_price;                $user_list[$key]['now_electric_price'] = $electricity_mater_price;                $user_list[$key]['now_gas_price'] = $gas_mater_price;                $user_list[$key]['has_save'] = 0;                //vd($gas_mater_price);exit();            }        }        if($user_list){            $return['totalPage'] = ceil($count_user/$pageSize);            $return['user_count'] = count($user_list);            $return['pagebar'] = $p->show();            $return['user_list'] = $user_list;        }        //vd($return);        $this->assign('village_user_array',$return);        $this->display();    }    public function complete_all_order(){        //当前的社区id        $village_id = $this->village_id;        //小区信息        $village_info = M('house_village')->find($this->village_id);        if($village_info['bill_begin_time'] != date('d')){            $this->error('当前日期不是生成订单日！',U('exit_xls'));        }        //查询社区下所有的业主信息        $user_list = M('house_village_user_bind')            ->alias('b')            ->field(array('b.*','c.company_name'))            ->join('LEFT JOIN __COMPANY__ c on b.company_id=c.company_id')            ->where('water_price is not null and b.village_id='.$village_id)            ->order('`pigcms_id` DESC')            ->select();        //当前应查表的月份        $now_month = strtotime(date('Y-m'));        $end_month = strtotime(date('Y-m-t'));        //该社区下的所有业主的账单信息        foreach ($user_list as $key=>$value){            $user_now_order = M('house_village_user_paylist')->where(array('usernum'=>$value['usernum'],'ydate'=>date('Y'),'mdate'=>date('m')))->find();            if(!$user_now_order){                //没有账单的，添加账单                //组织查表条件                $map = array(                    'usernum'=>$value['usernum'],                    'create_time'=>array('between',array($now_month,$end_month)),                );                $water_meter_data = M('re_setmeter')->where($map)->where(array('device_name'=>M('re_setmeter_config')->getFieldById($value['water_type'],'sign')))->order('create_time desc')->find();                //vd(M()->_sql());exit;                $gas_meter_data = M('re_setmeter')->where($map)->where(array('device_name'=>M('re_setmeter_config')->getFieldById($value['gas_type'],'sign')))->order('create_time desc')->find();                $electricity_meter_data = M('re_setmeter')->where($map)->where(array('device_name'=>M('re_setmeter_config')->getFieldById($value['electric_type'],'sign')))->order('create_time desc')->find();                //水费单价                $waterUnitPrice = _filterPriceType($water_meter_data['device_name'],$value['village_id']);                //电费单价                $electUnitPrice = _filterPriceType($electricity_meter_data['device_name'],$value['village_id']);                //燃气费单价                $gasUnitPrice = _filterPriceType($gas_meter_data['device_name'],$value['village_id']);                //vd($waterUnitPrice);                $water_mater_price = !empty($water_meter_data)?$water_meter_data['consume']*$waterUnitPrice:0;                $gas_mater_price = !empty($gas_meter_data)?$gas_meter_data['consume']*$gasUnitPrice:0;                $electricity_mater_price = !empty($electricity_meter_data)?$electricity_meter_data['consume']*$electUnitPrice:0;                //小区信息                //$park_price = round($village_info['park_price'],2);                $property_price = round($value['housesize']*$village_info['property_price'],2);                //制作插入数组                $add_array = array(                    'village_id'=>$this->village_id,                    'usernum'=>$value['usernum'],                    'name'=>$value['name'],                    'phone'=>$value['phone'],                    'address'=>$value['address']?:'',                    'bind_id'=>$value['pigcms_id'],                    'ydate'=>date('Y'),                    'mdate'=>date('m'),                    'add_time'=>time(),                    'use_water'=>$water_meter_data['consume']?:0,                    'use_electric'=>$electricity_meter_data['consume']?:0,                    'use_gas'=>$gas_meter_data['consume']?:0,                    'use_park'=>0,                    'use_property'=>1,                    'water_price'=>$water_mater_price,                    'electric_price'=>$electricity_mater_price,                    'gas_price'=>$gas_mater_price,                    'park_price'=>0,                    'property_price'=>$property_price,                );                $res = M('house_village_user_paylist')->data($add_array)->add();                if($res){                    //插入成功                    $err_array[]=array('err'=>0,'name'=>$value['name']);                }else{                    //插入失败                    $err_array[]=array('msg'=>'名字为：'.$value['name'].'录入信息失败，具体原因为：非空字段为空。');                }            }        }        foreach ($err_array as $key => $value){            if($value['name']==''){                unset($err_array[$key]);            }        }        $this->assign('err_array',$err_array);        $this->display('upload_state');    }    /**     * 账单单个保存     * @author 祝君伟     * @time 2017年8月16日10:25:33     */    public function ajax_complete_order(){        //准备入表数据        //查询当前的小区单价信息        $village_info = M('house_village')->find($this->village_id);        //查询当前业主的信息        $usernum = I('post.usernum');        $user_bind_info = M('house_village_user_bind')->where(array('usernum'=>$usernum))->find();        //准备金额数据        $order_price = I('post.string');        $is_property = I('post.is_property');        $is_park = I('post.is_park');        $order_array = explode("\n",$order_price);        $water_price = mb_substr(explode("：",$order_array[0])[1],1);        $electric_price = mb_substr(explode("：",$order_array[1])[1],1);        $gas_price = mb_substr(explode("：",$order_array[2])[1],1);        $property_price = empty($is_property)?0:round($user_bind_info['housesize']*$village_info['property_price'],2);        $park_price = empty($is_park)?0:round($village_info['park_price'],2);        //制作账单表结构对应数组        $add_array = array(            'village_id'=>$this->village_id,            'usernum'=>$usernum,            'name'=>$user_bind_info['name'],            'phone'=>$user_bind_info['phone'],            'address'=>$user_bind_info['address']?:'',            'bind_id'=>$user_bind_info['pigcms_id'],            'ydate'=>date('Y'),            'mdate'=>date('m'),            'add_time'=>time(),            'use_water'=>round($water_price/$village_info['water_price'],2),            'use_electric'=>round($electric_price/$village_info['electric_price'],2),            'use_gas'=>round($gas_price/$village_info['gas_price'],2),            'use_park'=>$is_park,            'use_property'=>$is_property,            'water_price'=>$water_price,            'electric_price'=>$electric_price,            'gas_price'=>$gas_price,            'park_price'=>$park_price,            'property_price'=>$property_price,        );        //vd($add_array);        $res = M('house_village_user_paylist')->data($add_array)->add();        if($res){            echo 1;        }else{            echo 2;        }    }   /*    * 绑定微信号    * 祝君伟    * */   public function bind_weixin(){       $id = I('post.id');       if(empty($id)||!isset($id)) exit;       $bind_info = M('house_village_user_bind')->find($id);       $user_id = M('user')->getFieldByPhone($bind_info['phone'],'uid');       if($user_id == null){           echo 2;exit;       }else{           $res = M('house_village_user_bind')->where(array('id'=>$id))->data(array('uid'=>$user_id))->save();           if($res){               echo 1;           }else{               echo 3;           }       }   }	// 缴费明细    public function pay_detail(){    	$village_id = $this->village_id;    	$usernum = $_GET['usernum'];    	    	if($village_id && $usernum){    		$list = D('House_village_user_paylist')->get_limit_list_page($usernum,$village_id);    		$this->assign('user_list',$list);    	}    	    	$this->display();    }    	public function detail_import(){		if(IS_POST){						if(!$_POST['paytime']){				$this->error('请选择时间');exit;			}			$yearArray = explode('年', $_POST['paytime']);			$year = $yearArray[0];			$m =  str_replace('月', '', $yearArray[1]);						unset($_POST['paytime']);			$_POST['ydate'] = $year;			$_POST['mdate'] = intval($m);						if ($_FILES['file']['error'] != 4) {				$upload_dir = './upload/house/excel/paydetail/'.date('Ymd').'/';				if (!is_dir($upload_dir)) {					mkdir($upload_dir, 0777, true);				}				import('ORG.Net.UploadFile');				$upload = new UploadFile();				$upload->maxSize = 10 * 1024 * 1024;				$upload->allowExts = array('xls','xlsx');				$upload->allowTypes = array(); // 允许上传的文件类型 留空不做检查				$upload->savePath = $upload_dir;				$upload->thumb = false;				$upload->thumbType = 0;				$upload->imageClassPath = '';				$upload->thumbPrefix = '';				$upload->saveRule = 'uniqid';				if ($upload->upload()) {					$uploadList = $upload->getUploadFileInfo();					require_once APP_PATH . 'Lib/ORG/phpexcel/PHPExcel/IOFactory.php';					$path = $uploadList['0']['savepath'] . $uploadList['0']['savename'];					$fileType = PHPExcel_IOFactory::identify($path); //文件名自动判断文件类型					$objReader = PHPExcel_IOFactory::createReader($fileType);					$excelObj = $objReader->load($path);					$result = $excelObj->getActiveSheet()->toArray(null, true, true, true);											$old_end_user_id = D('House_village_user_paylist')->field('pigcms_id')->order('pigcms_id DESC')->find();								if (!empty($result) && is_array($result)) {						unset($result[1]);						$last_user_id = 0;												foreach ($result as $kk => $vv){							if(empty($vv['A']) || empty($vv['B']) || empty($vv['C']) || empty($vv['I'])) continue;							$tmpdata = array();							$tmpdata['mdate'] = $_POST['mdate'];							$tmpdata['ydate'] = $_POST['ydate'];							$tmpdata['village_id'] = $this->village_id;							$tmpdata['usernum'] = htmlspecialchars(trim($vv['A']), ENT_QUOTES);							//检测业主是否已经导入							$condition = array('usernum'=>array('eq',$tmpdata['usernum']),'ydate'=>$tmpdata['ydate'],'mdate'=>$tmpdata['mdate']);							$pay_list = D('House_village_user_paylist')->where($condition)->find();							$conditionBind = array('village_id' => $this->village_id,'usernum'=>$tmpdata['usernum']);							$bindInfo = D('House_village_user_bind')->field('`pigcms_id`,`usernum`,`uid`,`housesize`')->where($conditionBind)->find();							//dump(M()->_sql());exit;							if($pay_list || !$bindInfo){								continue;							}							$tmpdata['name'] = htmlspecialchars(trim($vv['B']), ENT_QUOTES);							$tmpdata['phone'] = htmlspecialchars(trim($vv['C']), ENT_QUOTES);							$tmpdata['use_water'] = floatval(htmlspecialchars(trim($vv['D']), ENT_QUOTES));							$tmpdata['use_electric'] = floatval(htmlspecialchars(trim($vv['E']), ENT_QUOTES));							$tmpdata['use_gas'] = floatval(htmlspecialchars(trim($vv['F']), ENT_QUOTES));							$tmpdata['use_property'] = intval(htmlspecialchars(trim($vv['G']), ENT_QUOTES));							$tmpdata['use_park'] = intval(htmlspecialchars(trim($vv['H']), ENT_QUOTES));							$tmpdata['address'] = htmlspecialchars(trim($vv['I']), ENT_QUOTES);							$tmpdata['bind_id'] = $bindInfo['pigcms_id'];							$tmpdata['uid'] = $bindInfo['uid'];							$tmpdata['add_time'] = $_SERVER['REQUEST_TIME'];														if($tmpdata['use_water']){								$tmpdata['water_price'] = $tmpdata['use_water']*$this->village['water_price'];								//D('House_village_user_bind')->where($conditionBind)->setInc('water_price',$tmpdata['water_price']);							}							if($tmpdata['use_electric']){								$tmpdata['electric_price'] = $tmpdata['use_electric']*$this->village['electric_price'];								//D('House_village_user_bind')->where($conditionBind)->setInc('electric_price',$tmpdata['electric_price']);							}							if($tmpdata['use_gas']){								$tmpdata['gas_price'] = $tmpdata['use_gas']*$this->village['gas_price'];								//D('House_village_user_bind')->where($conditionBind)->setInc('gas_price',$tmpdata['gas_price']);							}							if($tmpdata['use_property']){								//$tmpdata['property_price'] = $tmpdata['use_property'];								$tmpdata['property_price'] = $this->village['property_price']*$bindInfo['housesize'];								//D('House_village_user_bind')->where($conditionBind)->setInc('property_price',$tmpdata['property_price']);							}							if($tmpdata['use_park']){								$tmpdata['park_price'] = $this->village['park_price'];								//D('House_village_user_bind')->where($conditionBind)->setInc('park_price',$this->village['park_price']);							}                            //dump($tmpdata);							$last_user_id = D('House_village_user_paylist')->data($tmpdata)->add();						}						if(!empty($last_user_id)){							// 模板消息							$this->send($old_end_user_id['pigcms_id'],$last_user_id); 													}else{							$this->error('导入失败');exit;						}					}				} else {					$this->error($upload->getErrorMsg());exit;				}			}			$this->error('文件上传失败');exit;		}else{			$this->display();		}    }        public function orders(){    	$uid = $_GET['uid'];    	if($uid){    		$condtion['uid'] = $uid;    		$condtion['village_id'] = $this->village_id;    		$condtion['paid'] = 1;    		    		import('@.ORG.system_page');    		$count_order = D('House_village_pay_order')->where($condtion)->count();    		$p = new Page($count_order,20,'page');    		$order_list = D('House_village_pay_order')->table($condition_table)->where($condtion)->order('time desc')->limit($p->firstRow.','.$p->listRows)->select();    		    		$result['order_list'] = $order_list;    		$result['pagebar'] = $p->show();    		$this->assign('order_list',$result);    		    	}    	$this->display();    }        public function village_order(){    	$village_id = $this->village_id;    	if($village_id){    		$condition['village_id'] = $this->village_id;    		$condition['paid'] = 1;    		    		$result = D('House_village_pay_order')->get_limit_list_page($condition);    		$this->assign('order_list',$result);    	}    	    	$this->display();    }        public function change(){    	$village_id = $this->village_id;    	$strids = isset($_POST['strids']) ? htmlspecialchars($_POST['strids']) : '';    	if ($strids) {    		$array = explode(',', $strids);    		$usernums = $orderids = array();    		foreach ($array as $val) {    			$t = explode('_', $val);    			if ($t[1]) {    				$orderids[] = $t[1];    			}    		}    		    		$orderids && D('House_village_pay_order')->where(array('village_id' => $village_id, 'order_id' => array('in', $orderids)))->save(array('is_pay_bill' => 1));    	}    	exit(json_encode(array('error_code' => 0)));    }        public function send($old_end_user_id,$last_user_id){    		$users = D('House_village_user_bind')->get_pay_list_open($this->village_id,20,$last_user_id,$old_end_user_id);    	    		if($users){    			$page = $_GET['page']?intval($_GET['page']):1;    			     			if($page > $users['totalPage']){    				$this->success('导入成功！');exit;    			}else{    				// 模板消息    				foreach ($users['user_list'] as $userInfo){    					$href = C('config.site_url').'/wap.php?g=Wap&c=House&a=village_my_pay&village_id='.$this->village_id;    						    					$model = new templateNews(C('config.wechat_appid'), C('config.wechat_appsecret'));    					$model->sendTempMsg('TM01008', array('href' => $href, 'wecha_id' => $userInfo['openid'], 'first' => '您好，社区发布了一条账单信息\n', 'keynote2' => $userInfo['address'], 'keynote1' => $this->village['property_name'], 'remark' => '\n请点击查看详细信息！'));    				}    				     				$this->success('发送微信消息完毕，正在跳转下一页',U('User/detail_import',array('page'=>$page+1)));exit;    			}    		}else{    			$this->success('导入成功。');exit;    		}    }}