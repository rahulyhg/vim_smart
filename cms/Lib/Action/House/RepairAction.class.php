<?php/* * 社区首页 * */class RepairAction extends BaseAction{	protected $village_id;	protected $village;	public function _initialize(){		parent::_initialize();			$this->village_id = $this->house_session['village_id'];		$this->village = D('House_village')->where(array('village_id'=>$this->village_id))->find();		if(empty($this->village)){			$this->error('该小区不存在！');		}	}	    public function index(){		$village_id = $this->village_id;		if($village_id){			$repair_list = D('House_village_repair_list')->getlist(array('village_id'=>$village_id,'type'=>1));			$this->assign('repair_list',$repair_list);		}		$this->display();    }	    //水电煤上报列表    public function water(){        $model = M('re_setmeter','pigcms_');        $village_id = $this->village_id;        $map = array();        $map['ub.village_id'] = array('eq',$village_id);        $field = array(            'meter.*',            'a.realname',            'ub.name',            'ub.company',            'ub.address',            'ub.phone',        );        $count = $model->alias('meter')            ->where($map)            ->join('left join __ADMIN__ a on a.id=meter.admin_id')            ->join('left join __HOUSE_VILLAGE_USER_BIND__ ub on ub.usernum = meter.usernum')            ->count();        //加载分页类        import('@.ORG.merchant_page');        $page =  new Page($count,10,'page');        $list = $model->alias('meter')            ->field($field)            ->where($map)            ->join('left join __ADMIN__ a on a.id=meter.admin_id')            ->join('left join __HOUSE_VILLAGE_USER_BIND__ ub on ub.usernum = meter.usernum')            ->limit($page->firstRow,$page->listRows)            ->order('create_time desc')            ->select();        $this->assign('list',$list);        $this->assign('pagebar',$page->show());        $this->display();    }        public function suggess(){    	$village_id = $this->village_id;    	if($village_id){    		$repair_list = D('House_village_repair_list')->getlist(array('village_id'=>$village_id,'type'=>3));    		$this->assign('repair_list',$repair_list);    	}    	$this->display();    }        public function do_repair(){    	if(IS_AJAX){    		$village_id = $this->village_id;    		$bind_id = $_POST['bind_id']?intval($_POST['bind_id']):0;    		$cms_id = $_POST['cid']?intval($_POST['cid']):0;    		if($bind_id && $village_id){    			$data['village_id'] = $this->village_id;    			$data['bind_id'] = $bind_id;    			$data['pigcms_id'] = $cms_id;    			$result = D('House_village_repair_list')->where($data)->data(array('is_read'=>1))->save();    			if($result !== false){    				$this->ajaxReturn(array('error'=>0));    			}    			$this->ajaxReturn(array('msg'=>'处理失败请重试','error'=>1));    		}else{    			$this->ajaxReturn(array('msg'=>'信息有误','error'=>1));    		}    		exit;    	}else{    		$this->display();    	}    }        public function info(){    	$bind_id = $_GET['bindid']?intval($_GET['bindid']):0;    	$cms_id = $_GET['pid']?intval($_GET['pid']):0;    	$village_id = $this->village_id;    	    	if($bind_id && $cms_id){    		$condition['bind_id'] = $bind_id;    		$condition['pigcms_id'] = $cms_id;    		$condition['village_id'] = $village_id;   		    		$repair = D('House_village_repair_list')->getlist($condition,1);    		$this->assign('repair',$repair['repair_list'][0]);    	}    	    	$this->display();    }}